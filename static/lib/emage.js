(function(factory){if(typeof define!=="undefined"&&define["amd"]){define(["exports"],factory.bind(window))}else{factory(window["image"]={})}})(function(_exports){var requirejs,require,define;(function(undef){var main,req,makeMap,handlers,defined={},waiting={},config={},defining={},hasOwn=Object.prototype.hasOwnProperty,aps=[].slice;function hasProp(obj,prop){return hasOwn.call(obj,prop)}function normalize(name,baseName){var nameParts,nameSegment,mapValue,foundMap,foundI,foundStarMap,starI,i,j,part,baseParts=baseName&&baseName.split("/"),map=config.map,starMap=map&&map["*"]||{};if(name&&name.charAt(0)==="."){if(baseName){baseParts=baseParts.slice(0,baseParts.length-1);name=baseParts.concat(name.split("/"));for(i=0;i<name.length;i+=1){part=name[i];if(part==="."){name.splice(i,1);i-=1}else if(part===".."){if(i===1&&(name[2]===".."||name[0]==="..")){break}else if(i>0){name.splice(i-1,2);i-=2}}}name=name.join("/")}else if(name.indexOf("./")===0){name=name.substring(2)}}if((baseParts||starMap)&&map){nameParts=name.split("/");for(i=nameParts.length;i>0;i-=1){nameSegment=nameParts.slice(0,i).join("/");if(baseParts){for(j=baseParts.length;j>0;j-=1){mapValue=map[baseParts.slice(0,j).join("/")];if(mapValue){mapValue=mapValue[nameSegment];if(mapValue){foundMap=mapValue;foundI=i;break}}}}if(foundMap){break}if(!foundStarMap&&starMap&&starMap[nameSegment]){foundStarMap=starMap[nameSegment];starI=i}}if(!foundMap&&foundStarMap){foundMap=foundStarMap;foundI=starI}if(foundMap){nameParts.splice(0,foundI,foundMap);name=nameParts.join("/")}}return name}function makeRequire(relName,forceSync){return function(){return req.apply(undef,aps.call(arguments,0).concat([relName,forceSync]))}}function makeNormalize(relName){return function(name){return normalize(name,relName)}}function makeLoad(depName){return function(value){defined[depName]=value}}function callDep(name){if(hasProp(waiting,name)){var args=waiting[name];delete waiting[name];defining[name]=true;main.apply(undef,args)}if(!hasProp(defined,name)&&!hasProp(defining,name)){throw new Error("No "+name)}return defined[name]}function splitPrefix(name){var prefix,index=name?name.indexOf("!"):-1;if(index>-1){prefix=name.substring(0,index);name=name.substring(index+1,name.length)}return[prefix,name]}makeMap=function(name,relName){var plugin,parts=splitPrefix(name),prefix=parts[0];name=parts[1];if(prefix){prefix=normalize(prefix,relName);plugin=callDep(prefix)}if(prefix){if(plugin&&plugin.normalize){name=plugin.normalize(name,makeNormalize(relName))}else{name=normalize(name,relName)}}else{name=normalize(name,relName);parts=splitPrefix(name);prefix=parts[0];name=parts[1];if(prefix){plugin=callDep(prefix)}}return{f:prefix?prefix+"!"+name:name,n:name,pr:prefix,p:plugin}};function makeConfig(name){return function(){return config&&config.config&&config.config[name]||{}}}handlers={require:function(name){return makeRequire(name)},exports:function(name){var e=defined[name];if(typeof e!=="undefined"){return e}else{return defined[name]={}}},module:function(name){return{id:name,uri:"",exports:defined[name],config:makeConfig(name)}}};main=function(name,deps,callback,relName){var cjsModule,depName,ret,map,i,args=[],usingExports;relName=relName||name;if(typeof callback==="function"){deps=!deps.length&&callback.length?["require","exports","module"]:deps;for(i=0;i<deps.length;i+=1){map=makeMap(deps[i],relName);depName=map.f;if(depName==="require"){args[i]=handlers.require(name)}else if(depName==="exports"){args[i]=handlers.exports(name);usingExports=true}else if(depName==="module"){cjsModule=args[i]=handlers.module(name)}else if(hasProp(defined,depName)||hasProp(waiting,depName)||hasProp(defining,depName)){args[i]=callDep(depName)}else if(map.p){map.p.load(map.n,makeRequire(relName,true),makeLoad(depName),{});args[i]=defined[depName]}else{throw new Error(name+" missing "+depName)}}ret=callback.apply(defined[name],args);if(name){if(cjsModule&&cjsModule.exports!==undef&&cjsModule.exports!==defined[name]){defined[name]=cjsModule.exports}else if(ret!==undef||!usingExports){defined[name]=ret}}}else if(name){defined[name]=callback}};requirejs=require=req=function(deps,callback,relName,forceSync,alt){if(typeof deps==="string"){if(handlers[deps]){return handlers[deps](callback)}return callDep(makeMap(deps,callback).f)}else if(!deps.splice){config=deps;if(callback.splice){deps=callback;callback=relName;relName=null}else{deps=undef}}callback=callback||function(){};if(typeof relName==="function"){relName=forceSync;forceSync=alt}if(forceSync){main(undef,deps,callback,relName)}else{setTimeout(function(){main(undef,deps,callback,relName)},4)}return req};req.config=function(cfg){config=cfg;if(config.deps){req(config.deps,config.callback)}return req};define=function(name,deps,callback){if(!deps.splice){callback=deps;deps=[]}if(!hasProp(defined,name)&&!hasProp(waiting,name)){waiting[name]=[name,deps,callback]}};define.amd={jQuery:true}})();define("build/almond",function(){});(function(factory){if(typeof define!=="undefined"&&define["amd"]){define("qtek",["exports"],factory.bind(window))}else{factory(window["qtek"]={})}})(function(_exports){var requirejs,require,define;(function(undef){var main,req,makeMap,handlers,defined={},waiting={},config={},defining={},hasOwn=Object.prototype.hasOwnProperty,aps=[].slice;function hasProp(obj,prop){return hasOwn.call(obj,prop)}function normalize(name,baseName){var nameParts,nameSegment,mapValue,foundMap,foundI,foundStarMap,starI,i,j,part,baseParts=baseName&&baseName.split("/"),map=config.map,starMap=map&&map["*"]||{};if(name&&name.charAt(0)==="."){if(baseName){baseParts=baseParts.slice(0,baseParts.length-1);name=baseParts.concat(name.split("/"));for(i=0;i<name.length;i+=1){part=name[i];if(part==="."){name.splice(i,1);i-=1}else if(part===".."){if(i===1&&(name[2]===".."||name[0]==="..")){break}else if(i>0){name.splice(i-1,2);i-=2}}}name=name.join("/")}else if(name.indexOf("./")===0){name=name.substring(2)}}if((baseParts||starMap)&&map){nameParts=name.split("/");for(i=nameParts.length;i>0;i-=1){nameSegment=nameParts.slice(0,i).join("/");if(baseParts){for(j=baseParts.length;j>0;j-=1){mapValue=map[baseParts.slice(0,j).join("/")];if(mapValue){mapValue=mapValue[nameSegment];if(mapValue){foundMap=mapValue;foundI=i;break}}}}if(foundMap){break}if(!foundStarMap&&starMap&&starMap[nameSegment]){foundStarMap=starMap[nameSegment];starI=i}}if(!foundMap&&foundStarMap){foundMap=foundStarMap;foundI=starI}if(foundMap){nameParts.splice(0,foundI,foundMap);name=nameParts.join("/")}}return name}function makeRequire(relName,forceSync){return function(){return req.apply(undef,aps.call(arguments,0).concat([relName,forceSync]))}}function makeNormalize(relName){return function(name){return normalize(name,relName)}}function makeLoad(depName){return function(value){defined[depName]=value}}function callDep(name){if(hasProp(waiting,name)){var args=waiting[name];delete waiting[name];defining[name]=true;main.apply(undef,args)}if(!hasProp(defined,name)&&!hasProp(defining,name)){throw new Error("No "+name)}return defined[name]}function splitPrefix(name){var prefix,index=name?name.indexOf("!"):-1;if(index>-1){prefix=name.substring(0,index);name=name.substring(index+1,name.length)}return[prefix,name]}makeMap=function(name,relName){var plugin,parts=splitPrefix(name),prefix=parts[0];name=parts[1];if(prefix){prefix=normalize(prefix,relName);plugin=callDep(prefix)}if(prefix){if(plugin&&plugin.normalize){name=plugin.normalize(name,makeNormalize(relName))}else{name=normalize(name,relName)}}else{name=normalize(name,relName);parts=splitPrefix(name);prefix=parts[0];name=parts[1];if(prefix){plugin=callDep(prefix)}}return{f:prefix?prefix+"!"+name:name,n:name,pr:prefix,p:plugin}};function makeConfig(name){return function(){return config&&config.config&&config.config[name]||{}}}handlers={require:function(name){return makeRequire(name)},exports:function(name){var e=defined[name];if(typeof e!=="undefined"){return e}else{return defined[name]={}}},module:function(name){return{id:name,uri:"",exports:defined[name],config:makeConfig(name)}}};main=function(name,deps,callback,relName){var cjsModule,depName,ret,map,i,args=[],usingExports;relName=relName||name;if(typeof callback==="function"){deps=!deps.length&&callback.length?["require","exports","module"]:deps;for(i=0;i<deps.length;i+=1){map=makeMap(deps[i],relName);depName=map.f;if(depName==="require"){args[i]=handlers.require(name)}else if(depName==="exports"){args[i]=handlers.exports(name);usingExports=true}else if(depName==="module"){cjsModule=args[i]=handlers.module(name)}else if(hasProp(defined,depName)||hasProp(waiting,depName)||hasProp(defining,depName)){args[i]=callDep(depName)}else if(map.p){map.p.load(map.n,makeRequire(relName,true),makeLoad(depName),{});args[i]=defined[depName]}else{throw new Error(name+" missing "+depName)}}ret=callback.apply(defined[name],args);if(name){if(cjsModule&&cjsModule.exports!==undef&&cjsModule.exports!==defined[name]){defined[name]=cjsModule.exports}else if(ret!==undef||!usingExports){defined[name]=ret}}}else if(name){defined[name]=callback}};requirejs=require=req=function(deps,callback,relName,forceSync,alt){if(typeof deps==="string"){if(handlers[deps]){return handlers[deps](callback)}return callDep(makeMap(deps,callback).f)}else if(!deps.splice){config=deps;if(callback.splice){deps=callback;callback=relName;relName=null}else{deps=undef}}callback=callback||function(){};if(typeof relName==="function"){relName=forceSync;forceSync=alt}if(forceSync){main(undef,deps,callback,relName)}else{setTimeout(function(){main(undef,deps,callback,relName)},4)}return req};req.config=function(cfg){config=cfg;if(config.deps){req(config.deps,config.callback)}return req};define=function(name,deps,callback){if(!deps.splice){callback=deps;deps=[]}if(!hasProp(defined,name)&&!hasProp(waiting,name)){waiting[name]=[name,deps,callback]}};define.amd={jQuery:true}})();define("../build/almond",function(){});define("2d/camera",function(){});define("core/mixin/derive",[],function(){function derive(makeDefaultOpt,initialize,proto){if(typeof initialize=="object"){proto=initialize;initialize=null}var extendedProto={"instanceof":function(constructor){var selfConstructor=sub;while(selfConstructor){if(selfConstructor===constructor){return true}selfConstructor=selfConstructor.__super__}}};var _super=this;var sub=function(options){_super.call(this);_.extend(this,typeof makeDefaultOpt=="function"?makeDefaultOpt.call(this):makeDefaultOpt);_.extend(this,options);if(this.constructor==sub){var base=sub,initializeChain=[initialize];while(base.__super__){base=base.__super__;initializeChain.unshift(base.__initialize__)}for(var i=0;i<initializeChain.length;i++){if(initializeChain[i]){initializeChain[i].call(this)}}}};sub.__super__=_super;sub.__initialize__=initialize;_.extend(sub.prototype,_super.prototype,extendedProto,proto);sub.prototype.constructor=sub;sub.derive=_super.derive;return sub}return{derive:derive}});define("core/mixin/notifier",[],function(){return{trigger:function(){if(!this.__handlers__){return}var name=arguments[0];var params=Array.prototype.slice.call(arguments,1);var handlers=this.__handlers__[name];if(handlers){for(var i=0;i<handlers.length;i+=2){var handler=handlers[i],context=handlers[i+1];handler.apply(context||this,params)}}},on:function(target,handler,context){if(!target){return}var handlers=this.__handlers__||(this.__handlers__={});if(!handlers[target]){handlers[target]=[]}if(handlers[target].indexOf(handler)==-1){handlers[target].push(handler);handlers[target].push(context)}return handler},off:function(target,handler){var handlers=this.__handlers__||(this.__handlers__={});if(handlers[target]){if(handler){var arr=handlers[target];var idx=arr.indexOf(handler);if(idx>=0)arr.splice(idx,2)}else{handlers[target]=[]}}},has:function(target,handler){if(!this.__handlers__||!this.__handlers__[target]){return false}if(!handler){return this.__handlers__[target].length}else{return this.__handlers__[target].indexOf(handler)!==-1}}}});define("core/mixin/dirty",{dirty:function(propName){if(!this._dirtyFlag){this._dirtyFlag={}}this._dirtyFlag[propName]=true},fresh:function(propName){if(!this._dirtyFlag){this._dirtyFlag={}}this._dirtyFlag[propName]=false},isDirty:function(propName){if(!this._dirtyFlag){this._dirtyFlag={}}if(typeof this._dirtyFlag[propName]==="undefined"){return true}return this._dirtyFlag[propName]}});define("core/cache",[],function(){var Cache=function(){this._contextId="",this._caches={},this._context={}};Cache.prototype={use:function(contextId,documentSchema){if(!this._caches.hasOwnProperty(contextId)){this._caches[contextId]={};if(documentSchema){for(var name in documentSchema){this._caches[contextId][name]=documentSchema[name]}}}this._contextId=contextId;this._context=this._caches[contextId]},put:function(key,value){this._context[key]=value},get:function(key){return this._context[key]},clearContext:function(){this._caches[this._contextId]={};this._context={}},"delete":function(key){delete this._context[key]},clearAll:function(){this._caches={}},getContext:function(){return this._context},miss:function(key){return!this._context.hasOwnProperty(key)}};Cache.prototype.constructor=Cache;return Cache});(function(window){var undefined;var freeExports=typeof exports=="object"&&exports;var freeModule=typeof module=="object"&&module&&module.exports==freeExports&&module;var freeGlobal=typeof global=="object"&&global;if(freeGlobal.global===freeGlobal){window=freeGlobal}var idCounter=0;var indicatorObject={};var reEmptyStringLeading=/\b__p \+= '';/g,reEmptyStringMiddle=/\b(__p \+=) '' \+/g,reEmptyStringTrailing=/(__e\(.*?\)|\b__t\)) \+\n'';/g;var reEscapedHtml=/&(?:amp|lt|gt|quot|#39);/g;var reEsTemplate=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g;var reFlags=/\w*$/;var reInterpolate=/<%=([\s\S]+?)%>/g;var reLeadingZeros=/^0+(?=.$)/;var reNoMatch=/($^)/;var reUnescapedHtml=/[&<>"']/g;var reUnescapedString=/['\n\r\t\u2028\u2029\\]/g;var contextProps=["Array","Boolean","Date","Function","Math","Number","Object","RegExp","String","_","attachEvent","clearTimeout","isFinite","isNaN","parseInt","setImmediate","setTimeout"];var shadowedProps=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"];var templateCounter=0;var argsClass="[object Arguments]",arrayClass="[object Array]",boolClass="[object Boolean]",dateClass="[object Date]",funcClass="[object Function]",numberClass="[object Number]",objectClass="[object Object]",regexpClass="[object RegExp]",stringClass="[object String]";var cloneableClasses={};cloneableClasses[funcClass]=false;cloneableClasses[argsClass]=cloneableClasses[arrayClass]=cloneableClasses[boolClass]=cloneableClasses[dateClass]=cloneableClasses[numberClass]=cloneableClasses[objectClass]=cloneableClasses[regexpClass]=cloneableClasses[stringClass]=true;var objectTypes={"boolean":false,"function":true,object:true,number:false,string:false,undefined:false};var stringEscapes={"\\":"\\","'":"'","\n":"n","\r":"r","	":"t","\u2028":"u2028","\u2029":"u2029"};function runInContext(context){context=context?_.defaults(window.Object(),context,_.pick(window,contextProps)):window;var Array=context.Array,Boolean=context.Boolean,Date=context.Date,Function=context.Function,Math=context.Math,Number=context.Number,Object=context.Object,RegExp=context.RegExp,String=context.String,TypeError=context.TypeError;var arrayRef=Array(),objectRef=Object();var oldDash=context._;var reNative=RegExp("^"+String(objectRef.valueOf).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$");var ceil=Math.ceil,clearTimeout=context.clearTimeout,concat=arrayRef.concat,floor=Math.floor,getPrototypeOf=reNative.test(getPrototypeOf=Object.getPrototypeOf)&&getPrototypeOf,hasOwnProperty=objectRef.hasOwnProperty,push=arrayRef.push,setImmediate=context.setImmediate,setTimeout=context.setTimeout,toString=objectRef.toString;var nativeBind=reNative.test(nativeBind=slice.bind)&&nativeBind,nativeIsArray=reNative.test(nativeIsArray=Array.isArray)&&nativeIsArray,nativeIsFinite=context.isFinite,nativeIsNaN=context.isNaN,nativeKeys=reNative.test(nativeKeys=Object.keys)&&nativeKeys,nativeMax=Math.max,nativeMin=Math.min,nativeParseInt=context.parseInt,nativeRandom=Math.random;var isIeOpera=reNative.test(context.attachEvent),isV8=nativeBind&&!/\n|true/.test(nativeBind+isIeOpera);var ctorByClass={};ctorByClass[arrayClass]=Array;ctorByClass[boolClass]=Boolean;ctorByClass[dateClass]=Date;ctorByClass[objectClass]=Object;ctorByClass[numberClass]=Number;ctorByClass[regexpClass]=RegExp;ctorByClass[stringClass]=String;function lodash(value){return value&&typeof value=="object"&&!isArray(value)&&hasOwnProperty.call(value,"__wrapped__")?value:new lodashWrapper(value)}var support=lodash.support={};(function(){var ctor=function(){this.x=1},object={0:1,length:1},props=[];ctor.prototype={valueOf:1,y:1};for(var prop in new ctor){props.push(prop)}for(prop in arguments){}support.argsObject=arguments.constructor==Object;support.argsClass=isArguments(arguments);support.enumPrototypes=ctor.propertyIsEnumerable("prototype");support.fastBind=nativeBind&&!isV8;support.ownLast=props[0]!="x";support.nonEnumArgs=prop!=0;support.nonEnumShadows=!/valueOf/.test(props);support.spliceObjects=(arrayRef.splice.call(object,0,1),!object[0]);support.unindexedChars="x"[0]+Object("x")[0]!="xx";try{support.nodeClass=!(toString.call(document)==objectClass&&!({toString:0}+""))}catch(e){support.nodeClass=true}})(1);lodash.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:reInterpolate,variable:"",imports:{_:lodash}};var iteratorTemplate=function(obj){var __p="var index, iterable = "+obj.firstArg+", result = "+obj.init+";\nif (!iterable) return result;\n"+obj.top+";\n";if(obj.arrays){__p+="var length = iterable.length; index = -1;\nif ("+obj.arrays+") {  ";if(support.unindexedChars){__p+="\n  if (isString(iterable)) {\n    iterable = iterable.split('')\n  }  "}__p+="\n  while (++index < length) {\n    "+obj.loop+"\n  }\n}\nelse {  "}else if(support.nonEnumArgs){__p+="\n  var length = iterable.length; index = -1;\n  if (length && isArguments(iterable)) {\n    while (++index < length) {\n      index += '';\n      "+obj.loop+"\n    }\n  } else {  "}if(support.enumPrototypes){__p+="\n  var skipProto = typeof iterable == 'function';\n  "}if(obj.useHas&&obj.useKeys){__p+="\n  var ownIndex = -1,\n      ownProps = objectTypes[typeof iterable] ? keys(iterable) : [],\n      length = ownProps.length;\n\n  while (++ownIndex < length) {\n    index = ownProps[ownIndex];\n    ";if(support.enumPrototypes){__p+="if (!(skipProto && index == 'prototype')) {\n  "}__p+=obj.loop;if(support.enumPrototypes){__p+="}\n"}__p+="  }  "}else{__p+="\n  for (index in iterable) {";if(support.enumPrototypes||obj.useHas){__p+="\n    if (";if(support.enumPrototypes){__p+="!(skipProto && index == 'prototype')"}if(support.enumPrototypes&&obj.useHas){__p+=" && "}if(obj.useHas){__p+="hasOwnProperty.call(iterable, index)"}__p+=") {    "}__p+=obj.loop+";    ";if(support.enumPrototypes||obj.useHas){__p+="\n    }"}__p+="\n  }    ";if(support.nonEnumShadows){__p+="\n\n  var ctor = iterable.constructor;\n      ";for(var k=0;k<7;k++){__p+="\n  index = '"+obj.shadowedProps[k]+"';\n  if (";if(obj.shadowedProps[k]=="constructor"){__p+="!(ctor && ctor.prototype === iterable) && "}__p+="hasOwnProperty.call(iterable, index)) {\n    "+obj.loop+"\n  }      "}}}if(obj.arrays||support.nonEnumArgs){__p+="\n}"}__p+=obj.bottom+";\nreturn result";return __p};var defaultsIteratorOptions={args:"object, source, guard",top:"var args = arguments,\n"+"    argsIndex = 0,\n"+"    argsLength = typeof guard == 'number' ? 2 : args.length;\n"+"while (++argsIndex < argsLength) {\n"+"  iterable = args[argsIndex];\n"+"  if (iterable && objectTypes[typeof iterable]) {",loop:"if (typeof result[index] == 'undefined') result[index] = iterable[index]",bottom:"  }\n}"};var eachIteratorOptions={args:"collection, callback, thisArg",top:"callback = callback && typeof thisArg == 'undefined' ? callback : lodash.createCallback(callback, thisArg)",arrays:"typeof length == 'number'",loop:"if (callback(iterable[index], index, collection) === false) return result"};var forOwnIteratorOptions={top:"if (!objectTypes[typeof iterable]) return result;\n"+eachIteratorOptions.top,arrays:false};function cachedContains(array,fromIndex,largeSize){var length=array.length,isLarge=length-fromIndex>=largeSize;if(isLarge){var cache={},index=fromIndex-1;while(++index<length){var key=String(array[index]);(hasOwnProperty.call(cache,key)?cache[key]:cache[key]=[]).push(array[index])}}return function(value){if(isLarge){var key=String(value);return hasOwnProperty.call(cache,key)&&indexOf(cache[key],value)>-1}return indexOf(array,value,fromIndex)>-1}}function charAtCallback(value){return value.charCodeAt(0)}function compareAscending(a,b){var ai=a.index,bi=b.index;a=a.criteria;b=b.criteria;if(a!==b){if(a>b||typeof a=="undefined"){return 1}if(a<b||typeof b=="undefined"){return-1}}return ai<bi?-1:1}function createBound(func,thisArg,partialArgs,indicator){var isFunc=isFunction(func),isPartial=!partialArgs,key=thisArg;if(isPartial){var rightIndicator=indicator;partialArgs=thisArg}else if(!isFunc){if(!indicator){throw new TypeError}thisArg=func}function bound(){var args=arguments,thisBinding=isPartial?this:thisArg;if(!isFunc){func=thisArg[key]}if(partialArgs.length){args=args.length?(args=slice(args),rightIndicator?args.concat(partialArgs):partialArgs.concat(args)):partialArgs}if(this instanceof bound){noop.prototype=func.prototype;thisBinding=new noop;noop.prototype=null;var result=func.apply(thisBinding,args);return isObject(result)?result:thisBinding}return func.apply(thisBinding,args)}return bound}function createIterator(){var data={shadowedProps:shadowedProps,arrays:"isArray(iterable)",bottom:"",init:"iterable",loop:"",top:"",useHas:true,useKeys:!!keys};for(var object,index=0;object=arguments[index];index++){for(var key in object){data[key]=object[key]}}var args=data.args;data.firstArg=/^[^,]+/.exec(args)[0];var factory=Function("hasOwnProperty, isArguments, isArray, isString, keys, "+"lodash, objectTypes","return function("+args+") {\n"+iteratorTemplate(data)+"\n}");return factory(hasOwnProperty,isArguments,isArray,isString,keys,lodash,objectTypes)}function escapeStringChar(match){return"\\"+stringEscapes[match]}function escapeHtmlChar(match){return htmlEscapes[match]}function isNode(value){return typeof value.toString!="function"&&typeof(value+"")=="string"}function lodashWrapper(value){this.__wrapped__=value}lodashWrapper.prototype=lodash.prototype;function noop(){}function shimIsPlainObject(value){var result=false;if(!(value&&toString.call(value)==objectClass)||!support.argsClass&&isArguments(value)){return result}var ctor=value.constructor;if(isFunction(ctor)?ctor instanceof ctor:support.nodeClass||!isNode(value)){if(support.ownLast){forIn(value,function(value,key,object){result=hasOwnProperty.call(object,key);return false});return result===true}forIn(value,function(value,key){result=key});return result===false||hasOwnProperty.call(value,result)}return result}function slice(array,start,end){start||(start=0);if(typeof end=="undefined"){end=array?array.length:0}var index=-1,length=end-start||0,result=Array(length<0?0:length);while(++index<length){result[index]=array[start+index]}return result}function unescapeHtmlChar(match){return htmlUnescapes[match]}function isArguments(value){return toString.call(value)==argsClass}if(!support.argsClass){isArguments=function(value){return value?hasOwnProperty.call(value,"callee"):false}}var isArray=nativeIsArray||function(value){return support.argsObject&&value instanceof Array||toString.call(value)==arrayClass};var shimKeys=createIterator({args:"object",init:"[]",top:"if (!(objectTypes[typeof object])) return result",loop:"result.push(index)",arrays:false});var keys=!nativeKeys?shimKeys:function(object){if(!isObject(object)){return[]}if(support.enumPrototypes&&typeof object=="function"||support.nonEnumArgs&&object.length&&isArguments(object)){return shimKeys(object)}return nativeKeys(object)};var each=createIterator(eachIteratorOptions);var htmlEscapes={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};var htmlUnescapes=invert(htmlEscapes);var assign=createIterator(defaultsIteratorOptions,{top:defaultsIteratorOptions.top.replace(";",";\n"+"if (argsLength > 3 && typeof args[argsLength - 2] == 'function') {\n"+"  var callback = lodash.createCallback(args[--argsLength - 1], args[argsLength--], 2);\n"+"} else if (argsLength > 2 && typeof args[argsLength - 1] == 'function') {\n"+"  callback = args[--argsLength];\n"+"}"),loop:"result[index] = callback ? callback(result[index], iterable[index]) : iterable[index]"});function clone(value,deep,callback,thisArg,stackA,stackB){var result=value;if(typeof deep=="function"){thisArg=callback;callback=deep;deep=false}if(typeof callback=="function"){callback=typeof thisArg=="undefined"?callback:lodash.createCallback(callback,thisArg,1);result=callback(result);if(typeof result!="undefined"){return result}result=value}var isObj=isObject(result);if(isObj){var className=toString.call(result);if(!cloneableClasses[className]||!support.nodeClass&&isNode(result)){return result}var isArr=isArray(result)}if(!isObj||!deep){return isObj?isArr?slice(result):assign({},result):result}var ctor=ctorByClass[className];switch(className){case boolClass:case dateClass:return new ctor(+result);case numberClass:case stringClass:return new ctor(result);case regexpClass:return ctor(result.source,reFlags.exec(result))}stackA||(stackA=[]);stackB||(stackB=[]);var length=stackA.length;while(length--){if(stackA[length]==value){return stackB[length]}}result=isArr?ctor(result.length):{};if(isArr){if(hasOwnProperty.call(value,"index")){result.index=value.index}if(hasOwnProperty.call(value,"input")){result.input=value.input}}stackA.push(value);stackB.push(result);(isArr?forEach:forOwn)(value,function(objValue,key){result[key]=clone(objValue,deep,callback,undefined,stackA,stackB)});return result}function cloneDeep(value,callback,thisArg){return clone(value,true,callback,thisArg)}var defaults=createIterator(defaultsIteratorOptions);function findKey(collection,callback,thisArg){var result;callback=lodash.createCallback(callback,thisArg);forOwn(collection,function(value,key,collection){if(callback(value,key,collection)){result=key;return false}});return result}var forIn=createIterator(eachIteratorOptions,forOwnIteratorOptions,{useHas:false});var forOwn=createIterator(eachIteratorOptions,forOwnIteratorOptions);function functions(object){var result=[];forIn(object,function(value,key){if(isFunction(value)){result.push(key)}});return result.sort()}function has(object,property){return object?hasOwnProperty.call(object,property):false}function invert(object){var index=-1,props=keys(object),length=props.length,result={};while(++index<length){var key=props[index];result[object[key]]=key}return result}function isBoolean(value){return value===true||value===false||toString.call(value)==boolClass}function isDate(value){return value instanceof Date||toString.call(value)==dateClass}function isElement(value){return value?value.nodeType===1:false}function isEmpty(value){var result=true;if(!value){return result}var className=toString.call(value),length=value.length;if(className==arrayClass||className==stringClass||(support.argsClass?className==argsClass:isArguments(value))||className==objectClass&&typeof length=="number"&&isFunction(value.splice)){return!length}forOwn(value,function(){return result=false});return result}function isEqual(a,b,callback,thisArg,stackA,stackB){var whereIndicator=callback===indicatorObject;if(callback&&!whereIndicator){callback=typeof thisArg=="undefined"?callback:lodash.createCallback(callback,thisArg,2);var result=callback(a,b);if(typeof result!="undefined"){return!!result}}if(a===b){return a!==0||1/a==1/b}var type=typeof a,otherType=typeof b;if(a===a&&(!a||type!="function"&&type!="object")&&(!b||otherType!="function"&&otherType!="object")){return false}if(a==null||b==null){return a===b}var className=toString.call(a),otherClass=toString.call(b);if(className==argsClass){className=objectClass}if(otherClass==argsClass){otherClass=objectClass}if(className!=otherClass){return false}switch(className){case boolClass:case dateClass:return+a==+b;case numberClass:return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case regexpClass:case stringClass:return a==String(b)}var isArr=className==arrayClass;if(!isArr){if(hasOwnProperty.call(a,"__wrapped__ ")||hasOwnProperty.call(b,"__wrapped__")){return isEqual(a.__wrapped__||a,b.__wrapped__||b,callback,thisArg,stackA,stackB)}if(className!=objectClass||!support.nodeClass&&(isNode(a)||isNode(b))){return false}var ctorA=!support.argsObject&&isArguments(a)?Object:a.constructor,ctorB=!support.argsObject&&isArguments(b)?Object:b.constructor;if(ctorA!=ctorB&&!(isFunction(ctorA)&&ctorA instanceof ctorA&&isFunction(ctorB)&&ctorB instanceof ctorB)){return false}}stackA||(stackA=[]);stackB||(stackB=[]);var length=stackA.length;while(length--){if(stackA[length]==a){return stackB[length]==b}}var size=0;result=true;stackA.push(a);stackB.push(b);if(isArr){length=a.length;size=b.length;result=size==a.length;if(!result&&!whereIndicator){return result}while(size--){var index=length,value=b[size];if(whereIndicator){while(index--){if(result=isEqual(a[index],value,callback,thisArg,stackA,stackB)){break}}}else if(!(result=isEqual(a[size],value,callback,thisArg,stackA,stackB))){break}}return result}forIn(b,function(value,key,b){if(hasOwnProperty.call(b,key)){size++;return result=hasOwnProperty.call(a,key)&&isEqual(a[key],value,callback,thisArg,stackA,stackB)}});if(result&&!whereIndicator){forIn(a,function(value,key,a){if(hasOwnProperty.call(a,key)){return result=--size>-1}})}return result}function isFinite(value){return nativeIsFinite(value)&&!nativeIsNaN(parseFloat(value))}function isFunction(value){return typeof value=="function"}if(isFunction(/x/)){isFunction=function(value){return value instanceof Function||toString.call(value)==funcClass}}function isObject(value){return value?objectTypes[typeof value]:false}function isNaN(value){return isNumber(value)&&value!=+value}function isNull(value){return value===null}function isNumber(value){return typeof value=="number"||toString.call(value)==numberClass}var isPlainObject=!getPrototypeOf?shimIsPlainObject:function(value){if(!(value&&toString.call(value)==objectClass)||!support.argsClass&&isArguments(value)){return false}var valueOf=value.valueOf,objProto=typeof valueOf=="function"&&(objProto=getPrototypeOf(valueOf))&&getPrototypeOf(objProto);return objProto?value==objProto||getPrototypeOf(value)==objProto:shimIsPlainObject(value)};function isRegExp(value){return value instanceof RegExp||toString.call(value)==regexpClass}function isString(value){return typeof value=="string"||toString.call(value)==stringClass}function isUndefined(value){return typeof value=="undefined"}function merge(object,source,deepIndicator){var args=arguments,index=0,length=2;if(!isObject(object)){return object}if(deepIndicator===indicatorObject){var callback=args[3],stackA=args[4],stackB=args[5]}else{stackA=[];stackB=[];if(typeof deepIndicator!="number"){length=args.length}if(length>3&&typeof args[length-2]=="function"){callback=lodash.createCallback(args[--length-1],args[length--],2)}else if(length>2&&typeof args[length-1]=="function"){callback=args[--length]}}while(++index<length){(isArray(args[index])?forEach:forOwn)(args[index],function(source,key){var found,isArr,result=source,value=object[key];if(source&&((isArr=isArray(source))||isPlainObject(source))){var stackLength=stackA.length;while(stackLength--){if(found=stackA[stackLength]==source){value=stackB[stackLength];break}}if(!found){value=isArr?isArray(value)?value:[]:isPlainObject(value)?value:{};if(callback){result=callback(value,source);if(typeof result!="undefined"){value=result}}stackA.push(source);stackB.push(value);if(!callback){value=merge(value,source,indicatorObject,callback,stackA,stackB)
}}}else{if(callback){result=callback(value,source);if(typeof result=="undefined"){result=source}}if(typeof result!="undefined"){value=result}}object[key]=value})}return object}function omit(object,callback,thisArg){var isFunc=typeof callback=="function",result={};if(isFunc){callback=lodash.createCallback(callback,thisArg)}else{var props=concat.apply(arrayRef,arguments)}forIn(object,function(value,key,object){if(isFunc?!callback(value,key,object):indexOf(props,key,1)<0){result[key]=value}});return result}function pairs(object){var index=-1,props=keys(object),length=props.length,result=Array(length);while(++index<length){var key=props[index];result[index]=[key,object[key]]}return result}function pick(object,callback,thisArg){var result={};if(typeof callback!="function"){var index=0,props=concat.apply(arrayRef,arguments),length=isObject(object)?props.length:0;while(++index<length){var key=props[index];if(key in object){result[key]=object[key]}}}else{callback=lodash.createCallback(callback,thisArg);forIn(object,function(value,key,object){if(callback(value,key,object)){result[key]=value}})}return result}function values(object){var index=-1,props=keys(object),length=props.length,result=Array(length);while(++index<length){result[index]=object[props[index]]}return result}function at(collection){var index=-1,props=concat.apply(arrayRef,slice(arguments,1)),length=props.length,result=Array(length);if(support.unindexedChars&&isString(collection)){collection=collection.split("")}while(++index<length){result[index]=collection[props[index]]}return result}function contains(collection,target,fromIndex){var index=-1,length=collection?collection.length:0,result=false;fromIndex=(fromIndex<0?nativeMax(0,length+fromIndex):fromIndex)||0;if(typeof length=="number"){result=(isString(collection)?collection.indexOf(target,fromIndex):indexOf(collection,target,fromIndex))>-1}else{each(collection,function(value){if(++index>=fromIndex){return!(result=value===target)}})}return result}function countBy(collection,callback,thisArg){var result={};callback=lodash.createCallback(callback,thisArg);forEach(collection,function(value,key,collection){key=String(callback(value,key,collection));hasOwnProperty.call(result,key)?result[key]++:result[key]=1});return result}function every(collection,callback,thisArg){var result=true;callback=lodash.createCallback(callback,thisArg);if(isArray(collection)){var index=-1,length=collection.length;while(++index<length){if(!(result=!!callback(collection[index],index,collection))){break}}}else{each(collection,function(value,index,collection){return result=!!callback(value,index,collection)})}return result}function filter(collection,callback,thisArg){var result=[];callback=lodash.createCallback(callback,thisArg);if(isArray(collection)){var index=-1,length=collection.length;while(++index<length){var value=collection[index];if(callback(value,index,collection)){result.push(value)}}}else{each(collection,function(value,index,collection){if(callback(value,index,collection)){result.push(value)}})}return result}function find(collection,callback,thisArg){callback=lodash.createCallback(callback,thisArg);if(isArray(collection)){var index=-1,length=collection.length;while(++index<length){var value=collection[index];if(callback(value,index,collection)){return value}}}else{var result;each(collection,function(value,index,collection){if(callback(value,index,collection)){result=value;return false}});return result}}function forEach(collection,callback,thisArg){if(callback&&typeof thisArg=="undefined"&&isArray(collection)){var index=-1,length=collection.length;while(++index<length){if(callback(collection[index],index,collection)===false){break}}}else{each(collection,callback,thisArg)}return collection}function groupBy(collection,callback,thisArg){var result={};callback=lodash.createCallback(callback,thisArg);forEach(collection,function(value,key,collection){key=String(callback(value,key,collection));(hasOwnProperty.call(result,key)?result[key]:result[key]=[]).push(value)});return result}function invoke(collection,methodName){var args=slice(arguments,2),index=-1,isFunc=typeof methodName=="function",length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);forEach(collection,function(value){result[++index]=(isFunc?methodName:value[methodName]).apply(value,args)});return result}function map(collection,callback,thisArg){var index=-1,length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);callback=lodash.createCallback(callback,thisArg);if(isArray(collection)){while(++index<length){result[index]=callback(collection[index],index,collection)}}else{each(collection,function(value,key,collection){result[++index]=callback(value,key,collection)})}return result}function max(collection,callback,thisArg){var computed=-Infinity,result=computed;if(!callback&&isArray(collection)){var index=-1,length=collection.length;while(++index<length){var value=collection[index];if(value>result){result=value}}}else{callback=!callback&&isString(collection)?charAtCallback:lodash.createCallback(callback,thisArg);each(collection,function(value,index,collection){var current=callback(value,index,collection);if(current>computed){computed=current;result=value}})}return result}function min(collection,callback,thisArg){var computed=Infinity,result=computed;if(!callback&&isArray(collection)){var index=-1,length=collection.length;while(++index<length){var value=collection[index];if(value<result){result=value}}}else{callback=!callback&&isString(collection)?charAtCallback:lodash.createCallback(callback,thisArg);each(collection,function(value,index,collection){var current=callback(value,index,collection);if(current<computed){computed=current;result=value}})}return result}var pluck=map;function reduce(collection,callback,accumulator,thisArg){var noaccum=arguments.length<3;callback=lodash.createCallback(callback,thisArg,4);if(isArray(collection)){var index=-1,length=collection.length;if(noaccum){accumulator=collection[++index]}while(++index<length){accumulator=callback(accumulator,collection[index],index,collection)}}else{each(collection,function(value,index,collection){accumulator=noaccum?(noaccum=false,value):callback(accumulator,value,index,collection)})}return accumulator}function reduceRight(collection,callback,accumulator,thisArg){var iterable=collection,length=collection?collection.length:0,noaccum=arguments.length<3;if(typeof length!="number"){var props=keys(collection);length=props.length}else if(support.unindexedChars&&isString(collection)){iterable=collection.split("")}callback=lodash.createCallback(callback,thisArg,4);forEach(collection,function(value,index,collection){index=props?props[--length]:--length;accumulator=noaccum?(noaccum=false,iterable[index]):callback(accumulator,iterable[index],index,collection)});return accumulator}function reject(collection,callback,thisArg){callback=lodash.createCallback(callback,thisArg);return filter(collection,function(value,index,collection){return!callback(value,index,collection)})}function shuffle(collection){var index=-1,length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);forEach(collection,function(value){var rand=floor(nativeRandom()*(++index+1));result[index]=result[rand];result[rand]=value});return result}function size(collection){var length=collection?collection.length:0;return typeof length=="number"?length:keys(collection).length}function some(collection,callback,thisArg){var result;callback=lodash.createCallback(callback,thisArg);if(isArray(collection)){var index=-1,length=collection.length;while(++index<length){if(result=callback(collection[index],index,collection)){break}}}else{each(collection,function(value,index,collection){return!(result=callback(value,index,collection))})}return!!result}function sortBy(collection,callback,thisArg){var index=-1,length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);callback=lodash.createCallback(callback,thisArg);forEach(collection,function(value,key,collection){result[++index]={criteria:callback(value,key,collection),index:index,value:value}});length=result.length;result.sort(compareAscending);while(length--){result[length]=result[length].value}return result}function toArray(collection){if(collection&&typeof collection.length=="number"){return support.unindexedChars&&isString(collection)?collection.split(""):slice(collection)}return values(collection)}var where=filter;function compact(array){var index=-1,length=array?array.length:0,result=[];while(++index<length){var value=array[index];if(value){result.push(value)}}return result}function difference(array){var index=-1,length=array?array.length:0,flattened=concat.apply(arrayRef,arguments),contains=cachedContains(flattened,length,100),result=[];while(++index<length){var value=array[index];if(!contains(value)){result.push(value)}}return result}function findIndex(collection,callback,thisArg){var index=-1,length=collection?collection.length:0;callback=lodash.createCallback(callback,thisArg);while(++index<length){if(callback(collection[index],index,collection)){return index}}return-1}function first(array,callback,thisArg){if(array){var n=0,length=array.length;if(typeof callback!="number"&&callback!=null){var index=-1;callback=lodash.createCallback(callback,thisArg);while(++index<length&&callback(array[index],index,array)){n++}}else{n=callback;if(n==null||thisArg){return array[0]}}return slice(array,0,nativeMin(nativeMax(0,n),length))}}function flatten(array,isShallow,callback,thisArg){var index=-1,length=array?array.length:0,result=[];if(typeof isShallow!="boolean"&&isShallow!=null){thisArg=callback;callback=isShallow;isShallow=false}if(callback!=null){callback=lodash.createCallback(callback,thisArg)}while(++index<length){var value=array[index];if(callback){value=callback(value,index,array)}if(isArray(value)){push.apply(result,isShallow?value:flatten(value))}else{result.push(value)}}return result}function indexOf(array,value,fromIndex){var index=-1,length=array?array.length:0;if(typeof fromIndex=="number"){index=(fromIndex<0?nativeMax(0,length+fromIndex):fromIndex||0)-1}else if(fromIndex){index=sortedIndex(array,value);return array[index]===value?index:-1}while(++index<length){if(array[index]===value){return index}}return-1}function initial(array,callback,thisArg){if(!array){return[]}var n=0,length=array.length;if(typeof callback!="number"&&callback!=null){var index=length;callback=lodash.createCallback(callback,thisArg);while(index--&&callback(array[index],index,array)){n++}}else{n=callback==null||thisArg?1:callback||n}return slice(array,0,nativeMin(nativeMax(0,length-n),length))}function intersection(array){var args=arguments,argsLength=args.length,cache={0:{}},index=-1,length=array?array.length:0,isLarge=length>=100,result=[],seen=result;outer:while(++index<length){var value=array[index];if(isLarge){var key=String(value);var inited=hasOwnProperty.call(cache[0],key)?!(seen=cache[0][key]):seen=cache[0][key]=[]}if(inited||indexOf(seen,value)<0){if(isLarge){seen.push(value)}var argsIndex=argsLength;while(--argsIndex){if(!(cache[argsIndex]||(cache[argsIndex]=cachedContains(args[argsIndex],0,100)))(value)){continue outer}}result.push(value)}}return result}function last(array,callback,thisArg){if(array){var n=0,length=array.length;if(typeof callback!="number"&&callback!=null){var index=length;callback=lodash.createCallback(callback,thisArg);while(index--&&callback(array[index],index,array)){n++}}else{n=callback;if(n==null||thisArg){return array[length-1]}}return slice(array,nativeMax(0,length-n))}}function lastIndexOf(array,value,fromIndex){var index=array?array.length:0;if(typeof fromIndex=="number"){index=(fromIndex<0?nativeMax(0,index+fromIndex):nativeMin(fromIndex,index-1))+1}while(index--){if(array[index]===value){return index}}return-1}function range(start,end,step){start=+start||0;step=+step||1;if(end==null){end=start;start=0}var index=-1,length=nativeMax(0,ceil((end-start)/step)),result=Array(length);while(++index<length){result[index]=start;start+=step}return result}function rest(array,callback,thisArg){if(typeof callback!="number"&&callback!=null){var n=0,index=-1,length=array?array.length:0;callback=lodash.createCallback(callback,thisArg);while(++index<length&&callback(array[index],index,array)){n++}}else{n=callback==null||thisArg?1:nativeMax(0,callback)}return slice(array,n)}function sortedIndex(array,value,callback,thisArg){var low=0,high=array?array.length:low;callback=callback?lodash.createCallback(callback,thisArg,1):identity;value=callback(value);while(low<high){var mid=low+high>>>1;callback(array[mid])<value?low=mid+1:high=mid}return low}function union(){return uniq(concat.apply(arrayRef,arguments))}function uniq(array,isSorted,callback,thisArg){var index=-1,length=array?array.length:0,result=[],seen=result;if(typeof isSorted!="boolean"&&isSorted!=null){thisArg=callback;callback=isSorted;isSorted=false}var isLarge=!isSorted&&length>=75;if(isLarge){var cache={}}if(callback!=null){seen=[];callback=lodash.createCallback(callback,thisArg)}while(++index<length){var value=array[index],computed=callback?callback(value,index,array):value;if(isLarge){var key=String(computed);var inited=hasOwnProperty.call(cache,key)?!(seen=cache[key]):seen=cache[key]=[]}if(isSorted?!index||seen[seen.length-1]!==computed:inited||indexOf(seen,computed)<0){if(callback||isLarge){seen.push(computed)}result.push(value)}}return result}function without(array){var index=-1,length=array?array.length:0,contains=cachedContains(arguments,1,30),result=[];while(++index<length){var value=array[index];if(!contains(value)){result.push(value)}}return result}function zip(array){var index=-1,length=array?max(pluck(arguments,"length")):0,result=Array(length);while(++index<length){result[index]=pluck(arguments,index)}return result}function zipObject(keys,values){var index=-1,length=keys?keys.length:0,result={};while(++index<length){var key=keys[index];if(values){result[key]=values[index]}else{result[key[0]]=key[1]}}return result}function after(n,func){if(n<1){return func()}return function(){if(--n<1){return func.apply(this,arguments)}}}function bind(func,thisArg){return support.fastBind||nativeBind&&arguments.length>2?nativeBind.call.apply(nativeBind,arguments):createBound(func,thisArg,slice(arguments,2))}function bindAll(object){var funcs=concat.apply(arrayRef,arguments),index=funcs.length>1?0:(funcs=functions(object),-1),length=funcs.length;while(++index<length){var key=funcs[index];object[key]=bind(object[key],object)}return object}function bindKey(object,key){return createBound(object,key,slice(arguments,2),indicatorObject)}function compose(){var funcs=arguments;return function(){var args=arguments,length=funcs.length;while(length--){args=[funcs[length].apply(this,args)]}return args[0]}}function createCallback(func,thisArg,argCount){if(func==null){return identity}var type=typeof func;if(type!="function"){if(type!="object"){return function(object){return object[func]}}var props=keys(func);return function(object){var length=props.length,result=false;while(length--){if(!(result=isEqual(object[props[length]],func[props[length]],indicatorObject))){break}}return result}}if(typeof thisArg!="undefined"){if(argCount===1){return function(value){return func.call(thisArg,value)}}if(argCount===2){return function(a,b){return func.call(thisArg,a,b)}}if(argCount===4){return function(accumulator,value,index,collection){return func.call(thisArg,accumulator,value,index,collection)}}return function(value,index,collection){return func.call(thisArg,value,index,collection)}}return func}function debounce(func,wait,immediate){var args,result,thisArg,timeoutId;function delayed(){timeoutId=null;if(!immediate){result=func.apply(thisArg,args)}}return function(){var isImmediate=immediate&&!timeoutId;args=arguments;thisArg=this;clearTimeout(timeoutId);timeoutId=setTimeout(delayed,wait);if(isImmediate){result=func.apply(thisArg,args)}return result}}function defer(func){var args=slice(arguments,1);return setTimeout(function(){func.apply(undefined,args)},1)}if(isV8&&freeModule&&typeof setImmediate=="function"){defer=bind(setImmediate,context)}function delay(func,wait){var args=slice(arguments,2);return setTimeout(function(){func.apply(undefined,args)},wait)}function memoize(func,resolver){var cache={};return function(){var key=String(resolver?resolver.apply(this,arguments):arguments[0]);return hasOwnProperty.call(cache,key)?cache[key]:cache[key]=func.apply(this,arguments)}}function once(func){var ran,result;return function(){if(ran){return result}ran=true;result=func.apply(this,arguments);func=null;return result}}function partial(func){return createBound(func,slice(arguments,1))}function partialRight(func){return createBound(func,slice(arguments,1),null,indicatorObject)}function throttle(func,wait){var args,result,thisArg,timeoutId,lastCalled=0;function trailingCall(){lastCalled=new Date;timeoutId=null;result=func.apply(thisArg,args)}return function(){var now=new Date,remaining=wait-(now-lastCalled);args=arguments;thisArg=this;if(remaining<=0){clearTimeout(timeoutId);timeoutId=null;lastCalled=now;result=func.apply(thisArg,args)}else if(!timeoutId){timeoutId=setTimeout(trailingCall,remaining)}return result}}function wrap(value,wrapper){return function(){var args=[value];push.apply(args,arguments);return wrapper.apply(this,args)}}function escape(string){return string==null?"":String(string).replace(reUnescapedHtml,escapeHtmlChar)}function identity(value){return value}function mixin(object){forEach(functions(object),function(methodName){var func=lodash[methodName]=object[methodName];lodash.prototype[methodName]=function(){var value=this.__wrapped__,args=[value];push.apply(args,arguments);var result=func.apply(lodash,args);return value&&typeof value=="object"&&value==result?this:new lodashWrapper(result)}})}function noConflict(){context._=oldDash;return this}var parseInt=nativeParseInt("08")==8?nativeParseInt:function(value,radix){return nativeParseInt(isString(value)?value.replace(reLeadingZeros,""):value,radix||0)};function random(min,max){if(min==null&&max==null){max=1}min=+min||0;if(max==null){max=min;min=0}return min+floor(nativeRandom()*((+max||0)-min+1))}function result(object,property){var value=object?object[property]:undefined;return isFunction(value)?object[property]():value}function template(text,data,options){var settings=lodash.templateSettings;text||(text="");options=defaults({},options,settings);var imports=defaults({},options.imports,settings.imports),importsKeys=keys(imports),importsValues=values(imports);var isEvaluating,index=0,interpolate=options.interpolate||reNoMatch,source="__p += '";var reDelimiters=RegExp((options.escape||reNoMatch).source+"|"+interpolate.source+"|"+(interpolate===reInterpolate?reEsTemplate:reNoMatch).source+"|"+(options.evaluate||reNoMatch).source+"|$","g");text.replace(reDelimiters,function(match,escapeValue,interpolateValue,esTemplateValue,evaluateValue,offset){interpolateValue||(interpolateValue=esTemplateValue);source+=text.slice(index,offset).replace(reUnescapedString,escapeStringChar);if(escapeValue){source+="' +\n__e("+escapeValue+") +\n'"}if(evaluateValue){isEvaluating=true;source+="';\n"+evaluateValue+";\n__p += '"}if(interpolateValue){source+="' +\n((__t = ("+interpolateValue+")) == null ? '' : __t) +\n'"}index=offset+match.length;return match});source+="';\n";var variable=options.variable,hasVariable=variable;if(!hasVariable){variable="obj";source="with ("+variable+") {\n"+source+"\n}\n"}source=(isEvaluating?source.replace(reEmptyStringLeading,""):source).replace(reEmptyStringMiddle,"$1").replace(reEmptyStringTrailing,"$1;");source="function("+variable+") {\n"+(hasVariable?"":variable+" || ("+variable+" = {});\n")+"var __t, __p = '', __e = _.escape"+(isEvaluating?", __j = Array.prototype.join;\n"+"function print() { __p += __j.call(arguments, '') }\n":";\n")+source+"return __p\n}";var sourceURL="\n/*\n//@ sourceURL="+(options.sourceURL||"/lodash/template/source["+templateCounter++ +"]")+"\n*/";try{var result=Function(importsKeys,"return "+source+sourceURL).apply(undefined,importsValues)}catch(e){e.source=source;throw e}if(data){return result(data)}result.source=source;return result}function times(n,callback,thisArg){n=(n=+n)>-1?n:0;var index=-1,result=Array(n);callback=lodash.createCallback(callback,thisArg,1);while(++index<n){result[index]=callback(index)}return result}function unescape(string){return string==null?"":String(string).replace(reEscapedHtml,unescapeHtmlChar)}function uniqueId(prefix){var id=++idCounter;return String(prefix==null?"":prefix)+id}function tap(value,interceptor){interceptor(value);return value}function wrapperToString(){return String(this.__wrapped__)}function wrapperValueOf(){return this.__wrapped__}lodash.after=after;lodash.assign=assign;lodash.at=at;lodash.bind=bind;lodash.bindAll=bindAll;lodash.bindKey=bindKey;lodash.compact=compact;lodash.compose=compose;lodash.countBy=countBy;lodash.createCallback=createCallback;lodash.debounce=debounce;lodash.defaults=defaults;lodash.defer=defer;lodash.delay=delay;lodash.difference=difference;lodash.filter=filter;lodash.flatten=flatten;lodash.forEach=forEach;lodash.forIn=forIn;lodash.forOwn=forOwn;lodash.functions=functions;lodash.groupBy=groupBy;lodash.initial=initial;lodash.intersection=intersection;lodash.invert=invert;lodash.invoke=invoke;lodash.keys=keys;lodash.map=map;lodash.max=max;lodash.memoize=memoize;lodash.merge=merge;lodash.min=min;lodash.omit=omit;lodash.once=once;lodash.pairs=pairs;lodash.partial=partial;lodash.partialRight=partialRight;lodash.pick=pick;lodash.pluck=pluck;lodash.range=range;lodash.reject=reject;lodash.rest=rest;lodash.shuffle=shuffle;lodash.sortBy=sortBy;lodash.tap=tap;lodash.throttle=throttle;lodash.times=times;lodash.toArray=toArray;lodash.union=union;lodash.uniq=uniq;lodash.values=values;lodash.where=where;lodash.without=without;lodash.wrap=wrap;lodash.zip=zip;lodash.zipObject=zipObject;lodash.collect=map;lodash.drop=rest;lodash.each=forEach;lodash.extend=assign;lodash.methods=functions;lodash.object=zipObject;lodash.select=filter;lodash.tail=rest;lodash.unique=uniq;mixin(lodash);lodash.clone=clone;lodash.cloneDeep=cloneDeep;lodash.contains=contains;lodash.escape=escape;lodash.every=every;lodash.find=find;lodash.findIndex=findIndex;lodash.findKey=findKey;lodash.has=has;lodash.identity=identity;lodash.indexOf=indexOf;lodash.isArguments=isArguments;lodash.isArray=isArray;lodash.isBoolean=isBoolean;lodash.isDate=isDate;lodash.isElement=isElement;lodash.isEmpty=isEmpty;lodash.isEqual=isEqual;lodash.isFinite=isFinite;lodash.isFunction=isFunction;lodash.isNaN=isNaN;lodash.isNull=isNull;lodash.isNumber=isNumber;lodash.isObject=isObject;lodash.isPlainObject=isPlainObject;lodash.isRegExp=isRegExp;lodash.isString=isString;lodash.isUndefined=isUndefined;lodash.lastIndexOf=lastIndexOf;lodash.mixin=mixin;lodash.noConflict=noConflict;lodash.parseInt=parseInt;lodash.random=random;lodash.reduce=reduce;lodash.reduceRight=reduceRight;lodash.result=result;lodash.runInContext=runInContext;lodash.size=size;lodash.some=some;lodash.sortedIndex=sortedIndex;lodash.template=template;lodash.unescape=unescape;lodash.uniqueId=uniqueId;lodash.all=every;lodash.any=some;lodash.detect=find;lodash.foldl=reduce;lodash.foldr=reduceRight;lodash.include=contains;lodash.inject=reduce;forOwn(lodash,function(func,methodName){if(!lodash.prototype[methodName]){lodash.prototype[methodName]=function(){var args=[this.__wrapped__];push.apply(args,arguments);return func.apply(lodash,args)}}});lodash.first=first;lodash.last=last;lodash.take=first;lodash.head=first;forOwn(lodash,function(func,methodName){if(!lodash.prototype[methodName]){lodash.prototype[methodName]=function(callback,thisArg){var result=func(this.__wrapped__,callback,thisArg);return callback==null||thisArg&&typeof callback!="function"?result:new lodashWrapper(result)}}});lodash.VERSION="1.1.1";lodash.prototype.toString=wrapperToString;lodash.prototype.value=wrapperValueOf;lodash.prototype.valueOf=wrapperValueOf;each(["join","pop","shift"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){return func.apply(this.__wrapped__,arguments)}});each(["push","reverse","sort","unshift"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){func.apply(this.__wrapped__,arguments);return this}});each(["concat","slice","splice"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){return new lodashWrapper(func.apply(this.__wrapped__,arguments))}});if(!support.spliceObjects){each(["pop","shift","splice"],function(methodName){var func=arrayRef[methodName],isSplice=methodName=="splice";lodash.prototype[methodName]=function(){var value=this.__wrapped__,result=func.apply(value,arguments);if(value.length===0){delete value[0]}return isSplice?new lodashWrapper(result):result}})}return lodash}var _=runInContext();if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){window._=_;define("_",[],function(){return _})}else if(freeExports&&!freeExports.nodeType){if(freeModule){(freeModule.exports=_)._=_}else{freeExports._=_}}else{window._=_}})(this);define("core/base",["require","./mixin/derive","./mixin/notifier","./mixin/dirty","./cache","_"],function(require){var deriveMixin=require("./mixin/derive");var notifierMixin=require("./mixin/notifier");var dirtyMixin=require("./mixin/dirty");var Cache=require("./cache");var _=require("_");var Base=function(){this.cache=new Cache};_.extend(Base,deriveMixin);_.extend(Base.prototype,notifierMixin);_.extend(Base.prototype,dirtyMixin);return Base});(function(_global){var shim={};if(typeof exports==="undefined"){if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){shim.exports={};define("glmatrix",[],function(){return shim.exports})}else{shim.exports=typeof window!=="undefined"?window:_global}}else{shim.exports=exports}(function(exports){if(!GLMAT_EPSILON){var GLMAT_EPSILON=1e-6}if(!GLMAT_ARRAY_TYPE){var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array}if(!GLMAT_RANDOM){var GLMAT_RANDOM=Math.random}var glMatrix={};glMatrix.setMatrixArrayType=function(type){GLMAT_ARRAY_TYPE=type};if(typeof exports!=="undefined"){exports.glMatrix=glMatrix}var vec2={};vec2.create=function(){var out=new GLMAT_ARRAY_TYPE(2);out[0]=0;out[1]=0;return out};vec2.clone=function(a){var out=new GLMAT_ARRAY_TYPE(2);out[0]=a[0];out[1]=a[1];return out};vec2.fromValues=function(x,y){var out=new GLMAT_ARRAY_TYPE(2);out[0]=x;out[1]=y;return out};vec2.copy=function(out,a){out[0]=a[0];out[1]=a[1];return out};vec2.set=function(out,x,y){out[0]=x;out[1]=y;return out};vec2.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];return out};vec2.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];return out};vec2.sub=vec2.subtract;vec2.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];return out};vec2.mul=vec2.multiply;vec2.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];return out};vec2.div=vec2.divide;vec2.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);return out};vec2.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);return out};vec2.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;return out};vec2.scaleAndAdd=function(out,a,b,scale){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;return out};vec2.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1];return Math.sqrt(x*x+y*y)};vec2.dist=vec2.distance;vec2.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1];return x*x+y*y};vec2.sqrDist=vec2.squaredDistance;vec2.length=function(a){var x=a[0],y=a[1];return Math.sqrt(x*x+y*y)};vec2.len=vec2.length;vec2.squaredLength=function(a){var x=a[0],y=a[1];return x*x+y*y};vec2.sqrLen=vec2.squaredLength;vec2.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];return out};vec2.normalize=function(out,a){var x=a[0],y=a[1];var len=x*x+y*y;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len}return out};vec2.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]};vec2.cross=function(out,a,b){var z=a[0]*b[1]-a[1]*b[0];out[0]=out[1]=0;out[2]=z;return out};vec2.lerp=function(out,a,b,t){var ax=a[0],ay=a[1];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);return out};vec2.random=function(out,scale){scale=scale||1;var r=GLMAT_RANDOM()*2*Math.PI;out[0]=Math.cos(r)*scale;out[1]=Math.sin(r)*scale;return out};vec2.transformMat2=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[2]*y;out[1]=m[1]*x+m[3]*y;return out};vec2.transformMat2d=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[2]*y+m[4];out[1]=m[1]*x+m[3]*y+m[5];return out};vec2.transformMat3=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[3]*y+m[6];out[1]=m[1]*x+m[4]*y+m[7];return out};vec2.transformMat4=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[4]*y+m[12];out[1]=m[1]*x+m[5]*y+m[13];return out};vec2.forEach=function(){var vec=vec2.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=2}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1]}return a}}();vec2.str=function(a){return"vec2("+a[0]+", "+a[1]+")"};if(typeof exports!=="undefined"){exports.vec2=vec2}var vec3={};vec3.create=function(){var out=new GLMAT_ARRAY_TYPE(3);out[0]=0;out[1]=0;out[2]=0;return out};vec3.clone=function(a){var out=new GLMAT_ARRAY_TYPE(3);out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.fromValues=function(x,y,z){var out=new GLMAT_ARRAY_TYPE(3);out[0]=x;out[1]=y;out[2]=z;return out};vec3.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.set=function(out,x,y,z){out[0]=x;out[1]=y;out[2]=z;return out};vec3.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];return out};vec3.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];return out};vec3.sub=vec3.subtract;vec3.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];return out};vec3.mul=vec3.multiply;vec3.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];return out};vec3.div=vec3.divide;vec3.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);return out};vec3.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);return out};vec3.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;return out};vec3.scaleAndAdd=function(out,a,b,scale){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;return out};vec3.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.dist=vec3.distance;vec3.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return x*x+y*y+z*z};vec3.sqrDist=vec3.squaredDistance;vec3.length=function(a){var x=a[0],y=a[1],z=a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.len=vec3.length;vec3.squaredLength=function(a){var x=a[0],y=a[1],z=a[2];return x*x+y*y+z*z};vec3.sqrLen=vec3.squaredLength;vec3.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];return out};vec3.normalize=function(out,a){var x=a[0],y=a[1],z=a[2];var len=x*x+y*y+z*z;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len}return out};vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};vec3.cross=function(out,a,b){var ax=a[0],ay=a[1],az=a[2],bx=b[0],by=b[1],bz=b[2];out[0]=ay*bz-az*by;out[1]=az*bx-ax*bz;out[2]=ax*by-ay*bx;return out};vec3.lerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);return out};vec3.random=function(out,scale){scale=scale||1;var r=GLMAT_RANDOM()*2*Math.PI;var z=GLMAT_RANDOM()*2-1;var zScale=Math.sqrt(1-z*z)*scale;out[0]=Math.cos(r)*zScale;out[1]=Math.sin(r)*zScale;out[2]=z*scale;return out};vec3.transformMat4=function(out,a,m){var x=a[0],y=a[1],z=a[2];
out[0]=m[0]*x+m[4]*y+m[8]*z+m[12];out[1]=m[1]*x+m[5]*y+m[9]*z+m[13];out[2]=m[2]*x+m[6]*y+m[10]*z+m[14];return out};vec3.transformMat3=function(out,a,m){var x=a[0],y=a[1],z=a[2];out[0]=x*m[0]+y*m[3]+z*m[6];out[1]=x*m[1]+y*m[4]+z*m[7];out[2]=x*m[2]+y*m[5]+z*m[8];return out};vec3.transformQuat=function(out,a,q){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return out};vec3.forEach=function(){var vec=vec3.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=3}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2]}return a}}();vec3.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"};if(typeof exports!=="undefined"){exports.vec3=vec3}var vec4={};vec4.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=0;out[1]=0;out[2]=0;out[3]=0;return out};vec4.clone=function(a){var out=new GLMAT_ARRAY_TYPE(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.fromValues=function(x,y,z,w){var out=new GLMAT_ARRAY_TYPE(4);out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out};vec4.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.set=function(out,x,y,z,w){out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out};vec4.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];return out};vec4.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];out[3]=a[3]-b[3];return out};vec4.sub=vec4.subtract;vec4.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];out[3]=a[3]*b[3];return out};vec4.mul=vec4.multiply;vec4.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];out[3]=a[3]/b[3];return out};vec4.div=vec4.divide;vec4.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);out[3]=Math.min(a[3],b[3]);return out};vec4.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);out[3]=Math.max(a[3],b[3]);return out};vec4.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;out[3]=a[3]*b;return out};vec4.scaleAndAdd=function(out,a,b,scale){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;out[3]=a[3]+b[3]*scale;return out};vec4.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.dist=vec4.distance;vec4.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return x*x+y*y+z*z+w*w};vec4.sqrDist=vec4.squaredDistance;vec4.length=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.len=vec4.length;vec4.squaredLength=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return x*x+y*y+z*z+w*w};vec4.sqrLen=vec4.squaredLength;vec4.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=-a[3];return out};vec4.normalize=function(out,a){var x=a[0],y=a[1],z=a[2],w=a[3];var len=x*x+y*y+z*z+w*w;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len;out[3]=a[3]*len}return out};vec4.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};vec4.lerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2],aw=a[3];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);out[3]=aw+t*(b[3]-aw);return out};vec4.random=function(out,scale){scale=scale||1;out[0]=GLMAT_RANDOM();out[1]=GLMAT_RANDOM();out[2]=GLMAT_RANDOM();out[3]=GLMAT_RANDOM();vec4.normalize(out,out);vec4.scale(out,out,scale);return out};vec4.transformMat4=function(out,a,m){var x=a[0],y=a[1],z=a[2],w=a[3];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12]*w;out[1]=m[1]*x+m[5]*y+m[9]*z+m[13]*w;out[2]=m[2]*x+m[6]*y+m[10]*z+m[14]*w;out[3]=m[3]*x+m[7]*y+m[11]*z+m[15]*w;return out};vec4.transformQuat=function(out,a,q){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return out};vec4.forEach=function(){var vec=vec4.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=4}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];vec[3]=a[i+3];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2];a[i+3]=vec[3]}return a}}();vec4.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined"){exports.vec4=vec4}var mat2={};mat2.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=1;out[1]=0;out[2]=0;out[3]=1;return out};mat2.clone=function(a){var out=new GLMAT_ARRAY_TYPE(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};mat2.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};mat2.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=1;return out};mat2.transpose=function(out,a){if(out===a){var a1=a[1];out[1]=a[2];out[2]=a1}else{out[0]=a[0];out[1]=a[2];out[2]=a[1];out[3]=a[3]}return out};mat2.invert=function(out,a){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],det=a0*a3-a2*a1;if(!det){return null}det=1/det;out[0]=a3*det;out[1]=-a1*det;out[2]=-a2*det;out[3]=a0*det;return out};mat2.adjoint=function(out,a){var a0=a[0];out[0]=a[3];out[1]=-a[1];out[2]=-a[2];out[3]=a0;return out};mat2.determinant=function(a){return a[0]*a[3]-a[2]*a[1]};mat2.multiply=function(out,a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=a0*b0+a1*b2;out[1]=a0*b1+a1*b3;out[2]=a2*b0+a3*b2;out[3]=a2*b1+a3*b3;return out};mat2.mul=mat2.multiply;mat2.rotate=function(out,a,rad){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],s=Math.sin(rad),c=Math.cos(rad);out[0]=a0*c+a1*s;out[1]=a0*-s+a1*c;out[2]=a2*c+a3*s;out[3]=a2*-s+a3*c;return out};mat2.scale=function(out,a,v){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],v0=v[0],v1=v[1];out[0]=a0*v0;out[1]=a1*v1;out[2]=a2*v0;out[3]=a3*v1;return out};mat2.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined"){exports.mat2=mat2}var mat2d={};mat2d.create=function(){var out=new GLMAT_ARRAY_TYPE(6);out[0]=1;out[1]=0;out[2]=0;out[3]=1;out[4]=0;out[5]=0;return out};mat2d.clone=function(a){var out=new GLMAT_ARRAY_TYPE(6);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];return out};mat2d.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];return out};mat2d.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=1;out[4]=0;out[5]=0;return out};mat2d.invert=function(out,a){var aa=a[0],ab=a[1],ac=a[2],ad=a[3],atx=a[4],aty=a[5];var det=aa*ad-ab*ac;if(!det){return null}det=1/det;out[0]=ad*det;out[1]=-ab*det;out[2]=-ac*det;out[3]=aa*det;out[4]=(ac*aty-ad*atx)*det;out[5]=(ab*atx-aa*aty)*det;return out};mat2d.determinant=function(a){return a[0]*a[3]-a[1]*a[2]};mat2d.multiply=function(out,a,b){var aa=a[0],ab=a[1],ac=a[2],ad=a[3],atx=a[4],aty=a[5],ba=b[0],bb=b[1],bc=b[2],bd=b[3],btx=b[4],bty=b[5];out[0]=aa*ba+ab*bc;out[1]=aa*bb+ab*bd;out[2]=ac*ba+ad*bc;out[3]=ac*bb+ad*bd;out[4]=ba*atx+bc*aty+btx;out[5]=bb*atx+bd*aty+bty;return out};mat2d.mul=mat2d.multiply;mat2d.rotate=function(out,a,rad){var aa=a[0],ab=a[1],ac=a[2],ad=a[3],atx=a[4],aty=a[5],st=Math.sin(rad),ct=Math.cos(rad);out[0]=aa*ct+ab*st;out[1]=-aa*st+ab*ct;out[2]=ac*ct+ad*st;out[3]=-ac*st+ct*ad;out[4]=ct*atx+st*aty;out[5]=ct*aty-st*atx;return out};mat2d.scale=function(out,a,v){var vx=v[0],vy=v[1];out[0]=a[0]*vx;out[1]=a[1]*vy;out[2]=a[2]*vx;out[3]=a[3]*vy;out[4]=a[4]*vx;out[5]=a[5]*vy;return out};mat2d.translate=function(out,a,v){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4]+v[0];out[5]=a[5]+v[1];return out};mat2d.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"};if(typeof exports!=="undefined"){exports.mat2d=mat2d}var mat3={};mat3.create=function(){var out=new GLMAT_ARRAY_TYPE(9);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.fromMat4=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[4];out[4]=a[5];out[5]=a[6];out[6]=a[8];out[7]=a[9];out[8]=a[10];return out};mat3.clone=function(a){var out=new GLMAT_ARRAY_TYPE(9);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.transpose=function(out,a){if(out===a){var a01=a[1],a02=a[2],a12=a[5];out[1]=a[3];out[2]=a[6];out[3]=a01;out[5]=a[7];out[6]=a02;out[7]=a12}else{out[0]=a[0];out[1]=a[3];out[2]=a[6];out[3]=a[1];out[4]=a[4];out[5]=a[7];out[6]=a[2];out[7]=a[5];out[8]=a[8]}return out};mat3.invert=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b01=a22*a11-a12*a21,b11=-a22*a10+a12*a20,b21=a21*a10-a11*a20,det=a00*b01+a01*b11+a02*b21;if(!det){return null}det=1/det;out[0]=b01*det;out[1]=(-a22*a01+a02*a21)*det;out[2]=(a12*a01-a02*a11)*det;out[3]=b11*det;out[4]=(a22*a00-a02*a20)*det;out[5]=(-a12*a00+a02*a10)*det;out[6]=b21*det;out[7]=(-a21*a00+a01*a20)*det;out[8]=(a11*a00-a01*a10)*det;return out};mat3.adjoint=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];out[0]=a11*a22-a12*a21;out[1]=a02*a21-a01*a22;out[2]=a01*a12-a02*a11;out[3]=a12*a20-a10*a22;out[4]=a00*a22-a02*a20;out[5]=a02*a10-a00*a12;out[6]=a10*a21-a11*a20;out[7]=a01*a20-a00*a21;out[8]=a00*a11-a01*a10;return out};mat3.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];return a00*(a22*a11-a12*a21)+a01*(-a22*a10+a12*a20)+a02*(a21*a10-a11*a20)};mat3.multiply=function(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b00=b[0],b01=b[1],b02=b[2],b10=b[3],b11=b[4],b12=b[5],b20=b[6],b21=b[7],b22=b[8];out[0]=b00*a00+b01*a10+b02*a20;out[1]=b00*a01+b01*a11+b02*a21;out[2]=b00*a02+b01*a12+b02*a22;out[3]=b10*a00+b11*a10+b12*a20;out[4]=b10*a01+b11*a11+b12*a21;out[5]=b10*a02+b11*a12+b12*a22;out[6]=b20*a00+b21*a10+b22*a20;out[7]=b20*a01+b21*a11+b22*a21;out[8]=b20*a02+b21*a12+b22*a22;return out};mat3.mul=mat3.multiply;mat3.translate=function(out,a,v){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],x=v[0],y=v[1];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a10;out[4]=a11;out[5]=a12;out[6]=x*a00+y*a10+a20;out[7]=x*a01+y*a11+a21;out[8]=x*a02+y*a12+a22;return out};mat3.rotate=function(out,a,rad){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],s=Math.sin(rad),c=Math.cos(rad);out[0]=c*a00+s*a10;out[1]=c*a01+s*a11;out[2]=c*a02+s*a12;out[3]=c*a10-s*a00;out[4]=c*a11-s*a01;out[5]=c*a12-s*a02;out[6]=a20;out[7]=a21;out[8]=a22;return out};mat3.scale=function(out,a,v){var x=v[0],y=v[1];out[0]=x*a[0];out[1]=x*a[1];out[2]=x*a[2];out[3]=y*a[3];out[4]=y*a[4];out[5]=y*a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.fromMat2d=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=0;out[3]=a[2];out[4]=a[3];out[5]=0;out[6]=a[4];out[7]=a[5];out[8]=1;return out};mat3.fromQuat=function(out,q){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-(yy+zz);out[3]=xy+wz;out[6]=xz-wy;out[1]=xy-wz;out[4]=1-(xx+zz);out[7]=yz+wx;out[2]=xz+wy;out[5]=yz-wx;out[8]=1-(xx+yy);return out};mat3.normalFromMat4=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det){return null}det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a12*b08-a10*b11-a13*b07)*det;out[2]=(a10*b10-a11*b08+a13*b06)*det;out[3]=(a02*b10-a01*b11-a03*b09)*det;out[4]=(a00*b11-a02*b08+a03*b07)*det;out[5]=(a01*b08-a00*b10-a03*b06)*det;out[6]=(a31*b05-a32*b04+a33*b03)*det;out[7]=(a32*b02-a30*b05-a33*b01)*det;out[8]=(a30*b04-a31*b02+a33*b00)*det;return out};mat3.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"};if(typeof exports!=="undefined"){exports.mat3=mat3}var mat4={};mat4.create=function(){var out=new GLMAT_ARRAY_TYPE(16);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.clone=function(a){var out=new GLMAT_ARRAY_TYPE(16);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.transpose=function(out,a){if(out===a){var a01=a[1],a02=a[2],a03=a[3],a12=a[6],a13=a[7],a23=a[11];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a01;out[6]=a[9];out[7]=a[13];out[8]=a02;out[9]=a12;out[11]=a[14];out[12]=a03;out[13]=a13;out[14]=a23}else{out[0]=a[0];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a[1];out[5]=a[5];out[6]=a[9];out[7]=a[13];out[8]=a[2];out[9]=a[6];out[10]=a[10];out[11]=a[14];out[12]=a[3];out[13]=a[7];out[14]=a[11];out[15]=a[15]}return out};mat4.invert=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det){return null}det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a02*b10-a01*b11-a03*b09)*det;out[2]=(a31*b05-a32*b04+a33*b03)*det;out[3]=(a22*b04-a21*b05-a23*b03)*det;out[4]=(a12*b08-a10*b11-a13*b07)*det;out[5]=(a00*b11-a02*b08+a03*b07)*det;out[6]=(a32*b02-a30*b05-a33*b01)*det;out[7]=(a20*b05-a22*b02+a23*b01)*det;out[8]=(a10*b10-a11*b08+a13*b06)*det;out[9]=(a01*b08-a00*b10-a03*b06)*det;out[10]=(a30*b04-a31*b02+a33*b00)*det;out[11]=(a21*b02-a20*b04-a23*b00)*det;out[12]=(a11*b07-a10*b09-a12*b06)*det;out[13]=(a00*b09-a01*b07+a02*b06)*det;out[14]=(a31*b01-a30*b03-a32*b00)*det;out[15]=(a20*b03-a21*b01+a22*b00)*det;return out};mat4.adjoint=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];out[0]=a11*(a22*a33-a23*a32)-a21*(a12*a33-a13*a32)+a31*(a12*a23-a13*a22);out[1]=-(a01*(a22*a33-a23*a32)-a21*(a02*a33-a03*a32)+a31*(a02*a23-a03*a22));out[2]=a01*(a12*a33-a13*a32)-a11*(a02*a33-a03*a32)+a31*(a02*a13-a03*a12);out[3]=-(a01*(a12*a23-a13*a22)-a11*(a02*a23-a03*a22)+a21*(a02*a13-a03*a12));out[4]=-(a10*(a22*a33-a23*a32)-a20*(a12*a33-a13*a32)+a30*(a12*a23-a13*a22));out[5]=a00*(a22*a33-a23*a32)-a20*(a02*a33-a03*a32)+a30*(a02*a23-a03*a22);out[6]=-(a00*(a12*a33-a13*a32)-a10*(a02*a33-a03*a32)+a30*(a02*a13-a03*a12));out[7]=a00*(a12*a23-a13*a22)-a10*(a02*a23-a03*a22)+a20*(a02*a13-a03*a12);out[8]=a10*(a21*a33-a23*a31)-a20*(a11*a33-a13*a31)+a30*(a11*a23-a13*a21);out[9]=-(a00*(a21*a33-a23*a31)-a20*(a01*a33-a03*a31)+a30*(a01*a23-a03*a21));out[10]=a00*(a11*a33-a13*a31)-a10*(a01*a33-a03*a31)+a30*(a01*a13-a03*a11);out[11]=-(a00*(a11*a23-a13*a21)-a10*(a01*a23-a03*a21)+a20*(a01*a13-a03*a11));out[12]=-(a10*(a21*a32-a22*a31)-a20*(a11*a32-a12*a31)+a30*(a11*a22-a12*a21));out[13]=a00*(a21*a32-a22*a31)-a20*(a01*a32-a02*a31)+a30*(a01*a22-a02*a21);out[14]=-(a00*(a11*a32-a12*a31)-a10*(a01*a32-a02*a31)+a30*(a01*a12-a02*a11));out[15]=a00*(a11*a22-a12*a21)-a10*(a01*a22-a02*a21)+a20*(a01*a12-a02*a11);return out};mat4.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32;return b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06};mat4.multiply=function(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=b0*a00+b1*a10+b2*a20+b3*a30;out[1]=b0*a01+b1*a11+b2*a21+b3*a31;out[2]=b0*a02+b1*a12+b2*a22+b3*a32;out[3]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[4];b1=b[5];b2=b[6];b3=b[7];out[4]=b0*a00+b1*a10+b2*a20+b3*a30;out[5]=b0*a01+b1*a11+b2*a21+b3*a31;out[6]=b0*a02+b1*a12+b2*a22+b3*a32;out[7]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[8];b1=b[9];b2=b[10];b3=b[11];out[8]=b0*a00+b1*a10+b2*a20+b3*a30;out[9]=b0*a01+b1*a11+b2*a21+b3*a31;out[10]=b0*a02+b1*a12+b2*a22+b3*a32;out[11]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[12];b1=b[13];b2=b[14];b3=b[15];out[12]=b0*a00+b1*a10+b2*a20+b3*a30;out[13]=b0*a01+b1*a11+b2*a21+b3*a31;out[14]=b0*a02+b1*a12+b2*a22+b3*a32;out[15]=b0*a03+b1*a13+b2*a23+b3*a33;return out};mat4.mul=mat4.multiply;mat4.translate=function(out,a,v){var x=v[0],y=v[1],z=v[2],a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23;if(a===out){out[12]=a[0]*x+a[4]*y+a[8]*z+a[12];out[13]=a[1]*x+a[5]*y+a[9]*z+a[13];out[14]=a[2]*x+a[6]*y+a[10]*z+a[14];out[15]=a[3]*x+a[7]*y+a[11]*z+a[15]}else{a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a03;out[4]=a10;out[5]=a11;out[6]=a12;out[7]=a13;out[8]=a20;out[9]=a21;out[10]=a22;out[11]=a23;out[12]=a00*x+a10*y+a20*z+a[12];out[13]=a01*x+a11*y+a21*z+a[13];out[14]=a02*x+a12*y+a22*z+a[14];out[15]=a03*x+a13*y+a23*z+a[15]}return out};mat4.scale=function(out,a,v){var x=v[0],y=v[1],z=v[2];out[0]=a[0]*x;out[1]=a[1]*x;out[2]=a[2]*x;out[3]=a[3]*x;out[4]=a[4]*y;out[5]=a[5]*y;out[6]=a[6]*y;out[7]=a[7]*y;out[8]=a[8]*z;out[9]=a[9]*z;out[10]=a[10]*z;out[11]=a[11]*z;out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.rotate=function(out,a,rad,axis){var x=axis[0],y=axis[1],z=axis[2],len=Math.sqrt(x*x+y*y+z*z),s,c,t,a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23,b00,b01,b02,b10,b11,b12,b20,b21,b22;if(Math.abs(len)<GLMAT_EPSILON){return null}len=1/len;x*=len;y*=len;z*=len;s=Math.sin(rad);c=Math.cos(rad);t=1-c;a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];b00=x*x*t+c;b01=y*x*t+z*s;b02=z*x*t-y*s;b10=x*y*t-z*s;b11=y*y*t+c;b12=z*y*t+x*s;b20=x*z*t+y*s;b21=y*z*t-x*s;b22=z*z*t+c;out[0]=a00*b00+a10*b01+a20*b02;out[1]=a01*b00+a11*b01+a21*b02;out[2]=a02*b00+a12*b01+a22*b02;out[3]=a03*b00+a13*b01+a23*b02;out[4]=a00*b10+a10*b11+a20*b12;out[5]=a01*b10+a11*b11+a21*b12;out[6]=a02*b10+a12*b11+a22*b12;out[7]=a03*b10+a13*b11+a23*b12;out[8]=a00*b20+a10*b21+a20*b22;out[9]=a01*b20+a11*b21+a21*b22;out[10]=a02*b20+a12*b21+a22*b22;out[11]=a03*b20+a13*b21+a23*b22;if(a!==out){out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}return out};mat4.rotateX=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11];if(a!==out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[4]=a10*c+a20*s;out[5]=a11*c+a21*s;out[6]=a12*c+a22*s;out[7]=a13*c+a23*s;out[8]=a20*c-a10*s;out[9]=a21*c-a11*s;out[10]=a22*c-a12*s;out[11]=a23*c-a13*s;return out};mat4.rotateY=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a20=a[8],a21=a[9],a22=a[10],a23=a[11];if(a!==out){out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c-a20*s;out[1]=a01*c-a21*s;out[2]=a02*c-a22*s;out[3]=a03*c-a23*s;out[8]=a00*s+a20*c;out[9]=a01*s+a21*c;out[10]=a02*s+a22*c;out[11]=a03*s+a23*c;return out};mat4.rotateZ=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7];if(a!==out){out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c+a10*s;out[1]=a01*c+a11*s;out[2]=a02*c+a12*s;out[3]=a03*c+a13*s;out[4]=a10*c-a00*s;out[5]=a11*c-a01*s;out[6]=a12*c-a02*s;out[7]=a13*c-a03*s;return out};mat4.fromRotationTranslation=function(out,q,v){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-(yy+zz);out[1]=xy+wz;out[2]=xz-wy;out[3]=0;out[4]=xy-wz;out[5]=1-(xx+zz);out[6]=yz+wx;out[7]=0;out[8]=xz+wy;out[9]=yz-wx;out[10]=1-(xx+yy);out[11]=0;out[12]=v[0];out[13]=v[1];out[14]=v[2];out[15]=1;return out};mat4.fromQuat=function(out,q){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-(yy+zz);out[1]=xy+wz;out[2]=xz-wy;out[3]=0;out[4]=xy-wz;out[5]=1-(xx+zz);out[6]=yz+wx;out[7]=0;out[8]=xz+wy;out[9]=yz-wx;out[10]=1-(xx+yy);out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.frustum=function(out,left,right,bottom,top,near,far){var rl=1/(right-left),tb=1/(top-bottom),nf=1/(near-far);out[0]=near*2*rl;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=near*2*tb;out[6]=0;out[7]=0;out[8]=(right+left)*rl;out[9]=(top+bottom)*tb;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=far*near*2*nf;out[15]=0;return out};mat4.perspective=function(out,fovy,aspect,near,far){var f=1/Math.tan(fovy/2),nf=1/(near-far);out[0]=f/aspect;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=f;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=2*far*near*nf;out[15]=0;return out};mat4.ortho=function(out,left,right,bottom,top,near,far){var lr=1/(left-right),bt=1/(bottom-top),nf=1/(near-far);out[0]=-2*lr;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=-2*bt;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=2*nf;out[11]=0;out[12]=(left+right)*lr;out[13]=(top+bottom)*bt;out[14]=(far+near)*nf;out[15]=1;return out};mat4.lookAt=function(out,eye,center,up){var x0,x1,x2,y0,y1,y2,z0,z1,z2,len,eyex=eye[0],eyey=eye[1],eyez=eye[2],upx=up[0],upy=up[1],upz=up[2],centerx=center[0],centery=center[1],centerz=center[2];if(Math.abs(eyex-centerx)<GLMAT_EPSILON&&Math.abs(eyey-centery)<GLMAT_EPSILON&&Math.abs(eyez-centerz)<GLMAT_EPSILON){return mat4.identity(out)}z0=eyex-centerx;z1=eyey-centery;z2=eyez-centerz;len=1/Math.sqrt(z0*z0+z1*z1+z2*z2);z0*=len;z1*=len;z2*=len;x0=upy*z2-upz*z1;x1=upz*z0-upx*z2;x2=upx*z1-upy*z0;len=Math.sqrt(x0*x0+x1*x1+x2*x2);if(!len){x0=0;x1=0;x2=0}else{len=1/len;x0*=len;x1*=len;x2*=len}y0=z1*x2-z2*x1;y1=z2*x0-z0*x2;y2=z0*x1-z1*x0;len=Math.sqrt(y0*y0+y1*y1+y2*y2);if(!len){y0=0;y1=0;y2=0}else{len=1/len;y0*=len;y1*=len;y2*=len}out[0]=x0;out[1]=y0;out[2]=z0;out[3]=0;out[4]=x1;out[5]=y1;out[6]=z1;out[7]=0;out[8]=x2;out[9]=y2;out[10]=z2;out[11]=0;out[12]=-(x0*eyex+x1*eyey+x2*eyez);out[13]=-(y0*eyex+y1*eyey+y2*eyez);out[14]=-(z0*eyex+z1*eyey+z2*eyez);out[15]=1;return out};mat4.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"};if(typeof exports!=="undefined"){exports.mat4=mat4}var quat={};quat.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out};quat.rotationTo=function(){var tmpvec3=vec3.create();var xUnitVec3=vec3.fromValues(1,0,0);var yUnitVec3=vec3.fromValues(0,1,0);return function(out,a,b){var dot=vec3.dot(a,b);if(dot<-.999999){vec3.cross(tmpvec3,xUnitVec3,a);if(vec3.length(tmpvec3)<1e-6)vec3.cross(tmpvec3,yUnitVec3,a);vec3.normalize(tmpvec3,tmpvec3);quat.setAxisAngle(out,tmpvec3,Math.PI);return out}else if(dot>.999999){out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out}else{vec3.cross(tmpvec3,a,b);out[0]=tmpvec3[0];out[1]=tmpvec3[1];out[2]=tmpvec3[2];out[3]=1+dot;return quat.normalize(out,out)}}}();quat.setAxes=function(){var matr=mat3.create();return function(out,view,right,up){matr[0]=right[0];matr[3]=right[1];matr[6]=right[2];matr[1]=up[0];matr[4]=up[1];matr[7]=up[2];matr[2]=view[0];matr[5]=view[1];matr[8]=view[2];return quat.normalize(out,quat.fromMat3(out,matr))}}();quat.clone=vec4.clone;quat.fromValues=vec4.fromValues;quat.copy=vec4.copy;quat.set=vec4.set;quat.identity=function(out){out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out};quat.setAxisAngle=function(out,axis,rad){rad=rad*.5;var s=Math.sin(rad);out[0]=s*axis[0];out[1]=s*axis[1];out[2]=s*axis[2];out[3]=Math.cos(rad);return out};quat.add=vec4.add;quat.multiply=function(out,a,b){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];out[0]=ax*bw+aw*bx+ay*bz-az*by;out[1]=ay*bw+aw*by+az*bx-ax*bz;out[2]=az*bw+aw*bz+ax*by-ay*bx;out[3]=aw*bw-ax*bx-ay*by-az*bz;return out};quat.mul=quat.multiply;quat.scale=vec4.scale;quat.rotateX=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+aw*bx;out[1]=ay*bw+az*bx;out[2]=az*bw-ay*bx;out[3]=aw*bw-ax*bx;return out};quat.rotateY=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],by=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw-az*by;out[1]=ay*bw+aw*by;out[2]=az*bw+ax*by;out[3]=aw*bw-ay*by;return out};quat.rotateZ=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],bz=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+ay*bz;out[1]=ay*bw-ax*bz;out[2]=az*bw+aw*bz;out[3]=aw*bw-az*bz;return out};quat.calculateW=function(out,a){var x=a[0],y=a[1],z=a[2];out[0]=x;out[1]=y;out[2]=z;out[3]=-Math.sqrt(Math.abs(1-x*x-y*y-z*z));return out};quat.dot=vec4.dot;quat.lerp=vec4.lerp;quat.slerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];var omega,cosom,sinom,scale0,scale1;cosom=ax*bx+ay*by+az*bz+aw*bw;if(cosom<0){cosom=-cosom;bx=-bx;by=-by;bz=-bz;bw=-bw}if(1-cosom>1e-6){omega=Math.acos(cosom);sinom=Math.sin(omega);scale0=Math.sin((1-t)*omega)/sinom;scale1=Math.sin(t*omega)/sinom}else{scale0=1-t;scale1=t}out[0]=scale0*ax+scale1*bx;out[1]=scale0*ay+scale1*by;out[2]=scale0*az+scale1*bz;out[3]=scale0*aw+scale1*bw;return out};quat.invert=function(out,a){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],dot=a0*a0+a1*a1+a2*a2+a3*a3,invDot=dot?1/dot:0;out[0]=-a0*invDot;out[1]=-a1*invDot;out[2]=-a2*invDot;out[3]=a3*invDot;return out};quat.conjugate=function(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=a[3];return out};quat.length=vec4.length;quat.len=quat.length;quat.squaredLength=vec4.squaredLength;quat.sqrLen=quat.squaredLength;quat.normalize=vec4.normalize;quat.fromMat3=function(){var s_iNext=typeof Int8Array!=="undefined"?new Int8Array([1,2,0]):[1,2,0];return function(out,m){var fTrace=m[0]+m[4]+m[8];var fRoot;if(fTrace>0){fRoot=Math.sqrt(fTrace+1);out[3]=.5*fRoot;fRoot=.5/fRoot;out[0]=(m[7]-m[5])*fRoot;out[1]=(m[2]-m[6])*fRoot;out[2]=(m[3]-m[1])*fRoot}else{var i=0;if(m[4]>m[0])i=1;if(m[8]>m[i*3+i])i=2;var j=s_iNext[i];var k=s_iNext[j];fRoot=Math.sqrt(m[i*3+i]-m[j*3+j]-m[k*3+k]+1);out[i]=.5*fRoot;fRoot=.5/fRoot;out[3]=(m[k*3+j]-m[j*3+k])*fRoot;out[j]=(m[j*3+i]+m[i*3+j])*fRoot;out[k]=(m[k*3+i]+m[i*3+k])*fRoot}return out}}();quat.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined"){exports.quat=quat}})(shim.exports)})(this);define("2d/style",["require","core/base","_"],function(require){var Base=require("core/base");var _=require("_");var _styles=["fillStyle","strokeStyle","lineWidth","shadowColor","shadowOffsetX","shadowOffsetY","shadowBlur","globalAlpha","font"];var _styleAlias={fill:"fillStyle",stroke:"strokeStyle",alpha:"globalAlpha",shadow:["shadowOffsetX","shadowOffsetY","shadowBlur","shadowColor"]};var shadowSyntaxRegex=/([0-9\-]+)\s+([0-9\-]+)\s+([0-9]+)\s+([a-zA-Z0-9\(\)\s,#]+)/;var Style=Base.derive({},{bind:function(ctx){var styles=_styles;var styleAlias=_styleAlias;for(var alias in styleAlias){if(this.hasOwnProperty(alias)){var name=styleAlias[alias];var value=this[alias];if(alias=="shadow"){var res=shadowSyntaxRegex.exec(trim(value));if(!res)continue;value=res.slice(1);_.each(value,function(item,idx){if(name[idx]){ctx[name[idx]]=item}},this)}else{ctx[name]=value}}}_.each(styles,function(styleName){if(this.hasOwnProperty(styleName)){ctx[styleName]=this[styleName]}},this)}});function trim(str){return(str||"").replace(/^(\s|\u00A0)+|(\s|\u00A0)+$/g,"")}return Style});define("2d/node",["require","core/base","glmatrix","./style"],function(require){var Base=require("core/base");var glmatrix=require("glmatrix");var vec2=glmatrix.vec2;var mat2d=glmatrix.mat2d;var Style=require("./style");var Node=Base.derive(function(){return{__mouseover__:false,id:0,AABB:[vec2.fromValues(0,0),vec2.fromValues(0,0)],z:0,style:null,position:vec2.fromValues(0,0),rotation:0,scale:vec2.fromValues(1,1),_transform:mat2d.create(),_transformInverse:mat2d.create(),visible:true,children:{},intersectLineWidth:0,clip:false,fill:true,stroke:true,fixAA:true}},function(){this.__GUID__=genGUID()},{updateTransform:function(){var transform=this._transform;mat2d.identity(transform);if(this.scale)mat2d.scale(transform,transform,this.scale);if(this.rotation)mat2d.rotate(transform,transform,this.rotation);if(this.position)mat2d.translate(transform,transform,this.position);return transform},updateTransformInverse:function(){mat2d.invert(this._transformInverse,this._transformInverse)},intersectAABB:function(x,y){var AABB=this.AABB;return AABB[0][0]<x&&x<AABB[1][0]&&AABB[0][1]<y&&y<AABB[1][1]},add:function(elem){if(elem){this.children[elem.__GUID__]=elem;elem.parent=this}},remove:function(elem){this.children[elem.__GUID__]=null;elem.parent=null},draw:function(context){},render:function(context){var renderQueue=this._getSortedRenderQueue();context.save();if(this.style){if(!this.style instanceof Style){for(var name in this.style){this.style[name].bind(context)}}else{this.style.bind(context)}}var m=this.updateTransform();context.transform(m[0],m[1],m[2],m[3],m[4],m[5]);this.draw(context);this.clip&&context.clip();for(var i=0;i<renderQueue.length;i++){renderQueue[i].render(context)}context.restore()},traverse:function(callback){var stopTraverse=callback&&callback(this);if(!stopTraverse){var children=this.children;for(var i=0,len=children.length;i<len;i++){children[i].traverse(callback)}}},intersect:function(x,y,eventName){},_getSortedRenderQueue:function(){var renderQueue=[];for(var guid in this.children){renderQueue.push(this.children[guid])}renderQueue.sort(function(x,y){if(x.z===y.z)return x.__GUID__>y.__GUID__?1:-1;return x.z>y.z?1:-1});return renderQueue}});var genGUID=function(){var guid=0;return function(){return++guid}}();return Node});define("2d/util",["require"],function(require){return{fixPos:function(pos){return[pos[0]+.5,pos[1]+.5]},fixPosArray:function(poslist){var ret=[];var len=poslist.length;for(var i=0;i<len;i++){ret.push(this.fixPos(poslist[i]))}return ret},computeAABB:function(points){var left=points[0][0];var right=points[0][0];
var top=points[0][1];var bottom=points[0][1];for(var i=1;i<points.length;i++){left=points[i][0]<left?points[i][0]:left;right=points[i][0]>right?points[i][0]:right;top=points[i][1]<top?points[i][1]:top;bottom=points[i][1]>bottom?points[i][1]:bottom}return[[left,top],[right,bottom]]}}});define("2d/renderable/arc",["require","../node","../util","glmatrix"],function(require){var Node=require("../node");var util=require("../util");var glmatrix=require("glmatrix");var vec2=glmatrix.vec2;var Arc=Node.derive(function(){return{center:[0,0],radius:0,startAngle:0,endAngle:Math.PI*2,clockwise:true}},{computeAABB:function(){this.AABB=[[0,0],[0,0]]},draw:function(contex){var center=this.fixAA?util.fixPos(this.center):this.center;ctx.beginPath();ctx.arc(center[0],center[1],this.radius,this.startAngle,this.endAngle,!this.clockwise);if(this.stroke){ctx.stroke()}if(this.fill){ctx.fill()}},intersect:function(x,y){return false}});return Arc});define("2d/renderable/circle",["require","../node","../util","glmatrix"],function(require){var Node=require("../node");var util=require("../util");var glmatrix=require("glmatrix");var vec2=glmatrix.vec2;var Circle=Node.derive(function(){return{center:[0,0],radius:0}},{computeAABB:function(){this.AABB=[[this.center[0]-this.radius,this.center[1]-this.radius],[this.center[0]+this.radius,this.center[1]+this.radius]]},draw:function(ctx){var center=this.fixAA?util.fixPos(this.center):this.center;ctx.beginPath();ctx.arc(center[0],center[1],this.radius,0,2*Math.PI,false);if(this.stroke){ctx.stroke()}if(this.fill){ctx.fill()}},intersect:function(){return vec2.len([this.center[0]-x,this.center[1]-y])<this.radius}});return Circle});define("2d/renderable/image",["require","../node","../util","glmatrix"],function(require){var Node=require("../node");var util=require("../util");var glmatrix=require("glmatrix");var vec2=glmatrix.vec2;var _imageCache={};var Image=Node.derive(function(){return{img:"",start:[0,0],size:0,onload:function(){}}},function(){if(typeof this.img=="string"){var self=this;this.load(this.img,function(img){self.img=img;self.onload.call(self)})}},{computeAABB:function(){this.AABB=util.computeAABB([this.start,[this.start[0]+this.size[0],this.start[1]+this.size[1]]])},draw:function(ctx){var start=this.fixAA?util.fixPos(this.start):this.start;if(typeof this.img!="string"){this.size?ctx.drawImage(this.img,start[0],start[1],this.size[0],this.size[1]):ctx.drawImage(this.img,start[0],start[1])}},intersect:function(x,y){return this.intersectAABB(x,y)},load:function(src,callback){if(_imageCache[src]){var img=_imageCache[src];if(img.constructor==Array){img.push(callback)}else{callback(img)}}else{_imageCache[src]=[callback];var img=new Image;img.onload=function(){each(_imageCache[src],function(cb){cb(img)});_imageCache[src]=img};img.src=src}}});return Image});define("2d/renderable/line",["require","../node","../util","glmatrix"],function(require){var Node=require("../node");var util=require("../util");var glmatrix=require("glmatrix");var vec2=glmatrix.vec2;var Line=Node.derive(function(){return{start:[0,0],end:[0,0],width:0}},{computeAABB:function(){this.AABB=util.computeAABB([this.start,this.end]);if(this.AABB[0][0]==this.AABB[1][0]){this.AABB[0][0]-=this.width/2;this.AABB[1][0]+=this.width/2}if(this.AABB[0][1]==this.AABB[1][1]){this.AABB[0][1]-=this.width/2;this.AABB[1][1]+=this.width/2}},draw:function(ctx){var start=this.fixAA?util.fixPos(this.start):this.start,end=this.fixAA?util.fixPos(this.end):this.end;ctx.beginPath();ctx.moveTo(start[0],start[1]);ctx.lineTo(end[0],end[1]);ctx.stroke()},intersect:function(x,y){if(!this.intersectAABB(x,y)){return false}var a=[x,y];b=this.start,c=this.end,ba=vec2.sub([],a,b),bc=vec2.sub([],c,b);var dd=vec2.dot(bc,ba);vec2.normalize(bc,bc);var d=vec2.add(b,vec2.scale(bc,dd));var distance=vec2.length(vec2.sub(a,a,d));return distance<this.width/2}});return Line});define("2d/renderable/path",["require","../node","../util","glmatrix"],function(require){var Node=require("../node");var util=require("../util");var glmatrix=require("glmatrix");var vec2=glmatrix.vec2;var Path=Node.derive(function(){return{segments:[],globalStyle:true}},{computeAABB:function(){this.AABB=[[0,0],[0,0]]},draw:function(ctx){if(this.globalStyle){this.drawWithSameStyle(ctx)}else{this.drawWithDifferentStyle(ctx)}},drawWithSameStyle:function(ctx){var l=this.segments.length;var segs=this.segments;ctx.beginPath();ctx.moveTo(segs[0].point[0],segs[0].point[1]);for(var i=1;i<l;i++){if(segs[i-1].handleOut||segs[i].handleIn){var prevHandleOut=segs[i-1].handleOut||segs[i-1].point;var handleIn=segs[i].handleIn||segs[i].point;ctx.bezierCurveTo(prevHandleOut[0],prevHandleOut[1],handleIn[0],handleIn[1],segs[i].point[0],segs[i].point[1])}else{ctx.lineTo(segs[i].point[0],segs[i].point[1])}}if(this.fill){ctx.fill()}if(this.stroke){ctx.stroke()}},drawWithDifferentStyle:function(ctx){var l=this.segments.length;var segs=this.segments;for(var i=0;i<l-1;i++){ctx.save();segs[i].style&&segs[i].style.bind(ctx);ctx.beginPath();ctx.moveTo(segs[i].point[0],segs[i].point[1]);if(segs[i].handleOut||segs[i+1].handleIn){var handleOut=segs[i].handleOut||segs[i].point;var nextHandleIn=segs[i+1].handleIn||segs[i+1].point;ctx.bezierCurveTo(handleOut[0],handleOut[1],nextHandleIn[0],nextHandleIn[1],segs[i+1].point[0],segs[i+1].point[1])}else{ctx.lineTo(segs[i+1].point[0],segs[i+1].point[1])}if(this.stroke){ctx.stroke()}if(this.fill){ctx.fill()}ctx.restore()}},smooth:function(degree){var len=this.segments.length;var middlePoints=[];var segs=this.segments;function computeVector(a,b,c){var m=vec2.scale([],vec2.add([],b,c),.5);return vec2.sub([],a,m)}for(var i=0;i<len;i++){var point=segs[i].point;var nextPoint=i==len-1?segs[0].point:segs[i+1].point;middlePoints.push(vec2.scale([],vec2.add([],point,nextPoint),.5))}for(var i=0;i<len;i++){var point=segs[i].point;var middlePoint=middlePoints[i];var prevMiddlePoint=i==0?middlePoints[len-1]:middlePoints[i-1];var degree=segs[i].smoothLevel||degree||1;var middleMiddlePoint=vec2.scale([],vec2.add([],middlePoint,prevMiddlePoint),.5);var v1=vec2.sub([],middlePoint,middleMiddlePoint);var v2=vec2.sub([],prevMiddlePoint,middleMiddlePoint);var dv=computeVector(point,prevMiddlePoint,middlePoint);vec2.scale(v2,v2,degree);vec2.scale(v1,v1,degree);segs[i].handleIn=vec2.add([],vec2.add([],middleMiddlePoint,v2),dv);segs[i].handleOut=vec2.add([],vec2.add([],middleMiddlePoint,v1),dv)}segs[0].handleOut=segs[0].handleIn=null;segs[len-1].handleIn=segs[len-1].handleOut=null},pushPoints:function(points){for(var i=0;i<points.length;i++){this.segments.push({point:points[i],handleIn:null,handleOut:null})}}});return Path});define("2d/renderable/polygon",["require","../node","../util","glmatrix"],function(require){var Node=require("../node");var util=require("../util");var glmatrix=require("glmatrix");var vec2=glmatrix.vec2;var Polygon=Node.derive(function(){return{points:[]}},{computeAABB:function(){this.AABB=util.computeAABB(this.points)},draw:function(ctx){var points=this.fixAA?util.fixPosArray(this.points):this.points;ctx.beginPath();ctx.moveTo(points[0][0],points[0][1]);for(var i=1;i<points.length;i++){ctx.lineTo(points[i][0],points[i][1])}ctx.closePath();if(this.stroke){ctx.stroke()}if(this.fill){ctx.fill()}},intersect:function(x,y){if(!this.intersectAABB(x,y)){return false}var len=this.points.length;var angle=0;var points=this.points;var vec1,vec2,j,piece;for(var i=0;i<len;i++){vec1=vec2.normalize([],[points[i][0]-x,points[i][1]-y]);j=(i+1)%len;vec2=vec2.normalize([],[points[j][0]-x,points[j][1]-y]);piece=Math.acos(vec2.dot(vec1,vec2));angle+=piece}return Math.length(angle-2*Math.PI)<.001}});return Node});define("2d/renderable/rectangle",["require","../node","../util","glmatrix"],function(require){var Node=require("../node"),util=require("../util"),glmatrix=require("glmatrix"),vec2=glmatrix.vec2;var Rectangle=Node.derive(function(){return{start:[0,0],size:[0,0]}},{computeAABB:function(){var end=vec2.add([],this.start,this.size);this.AABB=util.computeAABB([this.start,end])},draw:function(ctx){var start=this.fixAA?util.fixPos(this.start):this.start;ctx.beginPath();ctx.rect(start[0],start[1],this.size[0],this.size[1]);if(this.stroke){ctx.stroke()}if(this.fill){ctx.fill()}},intersect:function(x,y){return this.intersectAABB(x,y)}});return Rectangle});define("2d/renderable/roundedrectangle",["require","../node","../util","glmatrix"],function(require){var Node=require("../node");var util=require("../util");var glmatrix=require("glmatrix");var vec2=glmatrix.vec2;var RoundedRectange=Node.derive(function(){return{start:[0,0],size:[0,0],radius:0}},{computeAABB:function(){var end=vec2.add([],this.start,this.size);this.AABB=util.computeAABB([this.start,end])},draw:function(ctx){if(this.radius.constructor==Number){var radius=[this.radius,this.radius,this.radius,this.radius]}else if(this.radius.length==2){var radius=[this.radius[0],this.radius[1],this.radius[0],this.radius[1]]}else{var radius=this.radius}var start=this.fixAA?util.fixPos(this.start):this.start;var size=this.size;var v1=vec2.add([],start,[radius[0],0]);var v2=vec2.add([],start,[size[0],0]);var v3=vec2.add([],start,size);var v4=vec2.add([],start,[0,size[1]]);ctx.beginPath();ctx.moveTo(v1[0],v1[1]);radius[1]?ctx.arcTo(v2[0],v2[1],v3[0],v3[1],radius[1]):ctx.lineTo(v2[0],v2[1]);radius[2]?ctx.arcTo(v3[0],v3[1],v4[0],v4[1],radius[2]):ctx.lineTo(v3[0],v3[1]);radius[3]?ctx.arcTo(v4[0],v4[1],start[0],start[1],radius[3]):ctx.lineTo(v4[0],v4[1]);radius[0]?ctx.arcTo(start[0],start[1],v2[0],v2[1],radius[0]):ctx.lineTo(start[0],start[1]);if(this.stroke){ctx.stroke()}if(this.fill){ctx.fill()}},intersect:function(x,y){return false}});return RoundedRectange});define("2d/renderable/sector",["require","../node","../util","glmatrix"],function(require){var Node=require("../node");var util=require("../util");var glmatrix=require("glmatrix");var vec2=glmatrix.vec2;var Sector=Node.derive(function(){return{center:[0,0],innerRadius:0,outerRadius:0,startAngle:0,endAngle:0,clockwise:true}},{computeAABB:function(){this.AABB=[0,0]},intersect:function(x,y){var startAngle=this.startAngle;var endAngle=this.endAngle;var r1=this.innerRadius;var r2=this.outerRadius;var c=this.center;var v=vec2.sub([],[x,y],c);var r=vec2.length(v);var pi2=Math.PI*2;if(r<r1||r>r2){return false}var angle=Math.atan2(v[1],v[0]);if(angle<0){angle=angle+pi2}if(this.clockwise){return angle<endAngle&&angle>startAngle}else{startAngle=pi2-startAngle;endAngle=pi2-endAngle;return angle>endAngle&&angle<startAngle}},draw:function(ctx){var startAngle=this.startAngle;var endAngle=this.endAngle;var r1=this.innerRadius;var r2=this.outerRadius;var c=this.fixAA?util.fixPos(this.center):this.center;if(!this.clockwise){startAngle=Math.PI*2-startAngle;endAngle=Math.PI*2-endAngle}var startInner=vec2.add([],c,[r1*Math.cos(startAngle),r1*Math.sin(startAngle)]);var startOuter=vec2.add([],c,[r2*Math.cos(startAngle),r2*Math.sin(startAngle)]);var endInner=vec2.add([],c,[r1*Math.cos(endAngle),r1*Math.sin(endAngle)]);var endOuter=vec2.add([],c,[r2*Math.cos(endAngle),r2*Math.sin(endAngle)]);ctx.beginPath();ctx.moveTo(startInner[0],startInner[1]);ctx.lineTo(startOuter[0],startOuter[1]);ctx.arc(c[0],c[1],r2,startAngle,endAngle,!this.clockwise);ctx.lineTo(endInner[0],endInner[1]);ctx.arc(c[0],c[1],r1,endAngle,startAngle,this.clockwise);ctx.endPath();if(this.stroke){ctx.stroke()}if(this.fill){ctx.fill()}}});return Sector});define("2d/renderable/text",["require","../node","../util","glmatrix"],function(require){var Node=require("../node");var util=require("../util");var glmatrix=require("glmatrix");var vec2=glmatrix.vec2;var Text=Node.derive(function(){return{text:"",start:[0,0],size:[0,0],font:"",textAlign:"",textBaseline:""}},{computeAABB:function(){this.AABB=util.computeAABB([this.start,[this.start[0]+this.size[0],this.start[1]+this.size[1]]])},draw:function(ctx){var start=this.fixAA?util.fixPos(this.start):this.start;if(this.font){ctx.font=this.font}if(this.textAlign){ctx.textAlign=this.textAlign}if(this.textBaseline){ctx.textBaseline=this.textBaseline}if(this.fill){this.size.length&&this.size[0]?ctx.fillText(this.text,start[0],start[1],this.size[0]):ctx.fillText(this.text,start[0],start[1])}if(this.stroke){this.size.length&&this.size[0]?ctx.strokeText(this.text,start[0],start[1],this.size[0]):ctx.strokeText(this.text,start[0],start[1])}},resize:function(ctx){if(!this.size[0]||this.needResize){this.size[0]=ctx.measureText(this.text).width;this.size[1]=ctx.measureText("m").width}},intersect:function(x,y){return this.intersectAABB(x,y)}});return Text});define("2d/renderable/textbox",["require","../node","../util","glmatrix","./text","_"],function(require){var Node=require("../node");var util=require("../util");var glmatrix=require("glmatrix");var vec2=glmatrix.vec2;var Text=require("./text");var _=require("_");var TextBox=Node.derive(function(){return{text:"",textAlign:"",textBaseline:"top",font:"",start:[0,0],width:0,wordWrap:false,wordBreak:false,lineHeight:0,stroke:false,_texts:[]}},function(){this._oldText=""},{computeAABB:function(){},draw:function(ctx){if(this.text!=this._oldText){this._oldText=this.text;if(this.font){ctx.font=this.font}if(this.wordBreak){this._texts=this.computeWordBreak(ctx)}else if(this.wordWrap){this._texts=this.computeWordWrap(ctx)}else{var txt=new Text({text:this.text,textBaseline:this.textBaseline});this.extendCommonProperties(txt);this._texts=[txt]}}_.each(this._texts,function(_text){_text.draw(ctx)})},computeWordWrap:function(ctx){if(!this.text){return}var words=this.text.split(" ");var len=words.length;var lineWidth=0;var wordWidth;var wordText;var texts=[];var txt;for(var i=0;i<len;i++){wordText=i==len-1?words[i]:words[i]+" ";wordWidth=ctx.measureText(wordText).width;if(lineWidth+wordWidth>this.width||!txt){txt=new Text({text:wordText,start:vec2.add([],this.start,[0,this.lineHeight*texts.length])});this.extendCommonProperties(txt);texts.push(txt);lineWidth=wordWidth}else{lineWidth+=wordWidth;txt.text+=wordText}}return texts},computeWordBreak:function(ctx){if(!this.text){return}var len=this.text.length;var letterWidth;var letter;var lineWidth=ctx.measureText(this.text[0]).width;var texts=[];var txt;for(var i=0;i<len;i++){letter=this.text[i];letterWidth=ctx.measureText(letter).width;if(lineWidth+letterWidth>this.width||!txt){var txt=new Text({text:letter,start:vec2.add([],this.start,[0,this.lineHeight*texts.length])});this.extendCommonProperties(txt);texts.push(txt);lineWidth=letterWidth}else{lineWidth+=letterWidth;txt.text+=letter}}return texts},extendCommonProperties:function(txt){var props={};_.extend(txt,{textAlign:this.textAlign,textBaseline:this.textBaseline,style:this.style,font:this.font,fill:this.fill,stroke:this.stroke})},intersect:function(x,y){}});return TextBox});define("2d/renderer",["require","core/base"],function(require){var Base=require("core/base");var Renderer=Base.derive(function(){return{canvas:null,context:null,width:0,height:0,_latestRenderedScene:null}},function(){if(!this.canvas){this.canvas=document.createElement("canvas")}this.canvas.addEventListener("click",this._clickHandler.bind(this));this.canvas.addEventListener("mousedown",this._mouseDownHandler.bind(this));this.canvas.addEventListener("mouseup",this._mouseUpHandler.bind(this));this.canvas.addEventListener("mousemove",this._mouseMoveHandler.bind(this));this.canvas.addEventListener("mouseout",this._mouseOutHandler.bind(this));if(this.width){this.canvas.width=this.width}else{this.width=this.canvas.width}if(this.height){this.canvas.height=this.height}else{this.height=this.canvas.height}this.context=this.canvas.getContext("2d")},{resize:function(width,height){this.canvas.width=width;this.canvas.height=height},render:function(scene){this.context.clearRect(0,0,this.width,this.height);scene.render(this.context);this._latestRenderedScene=scene},_clickHandler:function(){var scene=this._latestRenderedScene},_mouseDownHandler:function(){},_mouseUpHandler:function(){},_mouseMoveHandler:function(){},_mouseOutHandler:function(){}});return Renderer});define("2d/scene",["require","./node"],function(require){var Node=require("./node");var Scene=Node.derive(function(){return{}},{});return Scene});define("core/vector3",["require","glmatrix"],function(require){var glMatrix=require("glmatrix");var vec3=glMatrix.vec3;var Vector3=function(x,y,z){x=x||0;y=y||0;z=z||0;return Object.create(Vector3Proto,{x:{configurable:false,set:function(value){this._array[0]=value;this._dirty=true},get:function(){return this._array[0]}},y:{configurable:false,set:function(value){this._array[1]=value;this._dirty=true},get:function(){return this._array[1]}},z:{configurable:false,set:function(value){this._array[2]=value;this._dirty=true},get:function(){return this._array[2]}},_array:{writable:false,configurable:false,value:vec3.fromValues(x,y,z)},_dirty:{configurable:false,value:true}})};var Vector3Proto={constructor:Vector3,add:function(b){vec3.add(this._array,this._array,b._array);this._dirty=true;return this},set:function(x,y,z){this._array[0]=x;this._array[1]=y;this._array[2]=z;this._dirty=true;return this},clone:function(){return new Vector3(this.x,this.y,this.z)},copy:function(b){vec3.copy(this._array,b._array);this._dirty=true;return this},cross:function(out,b){vec3.cross(out._array,this._array,b._array);return this},dist:function(b){return vec3.dist(this._array,b._array)},distance:function(b){return vec3.distance(this._array,b._array)},div:function(b){vec3.div(this._array,this._array,b._array);this._dirty=true;return this},divide:function(b){vec3.divide(this._array,this._array,b._array);this._dirty=true;return this},dot:function(b){return vec3.dot(this._array,b._array)},len:function(){return vec3.len(this._array)},length:function(){return vec3.length(this._array)},lerp:function(a,b,t){vec3.lerp(this._array,a._array,b._array,t);this._dirty=true;return this},mul:function(b){vec3.mul(this._array,this._array,b._array);this._dirty=true;return this},multiply:function(b){vec3.multiply(this._array,this._array,b._array);this._dirty=true;return this},negate:function(){vec3.negate(this._array,this._array);this._dirty=true;return this},normalize:function(){vec3.normalize(this._array,this._array);this._dirty=true;return this},random:function(scale){vec3.random(this._array,scale);this._dirty=true;return this},scale:function(s){vec3.scale(this._array,this._array,s);this._dirty=true;return this},scaleAndAdd:function(b,s){vec3.scaleAndAdd(this._array,this._array,b._array,s);this._dirty=true;return this},sqrDist:function(b){return vec3.sqrDist(this._array,b._array)},squaredDistance:function(b){return vec3.squaredDistance(this._array,b._array)},sqrLen:function(){return vec3.sqrLen(this._array)},squaredLength:function(){return vec3.squaredLength(this._array)},sub:function(b){vec3.sub(this._array,this._array,b._array);this._dirty=true;return this},subtract:function(b){vec3.subtract(this._array,this._array,b._array);this._dirty=true;return this},transformMat3:function(m){vec3.transformMat3(this._array,this._array,m._array);this._dirty=true;return this},transformMat4:function(m){vec3.transformMat4(this._array,this._array,m._array);this._dirty=true;return this},transformQuat:function(q){vec3.transformQuat(this._array,this._array,q._array);this._dirty=true;return this},setEulerFromQuaternion:function(q){},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}};function clamp(x){return Math.min(Math.max(x,-1),1)}return Vector3});define("core/quaternion",["require","glmatrix"],function(require){var glMatrix=require("glmatrix");var quat=glMatrix.quat;var Quaternion=function(x,y,z,w){x=x||0;y=y||0;z=z||0;w=typeof w==="undefined"?1:w;return Object.create(QuaternionProto,{x:{configurable:false,set:function(value){this._array[0]=value;this._dirty=true},get:function(){return this._array[0]}},y:{configurable:false,set:function(value){this._array[1]=value;this._dirty=true},get:function(){return this._array[1]}},z:{configurable:false,set:function(value){this._array[2]=value;this._dirty=true},get:function(){return this._array[2]}},w:{configurable:false,set:function(value){this._array[2]=value;this._dirty=true},get:function(){return this._array[2]}},_array:{writable:false,configurable:false,value:quat.fromValues(x,y,z,w)},_dirty:{configurable:false,value:false}})};var QuaternionProto={constructor:Quaternion,add:function(b){quat.add(this._array,this._array,b._array);this._dirty=true;return this},calculateW:function(){quat.calculateW(this._array,this._array);this._dirty=true;return this},set:function(x,y,z,w){this._array[0]=x;this._array[1]=y;this._array[2]=z;this._array[3]=w;this._dirty=true;return this},clone:function(){return new Quaternion(this.x,this.y,this.z,this.w)},conjugate:function(){quat.conjugate(this._array,this._array);this._dirty=true;return this},copy:function(b){quat.copy(this._array,b._array);this._dirty=true;return this},dot:function(b){return quat.dot(this._array,b._array)},fromMat3:function(m){quat.fromMat3(this._array,m._array);this._dirty=true;return this},fromMat4:function(){var mat3=glMatrix.mat3;var m3=mat3.create();return function(m){mat3.fromMat4(m3,m._array);mat3.transpose(m3,m3);quat.fromMat3(this._array,m3);this._dirty=true;return this}}(),identity:function(){quat.identity(this._array);this._dirty=true;return this},invert:function(){quat.invert(this._array,this._array);this._dirty=true;return this},len:function(){return quat.len(this._array)},length:function(){return quat.length(this._array)},lerp:function(a,b,t){quat.lerp(this._array,a._array,b._array,t);this._dirty=true;return this},mul:function(b){quat.mul(this._array,this._array,b._array);this._dirty=true;return this},multiply:function(b){quat.multiply(this._array,this._array,b._array);this._dirty=true;return this},normalize:function(){quat.normalize(this._array,this._array);this._dirty=true;return this},rotateX:function(rad){quat.rotateX(this._array,this._array,rad);this._dirty=true;return this},rotateY:function(rad){quat.rotateY(this._array,this._array,rad);this._dirty=true;return this},rotateZ:function(rad){quat.rotateZ(this._array,this._array,rad);this._dirty=true;return this},setAxisAngle:function(axis,rad){quat.setAxisAngle(this._array,axis._array,rad);this._dirty=true;return this},slerp:function(a,b,t){quat.slerp(this._array,a._array,b._array,t);this._dirty=true;return this},sqrLen:function(){return quat.sqrLen(this._array)},squaredLength:function(){return quat.squaredLength(this._array)},setFromEuler:function(v){},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}};return Quaternion});define("core/matrix4",["require","glmatrix","./vector3"],function(require){var glMatrix=require("glmatrix");var Vector3=require("./vector3");var mat4=glMatrix.mat4;var vec3=glMatrix.vec3;var mat3=glMatrix.mat3;var quat=glMatrix.quat;function makeProperty(n){return{configurable:false,set:function(value){this._array[n]=value;this._dirty=true},get:function(){return this._array[n]}}}var Matrix4=function(){var axisX=new Vector3,axisY=new Vector3,axisZ=new Vector3;return Object.create(Matrix4Proto,{m00:makeProperty(0),m01:makeProperty(1),m02:makeProperty(2),m03:makeProperty(3),m10:makeProperty(4),m11:makeProperty(5),m12:makeProperty(6),m13:makeProperty(7),m20:makeProperty(8),m21:makeProperty(9),m22:makeProperty(10),m23:makeProperty(11),m30:makeProperty(12),m31:makeProperty(13),m32:makeProperty(14),m33:makeProperty(15),forward:{configurable:false,get:function(){var el=this._array;axisZ.set(el[8],el[9],el[10]);return axisZ},set:function(v){var el=this._array,v=v._array;el[8]=v[8];el[9]=v[9];el[10]=v[10]}},up:{configurable:false,enumerable:true,get:function(){var el=this._array;axisY.set(el[4],el[5],el[6]);return axisY},set:function(v){var el=this._array,v=v._array;el[4]=v[4];el[5]=v[5];el[6]=v[6]}},right:{configurable:false,get:function(){var el=this._array;axisX.set(el[0],el[1],el[2]);return axisX},set:function(v){var el=this._array,v=v._array;el[0]=v[0];el[1]=v[1];el[2]=v[2]}},_array:{writable:false,configurable:false,value:mat4.create()}})};var Matrix4Proto={constructor:Matrix4,adjoint:function(){mat4.adjoint(this._array,this._array);return this},clone:function(){return(new Matrix4).copy(this)},copy:function(b){mat4.copy(this._array,b._array);return this},determinant:function(){return mat4.determinant(this._array)},fromQuat:function(q){mat4.fromQuat(this._array,q._array);return this},fromRotationTranslation:function(q,v){mat4.fromRotationTranslation(this._array,q._array,v._array);return this},frustum:function(left,right,bottom,top,near,far){mat4.frustum(this._array,left,right,bottom,top,near,far);return this},identity:function(){mat4.identity(this._array);return this},invert:function(){mat4.invert(this._array,this._array);return this},lookAt:function(eye,center,up){mat4.lookAt(this._array,eye._array,center._array,up._array);return this},mul:function(b){mat4.mul(this._array,this._array,b._array);return this},mulLeft:function(b){mat4.mul(this._array,b._array,this._array);return this},multiply:function(b){mat4.multiply(this._array,this._array,b._array);return this},multiplyLeft:function(b){mat4.multiply(this._array,b._array,this._array);return this},ortho:function(left,right,bottom,top,near,far){mat4.ortho(this._array,left,right,bottom,top,near,far);return this},perspective:function(fovy,aspect,near,far){mat4.perspective(this._array,fovy,aspect,near,far);return this},rotate:function(rad,axis){mat4.rotate(this._array,this._array,rad,axis._array);return this},rotateX:function(rad){mat4.rotateX(this._array,this._array,rad);return this},rotateY:function(rad){mat4.rotateY(this._array,this._array,rad);return this},rotateZ:function(rad){mat4.rotateZ(this._array,this._array,rad);return this},scale:function(v){mat4.scale(this._array,this._array,v._array);return this},translate:function(v){mat4.translate(this._array,this._array,v._array);return this},transpose:function(){mat4.transpose(this._array,this._array);return this},rotateAround:function(point,axis,angle){console.warn("TODO")},decomposeMatrix:function(){var x=vec3.create();var y=vec3.create();var z=vec3.create();var m3=mat3.create();return function(scale,rotation,position){var el=this._array;vec3.set(x,el[0],el[1],el[2]);vec3.set(y,el[4],el[5],el[6]);vec3.set(z,el[8],el[9],el[10]);scale.x=vec3.length(x);scale.y=vec3.length(y);scale.z=vec3.length(z);position.set(el[12],el[13],el[14]);mat3.fromMat4(m3,el);mat3.transpose(m3,m3);m3[0]/=scale.x;m3[1]/=scale.x;m3[2]/=scale.x;m3[3]/=scale.y;m3[4]/=scale.y;m3[5]/=scale.y;m3[6]/=scale.z;m3[7]/=scale.z;m3[8]/=scale.z;quat.fromMat3(rotation._array,m3);rotation.normalize()}}(),toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}};return Matrix4});define("core/matrix3",["require","glmatrix"],function(require){var glMatrix=require("glmatrix");var mat3=glMatrix.mat3;function makeProperty(n){return{configurable:false,set:function(value){this._array[n]=value;this._dirty=true},get:function(){return this._array[n]}}}var Matrix3=function(){return Object.create(Matrix3Proto,{m00:makeProperty(0),m01:makeProperty(1),m02:makeProperty(2),m10:makeProperty(3),m11:makeProperty(4),m12:makeProperty(5),m20:makeProperty(6),m21:makeProperty(7),m22:makeProperty(8),_array:{writable:false,configurable:false,value:mat3.create()}})};var Matrix3Proto={constructor:Matrix3,adjoint:function(){mat3.adjoint(this._array,this._array);return this},clone:function(){return(new Matrix3).copy(this)},copy:function(b){mat3.copy(this._array,b._array);return this},determinant:function(){return mat3.determinant(this._array)},fromMat2d:function(a){return mat3.fromMat2d(this._array,a._array)},fromMat4:function(a){return mat3.fromMat4(this._array,a._array)},fromQuat:function(q){mat3.fromQuat(this._array,q._array);return this},identity:function(){mat3.identity(this._array);return this},invert:function(){mat3.invert(this._array,this._array);return this},mul:function(b){mat3.mul(this._array,this._array,b._array);return this},mulLeft:function(b){mat3.mul(this._array,b._array,this._array);return this},multiply:function(b){mat3.multiply(this._array,this._array,b._array);return this},multiplyLeft:function(b){mat3.multiply(this._array,b._array,this._array);return this},normalFromMat4:function(a){mat3.normalFromMat4(this._array,a._array);return a},transpose:function(){mat3.transpose(this._array,this._array);return this},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}};return Matrix3});define("util/util",["require"],function(require){return{genGUID:function(){var guid=0;return function(){return++guid}}()}});define("3d/node",["require","core/base","core/vector3","core/quaternion","core/matrix4","core/matrix3","util/util","_"],function(require){var Base=require("core/base");var Vector3=require("core/vector3");var Quaternion=require("core/quaternion");var Matrix4=require("core/matrix4");var Matrix3=require("core/matrix3");var util=require("util/util");var _=require("_");var Node=Base.derive(function(){var id=util.genGUID();return{__GUID__:id,name:"NODE_"+id,visible:true,position:new Vector3,rotation:new Quaternion,scale:new Vector3(1,1,1),eulerAngle:new Vector3,useEuler:false,children:[],parent:null,worldMatrix:new Matrix4,matrix:new Matrix4}},{add:function(node){if(this.children.indexOf(node)>=0){return}this.children.push(node);node.parent=this},remove:function(node){_.without(this.children,node);node.parent=null},traverse:function(callback){var stopTraverse=callback&&callback(this);if(!stopTraverse){var children=this.children;for(var i=0,len=children.length;i<len;i++){children[i].traverse(callback)}}},updateMatrix:function(){if(!this.position._dirty&&!this.scale._dirty){if(this.useEuler&&!this.eulerAngle._dirty){return}else if(!this.rotation._dirty){return}}var m=this.matrix;m.identity();if(this.useEuler){this.rotation.identity();this.rotation.rotateX(this.eulerAngle.x);this.rotation.rotateY(this.eulerAngle.y);this.rotation.rotateZ(this.eulerAngle.z)}m.fromRotationTranslation(this.rotation,this.position);m.scale(this.scale);this.rotation._dirty=false;this.scale._dirty=false;this.position._dirty=false;this.eulerAngle._dirty=false},decomposeMatrix:function(){this.matrix.decomposeMatrix(this.scale,this.rotation,this.position);if(!this.useEuler){this.eulerAngle.setEulerFromQuaternion(this.rotation)}this.rotation._dirty=false;this.scale._dirty=false;this.position._dirty=false;this.eulerAngle._dirty=false},updateWorldMatrix:function(){this.updateMatrix();if(this.parent){this.worldMatrix.copy(this.parent.worldMatrix).multiply(this.matrix)}else{this.worldMatrix.copy(this.matrix)}},update:function(_gl,silent){if(!silent){this.trigger("beforeupdate",_gl)}this.updateWorldMatrix();if(!silent){this.trigger("afterupdate",_gl)}for(var i=0;i<this.children.length;i++){var child=this.children[i];if(child.visible){child.update(_gl)}}},getWorldPosition:function(){var m=this.worldMatrix._array;return new Vector3(m[12],m[13],m[14])},translate:function(v){this.updateMatrix();this.translate(v);this.decomposeMatrix()},rotate:function(angle,axis){this.updateMatrix();this.matrix.rotate(angle,axis);this.decomposeMatrix()},rotateAround:function(){var v=new Vector3;var RTMatrix=new Matrix4;return function(point,axis,angle){v.copy(this.position).subtract(point);this.matrix.identity();this.matrix.translate(point);this.matrix.rotate(angle,axis);if(this.useEuler){this.rotation.identity();this.rotation.rotateX(this.eulerAngle.x);this.rotation.rotateY(this.eulerAngle.y);this.rotation.rotateZ(this.eulerAngle.z)}RTMatrix.fromRotationTranslation(this.rotation,v);this.matrix.multiply(RTMatrix);this.matrix.scale(this.scale);this.decomposeMatrix()}}(),lookAt:function(){var m=new Matrix4;var scaleVector=new Vector3;return function(target,up){m.lookAt(this.position,target,up||this.matrix.up).invert();m.decomposeMatrix(scaleVector,this.rotation,this.position)}}()});return Node});define("3d/camera",["require","./node","core/matrix4"],function(require){var Node=require("./node");var Matrix4=require("core/matrix4");var Camera=Node.derive(function(){return{projectionMatrix:new Matrix4}
},function(){this.update()},{update:function(_gl){Node.prototype.update.call(this,_gl);this.updateProjectionMatrix()}});return Camera});define("3d/camera/orthographic",["require","../camera"],function(require){var Camera=require("../camera");var Orthographic=Camera.derive(function(){return{left:-1,right:1,near:0,far:1,top:1,bottom:-1}},{updateProjectionMatrix:function(){this.projectionMatrix.ortho(this.left,this.right,this.bottom,this.top,this.near,this.far)}});return Orthographic});define("3d/compositor/graph/graph",["require","core/base","_"],function(require){var Base=require("core/base");var _=require("_");var Graph=Base.derive(function(){return{nodes:[]}},{add:function(node){this.nodes.push(node);this.dirty("graph")},remove:function(node){_.without(this.nodes,node);this.dirty("graph")},update:function(){for(var i=0;i<this.nodes.length;i++){this.nodes[i].clear()}for(var i=0;i<this.nodes.length;i++){var node=this.nodes[i];if(!node.inputs){continue}for(var inputName in node.inputs){var fromPinInfo=node.inputs[inputName];var fromPin=this.findPin(fromPinInfo);if(fromPin){node.link(inputName,fromPin.node,fromPin.pin)}else{console.warn("Pin of "+fromPinInfo.node+"."+fromPinInfo.pin+" not exist")}}}},findPin:function(info){var node;if(typeof info.node==="string"){for(var i=0;i<this.nodes.length;i++){var tmp=this.nodes[i];if(tmp.name===info.node){node=tmp}}}else{node=info.node}if(node){if(node.outputs[info.pin]){return{node:node,pin:info.pin}}}},fromJSON:function(json){}});return Graph});define("3d/compositor",["require","./compositor/graph/graph"],function(require){var Graph=require("./compositor/graph/graph");var Compositor=Graph.derive(function(){return{}},{render:function(renderer){if(this.isDirty("graph")){this.update();this.fresh("graph")}var finaNode;for(var i=0;i<this.nodes.length;i++){var node=this.nodes[i];if(!node.outputs){node.render(renderer)}node.updateReference()}}});return Compositor});define("3d/scene",["require","./node"],function(require){var Node=require("./node");var Scene=Node.derive(function(){return{material:null,lightNumber:{},lightUniforms:{},filter:null}},{});return Scene});define("3d/geometry",["require","core/base","util/util","glmatrix","_"],function(require){var Base=require("core/base");var util=require("util/util");var glMatrix=require("glmatrix");var vec3=glMatrix.vec3;var vec2=glMatrix.vec2;var mat2=glMatrix.mat2;var mat4=glMatrix.mat4;var _=require("_");var arrSlice=Array.prototype.slice;var Geometry=Base.derive(function(){return{__GUID__:util.genGUID(),attributes:{position:{type:"float",semantic:"POSITION",size:3,value:[]},texcoord0:{type:"float",semantic:"TEXCOORD_0",size:2,value:[]},texcoord1:{type:"float",semantic:"TEXCOORD_1",size:2,value:[]},normal:{type:"float",semantic:"NORMAL",size:3,value:[]},tangent:{type:"float",semantic:"TANGENT",size:4,value:[]},color:{type:"ubyte",semantic:"COLOR",size:3,value:[]},barycentric:{type:"float",size:3,value:[]},boneWeight:{type:"float",size:3,value:[]},boneIndex:{type:"float",size:4,value:[]}},useFaces:true,faces:[],hint:"STATIC_DRAW",chunkSize:65535,_enabledAttributes:null,_verticesNumber:0,_normalType:"vertex",_arrayChunks:[],_verticesReorganizedMap:[],_reorganizedFaces:[]}},{dirty:function(field){if(!field){this.dirty("indices");for(var name in this.attributes){this.dirty(name)}return}for(var contextId in this.cache._caches){this.cache._caches[contextId]["dirty_"+field]=true}this._enabledAttributes=null},getVerticesNumber:function(){this._verticesNumber=this.attributes.position.value.length;return this._verticesNumber},getEnabledAttributes:function(){if(this._enabledAttributes){return this._enabledAttributes}var result={};var verticesNumber=this.getVerticesNumber();for(var name in this.attributes){var attrib=this.attributes[name];if(attrib.value&&attrib.value.length){if(attrib.value.length===verticesNumber){result[name]=attrib}}}this._enabledAttributes=result;return result},getDirtyAttributes:function(){var result={};var attributes=this.getEnabledAttributes();var noDirtyAttributes=true;for(var name in attributes){var attrib=attributes[name];if(this.cache.get("dirty_"+name)||this.cache.miss("dirty_"+name)){result[name]=attributes[name];noDirtyAttributes=false}}if(!noDirtyAttributes){return result}},getChunkNumber:function(){return this._arrayChunks.length},getBufferChunks:function(_gl){this.cache.use(_gl.__GUID__);var isDirty=this.cache.getContext();var dirtyAttributes=this.getDirtyAttributes();var isFacesDirty=this.cache.get("dirty_faces")||this.cache.miss("dirty_faces");if(dirtyAttributes){this._updateAttributesAndIndicesArrays(dirtyAttributes,isFacesDirty);this._updateBuffer(_gl,dirtyAttributes,isFacesDirty);for(var name in dirtyAttributes){isDirty["dirty_"+name]=false}}return this.cache.get("chunks")},_updateAttributesAndIndicesArrays:function(attributes,isFacesDirty){var self=this,cursors={},verticesNumber=this.getVerticesNumber();var verticesReorganizedMap=this._verticesReorganizedMap;var ArrayConstructors={};for(var name in attributes){switch(type){case"byte":ArrayConstructors[name]=Int8Array;break;case"ubyte":ArrayConstructors[name]=Uint8Array;break;case"short":ArrayConstructors[name]=Int16Array;break;case"ushort":ArrayConstructors[name]=Uint16Array;break;default:ArrayConstructors[name]=Float32Array;break}cursors[name]=0}var newChunk=function(chunkIdx){if(self._arrayChunks[chunkIdx]){return self._arrayChunks[chunkIdx]}var chunk={attributeArrays:{},indicesArray:null};for(var name in attributes){chunk.attributeArrays[name]=null}for(var name in cursors){cursors[name]=0}for(var i=0;i<verticesNumber;i++){verticesReorganizedMap[i]=-1}self._arrayChunks.push(chunk);return chunk};var attribNameList=Object.keys(attributes);if(verticesNumber>this.chunkSize&&this.useFaces){var vertexCursor=0,chunkIdx=0,currentChunk;var chunkFaceStart=[0];var vertexUseCount=[];for(i=0;i<verticesNumber;i++){vertexUseCount[i]=-1;verticesReorganizedMap[i]=-1}if(isFacesDirty){if(this._reorganizedFaces.length!==this.faces.length){for(i=0;i<this.faces.length;i++){this._reorganizedFaces[i]=[0,0,0]}}}currentChunk=newChunk(chunkIdx);for(var i=0;i<this.faces.length;i++){var face=this.faces[i];var reorganizedFace=this._reorganizedFaces[i];var i1=face[0],i2=face[1],i3=face[2];if(vertexCursor+3>this.chunkSize){chunkIdx++;chunkFaceStart[chunkIdx]=i;vertexCursor=0;currentChunk=newChunk(chunkIdx)}var newI1=verticesReorganizedMap[i1]===-1;var newI2=verticesReorganizedMap[i2]===-1;var newI3=verticesReorganizedMap[i3]===-1;for(var k=0;k<attribNameList.length;k++){var name=attribNameList[k],attribArray=currentChunk.attributeArrays[name],values=attributes[name].value,size=attributes[name].size;if(!attribArray){attribArray=currentChunk.attributeArrays[name]=[]}if(size===1){if(newI1){attribArray[cursors[name]++]=values[i1]}if(newI2){attribArray[cursors[name]++]=values[i2]}if(newI3){attribArray[cursors[name]++]=values[i3]}}else{if(newI1){for(var j=0;j<size;j++){attribArray[cursors[name]++]=values[i1][j]}}if(newI2){for(var j=0;j<size;j++){attribArray[cursors[name]++]=values[i2][j]}}if(newI3){for(var j=0;j<size;j++){attribArray[cursors[name]++]=values[i3][j]}}}}if(newI1){verticesReorganizedMap[i1]=vertexCursor;reorganizedFace[0]=vertexCursor;vertexCursor++}else{reorganizedFace[0]=verticesReorganizedMap[i1]}if(newI2){verticesReorganizedMap[i2]=vertexCursor;reorganizedFace[1]=vertexCursor;vertexCursor++}else{reorganizedFace[1]=verticesReorganizedMap[i2]}if(newI3){verticesReorganizedMap[i3]=vertexCursor;reorganizedFace[2]=vertexCursor;vertexCursor++}else{reorganizedFace[2]=verticesReorganizedMap[i3]}}for(var c=0;c<this._arrayChunks.length;c++){var chunk=this._arrayChunks[c];for(var name in chunk.attributeArrays){var array=chunk.attributeArrays[name];if(array instanceof Array){chunk.attributeArrays[name]=new ArrayConstructors[name](array)}}}if(isFacesDirty){var chunkStart,chunkEnd,cursor,chunk;for(var c=0;c<this._arrayChunks.length;c++){chunkStart=chunkFaceStart[c];chunkEnd=chunkFaceStart[c+1]||this.faces.length;cursor=0;chunk=this._arrayChunks[c];var indicesArray=chunk.indicesArray;if(!indicesArray){indicesArray=chunk.indicesArray=new Uint16Array((chunkEnd-chunkStart)*3)}for(var i=chunkStart;i<chunkEnd;i++){indicesArray[cursor++]=this._reorganizedFaces[i][0];indicesArray[cursor++]=this._reorganizedFaces[i][1];indicesArray[cursor++]=this._reorganizedFaces[i][2]}}}}else{var chunk=newChunk(0);if(this.useFaces){var indicesArray=chunk.indicesArray;if(!indicesArray){indicesArray=chunk.indicesArray=new Uint16Array(this.faces.length*3)}var cursor=0;for(var i=0;i<this.faces.length;i++){indicesArray[cursor++]=this.faces[i][0];indicesArray[cursor++]=this.faces[i][1];indicesArray[cursor++]=this.faces[i][2]}}for(var name in attributes){var values=attributes[name].value,type=attributes[name].type,size=attributes[name].size,attribArray=chunk.attributeArrays[name];if(!attribArray){attribArray=chunk.attributeArrays[name]=new ArrayConstructors[name](verticesNumber*size)}if(size===1){for(var i=0;i<values.length;i++){attribArray[i]=values[i]}}else{var cursor=0;for(var i=0;i<values.length;i++){for(var j=0;j<size;j++){attribArray[cursor++]=values[i][j]}}}}}},_updateBuffer:function(_gl,dirtyAttributes,isFacesDirty){var chunks=this.cache.get("chunks");if(!chunks){chunks=[];for(var i=0;i<this._arrayChunks.length;i++){chunks[i]={attributeBuffers:{},indicesBuffer:null}}this.cache.put("chunks",chunks)}for(var i=0;i<chunks.length;i++){var chunk=chunks[i];if(!chunk){chunk=chunks[i]={attributeBuffers:{},indicesBuffer:null}}var attributeBuffers=chunk.attributeBuffers,indicesBuffer=chunk.indicesBuffer;var arrayChunk=this._arrayChunks[i],attributeArrays=arrayChunk.attributeArrays,indicesArray=arrayChunk.indicesArray;for(var name in dirtyAttributes){var attribute=dirtyAttributes[name],value=attribute.value,type=attribute.type,semantic=attribute.semantic,size=attribute.size;var bufferInfo=attributeBuffers[name],buffer;if(bufferInfo){buffer=bufferInfo.buffer}else{buffer=_gl.createBuffer()}_gl.bindBuffer(_gl.ARRAY_BUFFER,buffer);_gl.bufferData(_gl.ARRAY_BUFFER,attributeArrays[name],_gl[this.hint]);attributeBuffers[name]={type:type,buffer:buffer,size:size,semantic:semantic}}if(isFacesDirty&&this.useFaces){if(!indicesBuffer){indicesBuffer=chunk.indicesBuffer={buffer:_gl.createBuffer(),count:indicesArray.length}}_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,indicesBuffer.buffer);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,indicesArray,_gl[this.hint])}}},generateVertexNormals:function(){var faces=this.faces,len=faces.length,positions=this.attributes.position.value,normals=this.attributes.normal.value,normal=vec3.create();v12=vec3.create(),v23=vec3.create();var difference=positions.length-normals.length;for(var i=0;i<normals.length;i++){vec3.set(normals[i],0,0,0)}for(var i=normals.length;i<positions.length;i++){normals[i]=[0,0,0]}for(var f=0;f<this.faces.length;f++){var face=faces[f],i1=face[0],i2=face[1],i3=face[2],p1=positions[i1],p2=positions[i2],p3=positions[i3];vec3.sub(v12,p1,p2);vec3.sub(v23,p2,p3);vec3.cross(normal,v12,v23);vec3.add(normals[i1],normals[i1],normal);vec3.add(normals[i2],normals[i2],normal);vec3.add(normals[i3],normals[i3],normal)}for(var i=0;i<normals.length;i++){vec3.normalize(normals[i],normals[i])}this._normalType="vertex"},generateFaceNormals:function(){if(!this.isUniqueVertex()){this.generateUniqueVertex()}var faces=this.faces,len=faces.length,positions=this.attributes.position.value,normals=this.attributes.normal.value,normal=vec3.create();v12=vec3.create(),v23=vec3.create();var isCopy=normals.length===positions.length;for(var i=0;i<len;i++){var face=faces[i],i1=face[0],i2=face[1],i3=face[2],p1=positions[i1],p2=positions[i2],p3=positions[i3];vec3.sub(v12,p1,p2);vec3.sub(v23,p2,p3);vec3.cross(normal,v12,v23);if(isCopy){vec3.copy(normals[i1],normal);vec3.copy(normals[i2],normal);vec3.copy(normals[i3],normal)}else{normals[i1]=normals[i2]=normals[i3]=arrSlice.call(normal)}}this._normalType="face"},generateTangents:function(){var texcoords=this.attributes.texcoord0.value,positions=this.attributes.position.value,tangents=this.attributes.tangent.value,normals=this.attributes.normal.value;var tan1=[],tan2=[],verticesNumber=this.getVerticesNumber();for(var i=0;i<verticesNumber;i++){tan1[i]=[0,0,0];tan2[i]=[0,0,0]}var sdir=[0,0,0];var tdir=[0,0,0];for(var i=0;i<this.faces.length;i++){var face=this.faces[i],i1=face[0],i2=face[1],i3=face[2],st1=texcoords[i1],st2=texcoords[i2],st3=texcoords[i3],p1=positions[i1],p2=positions[i2],p3=positions[i3];var x1=p2[0]-p1[0],x2=p3[0]-p1[0],y1=p2[1]-p1[1],y2=p3[1]-p1[1],z1=p2[2]-p1[2],z2=p3[2]-p1[2];var s1=st2[0]-st1[0],s2=st3[0]-st1[0],t1=st2[1]-st1[1],t2=st3[1]-st1[1];var r=1/(s1*t2-t1*s2);sdir[0]=(t2*x1-t1*x2)*r;sdir[1]=(t2*y1-t1*y2)*r;sdir[2]=(t2*z1-t1*z2)*r;tdir[0]=(s1*x2-s2*x1)*r;tdir[1]=(s1*y2-s2*y1)*r;tdir[2]=(s1*z2-s2*z1)*r;vec3.add(tan1[i1],tan1[i1],sdir);vec3.add(tan1[i2],tan1[i2],sdir);vec3.add(tan1[i3],tan1[i3],sdir);vec3.add(tan2[i1],tan2[i1],tdir);vec3.add(tan2[i2],tan2[i2],tdir);vec3.add(tan2[i3],tan2[i3],tdir)}var tmp=[0,0,0,0];var nCrossT=[0,0,0];for(var i=0;i<verticesNumber;i++){var n=normals[i];var t=tan1[i];vec3.scale(tmp,n,vec3.dot(n,t));vec3.sub(tmp,t,tmp);vec3.normalize(tmp,tmp);vec3.cross(nCrossT,n,t);tmp[3]=vec3.dot(nCrossT,tan2[i])<0?-1:1;tangents[i]=tmp.slice()}},isUniqueVertex:function(){if(this.faces.length&&this.useFaces){return this.getVerticesNumber()===this.faces.length*3}else{return true}},generateUniqueVertex:function(){var vertexUseCount=[];for(var i=0;i<this.getVerticesNumber();i++){vertexUseCount[i]=0}var cursor=this.getVerticesNumber(),attributes=this.getEnabledAttributes(),faces=this.faces;function cloneAttribute(idx){for(var name in attributes){var array=attributes[name].value;var size=array[0].length||1;if(size===1){array.push(array[idx])}else{array.push(arrSlice.call(array[idx]))}}}for(var i=0;i<faces.length;i++){var face=faces[i],i1=face[0],i2=face[1],i3=face[2];if(vertexUseCount[i1]>0){cloneAttribute(i1);face[0]=cursor;cursor++}if(vertexUseCount[i2]>0){cloneAttribute(i2);face[1]=cursor;cursor++}if(vertexUseCount[i3]>0){cloneAttribute(i3);face[2]=cursor;cursor++}vertexUseCount[i1]++;vertexUseCount[i2]++;vertexUseCount[i3]++}this.dirty()},generateBarycentric:function(){var a=[1,0,0],b=[0,0,1],c=[0,1,0];return function(){if(!this.isUniqueVertex()){this.generateUniqueVertex()}var array=this.attributes.barycentric.value;if(array.length==this.faces.length*3){return}var i1,i2,i3,face;for(var i=0;i<this.faces.length;i++){face=this.faces[i];i1=face[0];i2=face[1];i3=face[2];array[i1]=a;array[i2]=b;array[i3]=c}}}(),applyMatrix:function(matrix){var positions=this.attributes.position.value;var normals=this.attributes.normal.value;matrix=matrix._array;for(var i=0;i<positions.length;i++){vec3.transformMat4(positions[i],positions[i],matrix)}var inverseTransposeMatrix=mat4.create();mat4.invert(inverseTransposeMatrix,matrix);mat4.transpose(inverseTransposeMatrix,inverseTransposeMatrix);for(var i=0;i<normals.length;i++){vec3.transformMat4(normals[i],normals[i],inverseTransposeMatrix)}},dispose:function(_gl){}});return Geometry});define("3d/geometry/plane",["require","../geometry"],function(require){var Geometry=require("../geometry");var Plane=Geometry.derive(function(){return{widthSegments:1,heightSegments:1}},function(){var heightSegments=this.heightSegments,widthSegments=this.widthSegments,positions=this.attributes.position.value,texcoords=this.attributes.texcoord0.value,normals=this.attributes.normal.value,faces=this.faces;for(var y=0;y<=heightSegments;y++){var t=y/heightSegments;for(var x=0;x<=widthSegments;x++){var s=x/widthSegments;positions.push([2*s-1,2*t-1,0]);if(texcoords)texcoords.push([s,t]);if(normals)normals.push([0,0,1]);if(x<widthSegments&&y<heightSegments){var i=x+y*(widthSegments+1);faces.push([i,i+1,i+widthSegments+1]);faces.push([i+widthSegments+1,i+1,i+widthSegments+2])}}}});return Plane});define("3d/shader",["require","core/base","glmatrix","util/util","_"],function(require){var Base=require("core/base"),glMatrix=require("glmatrix"),mat2=glMatrix.mat2;mat3=glMatrix.mat3,mat4=glMatrix.mat4,util=require("util/util"),_=require("_");var uniformRegex=/uniform\s+(bool|float|int|vec2|vec3|vec4|ivec2|ivec3|ivec4|mat2|mat3|mat4|sampler2D|samplerCube)\s+(\w+)?(\[.*?\])?\s*(:\s*([\S\s]+?))?;/g;var attributeRegex=/attribute\s+(float|int|vec2|vec3|vec4)\s+(\w*)\s*(:\s*(\w+))?;/g;var uniformTypeMap={bool:"1i","int":"1i",sampler2D:"t",samplerCube:"t","float":"1f",vec2:"2f",vec3:"3f",vec4:"4f",ivec2:"2i",ivec3:"3i",ivec4:"4i",mat2:"m2",mat3:"m3",mat4:"m4"};var uniformValueConstructor={bool:function(){return true},"int":function(){return 0},"float":function(){return 0},sampler2D:function(){return null},samplerCube:function(){return null},vec2:function(){return new Float32Array(2)},vec3:function(){return new Float32Array(3)},vec4:function(){return new Float32Array(4)},ivec2:function(){return new Int32Array(2)},ivec3:function(){return new Int32Array(3)},ivec4:function(){return new Int32Array(4)},mat2:function(){return mat2.create()},mat3:function(){return mat3.create()},mat4:function(){return mat4.create()},array:function(){return[]}};var availableSemantics=["POSITION","NORMAL","BINORMAL","TANGENT","TEXCOORD","TEXCOORD_0","TEXCOORD_1","COLOR","WORLD","VIEW","PROJECTION","WORLDVIEW","VIEWPROJECTION","WORLDVIEWPROJECTION","WORLDINVERSE","VIEWINVERSE","PROJECTIONINVERSE","WORLDVIEWINVERSE","VIEWPROJECTIONINVERSE","WORLDVIEWPROJECTIONINVERSE","WORLDTRANSPOSE","VIEWTRANSPOSE","PROJECTIONTRANSPOSE","WORLDVIEWTRANSPOSE","VIEWPROJECTIONTRANSPOSE","WORLDVIEWPROJECTIONTRANSPOSE","WORLDINVERSETRANSPOSE","VIEWINVERSETRANSPOSE","PROJECTIONINVERSETRANSPOSE","WORLDVIEWINVERSETRANSPOSE","VIEWPROJECTIONINVERSETRANSPOSE","WORLDVIEWPROJECTIONINVERSETRANSPOSE"];var errorShader={};var enabledAttributeList={};var Shader=Base.derive(function(){return{__GUID__:util.genGUID(),vertex:"",fragment:"",precision:"mediump",semantics:{},uniformTemplates:{},attributeTemplates:{},vertexDefines:{},fragmentDefines:{},lightNumber:{},_textureStatus:{},_vertexProcessed:"",_fragmentProcessed:"",_program:null}},function(){this.update()},{setVertex:function(str){this.vertex=str;this.update()},setFragment:function(str){this.fragment=str;_caches;this.update()},bind:function(_gl){this.cache.use(_gl.__GUID__,{locations:{},attriblocations:{}});if(this.cache.get("dirty")||this.cache.miss("program")){this._buildProgram(_gl,this._vertexProcessed,this._fragmentProcessed);this.cache.put("dirty",false)}_gl.useProgram(this.cache.get("program"))},dirty:function(){for(var contextId in this.cache._caches){var context=this.cache._caches[contextId];context["dirty"]=true;context["locations"]={};context["attriblocations"]={}}},update:function(force){if(this.vertex!==this._vertexPrev||this.fragment!==this._fragmentPrev||force){this._parseImport();this.semantics={};this._textureStatus={};this._parseUniforms();this._parseAttributes();this._vertexPrev=this.vertex;this._fragmentPrev=this.fragment}this._addDefine();this.dirty()},enableTexture:function(symbol,autoUpdate){var status=this._textureStatus[symbol];if(status){var isEnabled=status.enabled;if(isEnabled){return}else{status.enabled=true;var autoUpdate=typeof autoUpdate==="undefined"||true;if(autoUpdate){this.update()}}}},enableTexturesAll:function(autoUpdate){for(var symbol in this._textureStatus){this._textureStatus[symbol].enabled=true}var autoUpdate=typeof autoUpdate==="undefined"||true;if(autoUpdate){this.update()}},disableTexture:function(symbol,autoUpdate){var status=this._textureStatus[symbol];if(status){var isDisabled=!status.enabled;if(isDisabled){return}else{status.enabled=false;var autoUpdate=typeof autoUpdate==="undefined"||true;if(autoUpdate){this.update()}}}},disableTexturesAll:function(symbol,autoUpdate){for(var symbol in this._textureStatus){this._textureStatus[symbol].enabled=false}var autoUpdate=typeof autoUpdate==="undefined"||true;if(autoUpdate){this.update()}},setUniform:function(_gl,type,symbol,value){var program=this.cache.get("program");var locationsMap=this.cache.get("locations");var location=locationsMap[symbol];if(location===null){return}else if(!location){location=_gl.getUniformLocation(program,symbol);if(location===null){locationsMap[symbol]=null;return}locationsMap[symbol]=location}switch(type){case"1i":_gl.uniform1i(location,value);break;case"1f":_gl.uniform1f(location,value);break;case"1fv":_gl.uniform1fv(location,value);break;case"1iv":_gl.uniform1iv(location,value);break;case"2iv":_gl.uniform2iv(location,value);break;case"2fv":_gl.uniform2fv(location,value);break;case"3iv":_gl.uniform3iv(location,value);break;case"3fv":_gl.uniform3fv(location,value);break;case"4iv":_gl.uniform4iv(location,value);break;case"4fv":_gl.uniform4fv(location,value);break;case"2i":_gl.uniform2i(location,value[0],value[1]);break;case"2f":_gl.uniform2f(location,value[0],value[1]);break;case"3i":_gl.uniform3i(location,value[0],value[1],value[2]);break;case"3f":_gl.uniform3f(location,value[0],value[1],value[2]);break;case"4i":_gl.uniform4i(location,value[0],value[1],value[2],value[3]);break;case"4f":_gl.uniform4f(location,value[0],value[1],value[2],value[3]);break;case"m2":_gl.uniformMatrix2fv(location,false,value);break;case"m3":_gl.uniformMatrix3fv(location,false,value);break;case"m4":_gl.uniformMatrix4fv(location,false,value);break;case"m2v":var size=4;case"m3v":var size=9;case"m4v":var size=16;if(value instanceof Array){var array=new Float32Array(value.length*size);var cursor=0;for(var i=0;i<value.length;i++){var item=value[i];for(var j=0;j<item.length;j++){array[cursor++]=item[j]}}_gl.uniformMatrix4fv(location,false,array)}else if(value instanceof Float32Array){_gl.uniformMatrix4fv(location,false,value)}break}},enableAttributes:function(_gl,attribList){var program=this.cache.get("program");var locationsMap=this.cache.get("attriblocations");if(typeof attribList==="string"){attribList=Array.prototype.slice.call(arguments,1)}var enabledAttributeListInContext=enabledAttributeList[_gl.__GUID__];if(!enabledAttributeListInContext){enabledAttributeListInContext=enabledAttributeList[_gl.__GUID__]=[]}for(var symbol in this.attributeTemplates){var location=locationsMap[symbol];if(typeof location==="undefined"){location=_gl.getAttribLocation(program,symbol);if(location===-1){continue}locationsMap[symbol]=location}if(attribList.indexOf(symbol)>=0){if(!enabledAttributeListInContext[location]){_gl.enableVertexAttribArray(location);enabledAttributeListInContext[location]=true}}else{if(enabledAttributeListInContext[location]){_gl.disableVertexAttribArray(location);enabledAttributeListInContext[location]=false}}}},setMeshAttribute:function(_gl,symbol,type,size){var glType;switch(type){case"byte":glType=_gl.BYTE;break;case"ubyte":glType=_gl.UNSIGNED_BYTE;break;case"short":glType=_gl.SHORT;break;case"ushort":glType=_gl.UNSIGNED_SHORT;break;default:glType=_gl.FLOAT;break}var program=this.cache.get("program");var locationsMap=this.cache.get("attriblocations");var location=locationsMap[symbol];if(typeof location==="undefined"){location=_gl.getAttribLocation(program,symbol);if(location===-1){return}locationsMap[symbol]=location}_gl.vertexAttribPointer(location,size,glType,false,0,0)},_parseImport:function(){this._vertexProcessedWithoutDefine=Shader.parseImport(this.vertex);this._fragmentProcessedWithoutDefine=Shader.parseImport(this.fragment)},_addDefine:function(){var defineStr=[];_.each(this.lightNumber,function(count,lightType){if(count){defineStr.push("#define "+lightType.toUpperCase()+"_NUMBER "+count)}});_.each(this._textureStatus,function(status,symbol){if(status.enabled&&status.shaderType==="vertex"){defineStr.push("#define "+symbol.toUpperCase()+"_ENABLED")}});_.each(this.vertexDefines,function(value,symbol){if(value===null){defineStr.push("#define "+symbol)}else{defineStr.push("#define "+symbol+" "+value.toString())}});this._vertexProcessed=defineStr.join("\n")+"\n"+this._vertexProcessedWithoutDefine;defineStr=[];_.each(this.lightNumber,function(count,lightType){if(count){defineStr.push("#define "+lightType+"_NUMBER "+count)}});_.each(this._textureStatus,function(status,symbol){if(status.enabled&&status.shaderType==="fragment"){defineStr.push("#define "+symbol.toUpperCase()+"_ENABLED")}});_.each(this.fragmentDefines,function(value,symbol){if(value===null){defineStr.push("#define "+symbol)}else{defineStr.push("#define "+symbol+" "+value.toString())}});var tmp=defineStr.join("\n")+"\n"+this._fragmentProcessedWithoutDefine;this._fragmentProcessed=["precision",this.precision,"float"].join(" ")+";\n"+tmp},_parseUniforms:function(){var uniforms={},self=this;var shaderType="vertex";this._vertexProcessedWithoutDefine=this._vertexProcessedWithoutDefine.replace(uniformRegex,_uniformParser);shaderType="fragment";this._fragmentProcessedWithoutDefine=this._fragmentProcessedWithoutDefine.replace(uniformRegex,_uniformParser);function _uniformParser(str,type,symbol,isArray,semanticWrapper,semantic){if(type&&symbol){var uniformType=uniformTypeMap[type];var isConfigurable=true;if(uniformType){if(type==="sampler2D"||type==="samplerCube"){self._textureStatus[symbol]={enabled:false,shaderType:shaderType}}if(isArray){uniformType+="v"}if(semantic){if(availableSemantics.indexOf(semantic)<0){if(semantic==="unconfigurable"){isConfigurable=false}else{var defaultValueFunc=self._parseDefaultValue(type,semantic);if(!defaultValueFunc)console.warn('Unkown semantic "'+semantic+'"');else semantic=""}}else{self.semantics[semantic]={symbol:symbol,type:uniformType};isConfigurable=false}}if(isConfigurable){uniforms[symbol]={type:uniformType,value:isArray?uniformValueConstructor["array"]:defaultValueFunc||uniformValueConstructor[type],semantic:semantic||null}}}return["uniform",type,symbol,isArray].join(" ")+";\n"}}this.uniformTemplates=uniforms},_parseDefaultValue:function(type,str){var arrayRegex=/\[\s*(.*)\s*\]/;if(type==="vec2"||type==="vec3"||type==="vec4"){var arrayStr=arrayRegex.exec(str)[1];if(arrayStr){var arr=arrayStr.split(/\s*,\s*/);return function(){return new Float32Array(arr)}}else{return}}else if(type==="bool"){return function(){return str.toLowerCase()==="true"?true:false}}else if(type==="float"){return function(){return parseFloat(str)}}},createUniforms:function(){var uniforms={};_.each(this.uniformTemplates,function(uniformTpl,symbol){uniforms[symbol]={type:uniformTpl.type,value:uniformTpl.value()}});return uniforms},_parseAttributes:function(){var attributes={},self=this;this._vertexProcessedWithoutDefine=this._vertexProcessedWithoutDefine.replace(attributeRegex,_attributeParser);function _attributeParser(str,type,symbol,semanticWrapper,semantic){if(type&&symbol){var size=1;switch(type){case"vec4":size=4;break;case"vec3":size=3;break;case"vec2":size=2;break;case"float":size=1;break}attributes[symbol]={type:"float",size:size,semantic:semantic||null};if(semantic){if(availableSemantics.indexOf(semantic)<0){console.warn('Unkown semantic "'+semantic+'"')}else{self.semantics[semantic]={symbol:symbol,type:type}}}}return["attribute",type,symbol].join(" ")+";\n"}this.attributeTemplates=attributes},_buildProgram:function(_gl,vertexShaderString,fragmentShaderString){if(this.cache.get("program")){_gl.deleteProgram(this.cache.get("program"))}var program=_gl.createProgram();try{var vertexShader=this._compileShader(_gl,"vertex",vertexShaderString);var fragmentShader=this._compileShader(_gl,"fragment",fragmentShaderString);_gl.attachShader(program,vertexShader);_gl.attachShader(program,fragmentShader);_gl.linkProgram(program);if(!_gl.getProgramParameter(program,_gl.LINK_STATUS)){throw new Error("Could not initialize shader\n"+"VALIDATE_STATUS: "+_gl.getProgramParameter(program,_gl.VALIDATE_STATUS)+", gl error ["+_gl.getError()+"]")}}catch(e){if(errorShader[this.__GUID__]){return}errorShader[this.__GUID__]=this;throw e}_gl.deleteShader(vertexShader);_gl.deleteShader(fragmentShader);this.cache.put("program",program)},_compileShader:function(_gl,type,shaderString){var shader=_gl.createShader(type==="fragment"?_gl.FRAGMENT_SHADER:_gl.VERTEX_SHADER);_gl.shaderSource(shader,shaderString);_gl.compileShader(shader);if(!_gl.getShaderParameter(shader,_gl.COMPILE_STATUS)){throw new Error([_gl.getShaderInfoLog(shader),addLineNumbers(shaderString)].join("\n"))}return shader},dispose:function(){}});function addLineNumbers(string){var chunks=string.split("\n");for(var i=0,il=chunks.length;i<il;i++){chunks[i]=i+1+": "+chunks[i]}return chunks.join("\n")}var importRegex=/(@import)\s*([0-9a-zA-Z_\-\.]*)/g;Shader.parseImport=function(shaderStr){shaderStr=shaderStr.replace(importRegex,function(str,importSymbol,importName){if(_source[importName]){return Shader.parseImport(_source[importName])}});return shaderStr};var exportRegex=/(@export)\s*([0-9a-zA-Z_\-\.]*)\s*\n([\s\S]*?)@end/g;Shader.import=function(shaderStr){shaderStr.replace(exportRegex,function(str,exportSymbol,exportName,code){_source[exportName]=code;return code})};var _source={};Shader.source=function(name){var shaderStr=_source[name];if(!shaderStr){console.error('Shader "'+name+'" not existed in library');return}return shaderStr};return Shader});define("3d/texture",["require","core/base","_"],function(require){var Base=require("core/base"),_=require("_");var Texture=Base.derive(function(){return{width:512,height:512,type:"UNSIGNED_BYTE",format:"RGBA",wrapS:"CLAMP_TO_EDGE",wrapT:"CLAMP_TO_EDGE",minFilter:"LINEAR_MIPMAP_LINEAR",magFilter:"LINEAR",generateMipmaps:true,anisotropic:1,flipY:true,unpackAlignment:4,premultiplyAlpha:false,NPOT:false}},{getWebGLTexture:function(_gl){this.cache.use(_gl.__GUID__);if(this.cache.miss("webgl_texture")){this.cache.put("webgl_texture",_gl.createTexture());this.cache.put("dirty",true)}if(this.cache.get("dirty")){this.update(_gl);this.cache.put("dirty",false)}return this.cache.get("webgl_texture")},bind:function(){},unbind:function(){},dirty:function(){for(var contextId in this.cache._caches){this.cache._caches[contextId]["dirty"]=true}},update:function(_gl){},beforeUpdate:function(_gl){_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,this.flipY);_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha);_gl.pixelStorei(_gl.UNPACK_ALIGNMENT,this.unpackAlignment);this.fallBack()},fallBack:function(){var isPowerOfTwo=this.isPowerOfTwo();if(this.format==="DEPTH_COMPONENT"){this.generateMipmaps=false}if(!isPowerOfTwo||!this.generateMipmaps){this.NPOT=true;this._minFilterOriginal=this.minFilter;this._magFilterOriginal=this.magFilter;this._wrapSOriginal=this.wrapS;this._wrapTOriginal=this.wrapT;if(this.minFilter.indexOf("NEAREST")==0){this.minFilter="NEAREST"}else{this.minFilter="LINEAR"}if(this.magFilter.indexOf("NEAREST")==0){this.magFilter="NEAREST"}else{this.magFilter="LINEAR"}this.wrapS="CLAMP_TO_EDGE";this.wrapT="CLAMP_TO_EDGE"}else{if(this._minFilterOriginal){this.minFilter=this._minFilterOriginal}if(this._magFilterOriginal){this.magFilter=this._magFilterOriginal}if(this._wrapSOriginal){this.wrapS=this._wrapSOriginal}if(this._wrapTOriginal){this.wrapT=this._wrapTOriginal}}},nextHighestPowerOfTwo:function(x){--x;for(var i=1;i<32;i<<=1){x=x|x>>i}return x+1},dispose:function(_gl){this.cache.use(_gl.__GUID__);_gl.deleteTexture(this.cache.get("webgl_texture"))},isRenderable:function(){},isPowerOfTwo:function(){}});return Texture});define("3d/webglinfo",[],function(){var EXTENSION_LIST=["OES_texture_float","OES_texture_half_float","OES_standard_derivatives","OES_vertex_array_object","OES_element_index_uint","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","EXT_texture_filter_anisotropic","EXT_draw_buffers"];var initialized=false;var extensions={};var WebGLInfo={initialize:function(_gl){if(initialized){return}for(var i=0;i<EXTENSION_LIST.length;i++){var extName=EXTENSION_LIST[i];var ext=_gl.getExtension(extName);if(!ext){ext=_gl.getExtension("MOZ_"+extName)}if(!ext){ext=_gl.getExtension("WEBKIT_"+extName)}extensions[extName]=ext}initialized=true},getExtension:function(name){return extensions[name]}};return WebGLInfo});define("3d/texture/texture2d",["require","../texture","../webglinfo"],function(require){var Texture=require("../texture");
var WebGLInfo=require("../webglinfo");var Texture2D=Texture.derive({image:null,pixels:null},{update:function(_gl){_gl.bindTexture(_gl.TEXTURE_2D,this.cache.get("webgl_texture"));this.beforeUpdate(_gl);var glFormat=_gl[this.format.toUpperCase()],glType=_gl[this.type.toUpperCase()];_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_S,_gl[this.wrapS.toUpperCase()]);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_T,_gl[this.wrapT.toUpperCase()]);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MAG_FILTER,_gl[this.magFilter.toUpperCase()]);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MIN_FILTER,_gl[this.minFilter.toUpperCase()]);var anisotropicExt=WebGLInfo.getExtension("EXT_texture_filter_anisotropic");if(anisotropicExt&&this.anisotropic>1){_gl.texParameterf(_gl.TEXTURE_2D,anisotropicExt.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropic)}if(this.image){if(this.image.complete)_gl.texImage2D(_gl.TEXTURE_2D,0,glFormat,glFormat,glType,this.image)}else{_gl.texImage2D(_gl.TEXTURE_2D,0,glFormat,this.width,this.height,0,glFormat,glType,this.pixels)}if(!this.NPOT&&this.generateMipmaps){_gl.generateMipmap(_gl.TEXTURE_2D)}_gl.bindTexture(_gl.TEXTURE_2D,null)},isPowerOfTwo:function(){if(this.image){var width=this.image.width,height=this.image.height}else{var width=this.width,height=this.height}return(width&width-1)===0&&(height&height-1)===0},isRenderable:function(){if(this.image){return this.image.complete}else{return this.width&&this.height}},bind:function(_gl){_gl.bindTexture(_gl.TEXTURE_2D,this.getWebGLTexture(_gl))},unbind:function(_gl){_gl.bindTexture(_gl.TEXTURE_2D,null)}});return Texture2D});define("3d/texture/texturecube",["require","../texture","../webglinfo","_"],function(require){var Texture=require("../texture");var WebGLInfo=require("../webglinfo");var _=require("_");var targetMap={px:"TEXTURE_CUBE_MAP_POSITIVE_X",py:"TEXTURE_CUBE_MAP_POSITIVE_Y",pz:"TEXTURE_CUBE_MAP_POSITIVE_Z",nx:"TEXTURE_CUBE_MAP_NEGATIVE_X",ny:"TEXTURE_CUBE_MAP_NEGATIVE_Y",nz:"TEXTURE_CUBE_MAP_NEGATIVE_Z"};var TextureCube=Texture.derive({image:{px:null,nx:null,py:null,ny:null,pz:null,nz:null},pixels:{px:null,nx:null,py:null,ny:null,pz:null,nz:null}},{update:function(_gl){_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,this.cache.get("webgl_texture"));this.beforeUpdate(_gl);var glFormat=_gl[this.format.toUpperCase()],glType=_gl[this.type.toUpperCase()];_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_WRAP_S,_gl[this.wrapS.toUpperCase()]);_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_WRAP_T,_gl[this.wrapT.toUpperCase()]);_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_MAG_FILTER,_gl[this.magFilter.toUpperCase()]);_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_MIN_FILTER,_gl[this.minFilter.toUpperCase()]);var anisotropicExt=WebGLInfo.getExtension("EXT_texture_filter_anisotropic");if(anisotropicExt&&this.anisotropic>1){_gl.texParameterf(_gl.TEXTURE_CUBE_MAP,anisotropicExt.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropic)}_.each(this.image,function(img,target){if(img)_gl.texImage2D(_gl[targetMap[target]],0,glFormat,glFormat,glType,img);else _gl.texImage2D(_gl[targetMap[target]],0,glFormat,this.width,this.height,0,glFormat,glType,this.pixels[target])},this);if(!this.NPOT&&this.generateMipmaps){_gl.generateMipmap(_gl.TEXTURE_CUBE_MAP)}_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,null)},bind:function(_gl){_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,this.getWebGLTexture(_gl))},unbind:function(_gl){_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,null)},isPowerOfTwo:function(){if(this.image.px){return isPowerOfTwo(this.image.px.width)&&isPowerOfTwo(this.image.px.height)}else{return isPowerOfTwo(this.width)&&isPowerOfTwo(this.height)}function isPowerOfTwo(value){return value&value-1===0}},isRenderable:function(){if(this.image.px){return this.image.px.complete&&this.image.nx.complete&&this.image.py.complete&&this.image.ny.complete&&this.image.pz.complete&&this.image.nz.complete}else{return this.width&&this.height}}});return TextureCube});define("3d/material",["require","core/base","./shader","util/util","./texture","./texture/texture2d","./texture/texturecube","_"],function(require){var Base=require("core/base");var Shader=require("./shader");var util=require("util/util");var Texture=require("./texture");var Texture2D=require("./texture/texture2d");var TextureCube=require("./texture/texturecube");var _=require("_");var Material=Base.derive(function(){var id=util.genGUID();return{__GUID__:id,name:"MATERIAL_"+id,uniforms:{},shader:null,depthTest:true,depthWrite:true,transparent:false,blend:null,autoBindingLights:true}},function(){if(this.shader){this.attachShader(this.shader)}},{bind:function(_gl){var slot=0;_.each(this.uniforms,function(uniform,symbol){if(uniform.value===null){return}else if(uniform.value instanceof Array&&!uniform.value.length){return}if(uniform.value.instanceof&&uniform.value.instanceof(Texture)){var texture=uniform.value;if(!texture.isRenderable()){return}_gl.activeTexture(_gl.TEXTURE0+slot);texture.bind(_gl);this.shader.setUniform(_gl,"1i",symbol,slot);slot++}else if(uniform.value instanceof Array){var exampleValue=uniform.value[0];if(exampleValue&&exampleValue.instanceof&&exampleValue.instanceof(Texture)){var res=[];for(var i=0;i<uniform.value.length;i++){var texture=uniform.value[i];if(!texture.isRenderable()){continue}_gl.activeTexture(_gl.TEXTURE0+slot);texture.bind(_gl);res.push(slot++)}this.shader.setUniform(_gl,"1iv",symbol,res)}else{this.shader.setUniform(_gl,uniform.type,symbol,uniform.value)}}else{this.shader.setUniform(_gl,uniform.type,symbol,uniform.value)}},this)},setUniform:function(symbol,value){var uniform=this.uniforms[symbol];if(uniform){uniform.value=value}else{}},setUniforms:function(obj){for(var symbol in obj){var value=obj[symbol];this.setUniform(symbol,value)}},getUniform:function(symbol){var uniform=this.uniforms[symbol];if(uniform){return uniform.value}else{}},attachShader:function(shader){this.uniforms=shader.createUniforms();this.shader=shader},detachShader:function(){this.shader=null;this.uniforms={}}});return Material});define("3d/mesh",["require","./node","_"],function(require){var Node=require("./node");var _=require("_");var prevDrawID=0;var Mesh=Node.derive(function(){return{material:null,geometry:null,mode:"TRIANGLES",receiveShadow:true,castShadow:true,skeleton:null}},{render:function(renderer,globalMaterial){var _gl=renderer.gl;this.trigger("beforerender",_gl);var material=globalMaterial||this.material;var shader=material.shader;var geometry=this.geometry;var glDrawMode=_gl[this.mode.toUpperCase()];if(this.skeleton){var skinMatricesArray=this.skeleton.getBoneMatricesArray();shader.setUniform(_gl,"m4v","boneMatrices",skinMatricesArray)}var chunks=geometry.getBufferChunks(_gl);for(var c=0;c<chunks.length;c++){currentDrawID=_gl.__GUID__+"_"+geometry.__GUID__+"_"+c;var chunk=chunks[c],attributeBuffers=chunk.attributeBuffers,indicesBuffer=chunk.indicesBuffer;if(currentDrawID!==prevDrawID){prevDrawID=currentDrawID;availableAttributes={};for(var name in attributeBuffers){var attributeBufferInfo=attributeBuffers[name];var semantic=attributeBufferInfo.semantic;if(semantic){var semanticInfo=shader.semantics[semantic];var symbol=semanticInfo&&semanticInfo.symbol}else{var symbol=name}if(symbol&&shader.attributeTemplates[symbol]){availableAttributes[symbol]=attributeBufferInfo}}shader.enableAttributes(_gl,Object.keys(availableAttributes));for(var symbol in availableAttributes){var attributeBufferInfo=availableAttributes[symbol];var buffer=attributeBufferInfo.buffer;_gl.bindBuffer(_gl.ARRAY_BUFFER,buffer);shader.setMeshAttribute(_gl,symbol,attributeBufferInfo.type,attributeBufferInfo.size)}}if(geometry.useFaces){_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,indicesBuffer.buffer);_gl.drawElements(glDrawMode,indicesBuffer.count,_gl.UNSIGNED_SHORT,0)}else{_gl.drawArrays(glDrawMode,0,geometry.vertexCount)}}var drawInfo={faceNumber:geometry.faces.length,vertexNumber:geometry.getVerticesNumber(),drawcallNumber:chunks.length};this.trigger("afterrender",_gl,drawInfo);return drawInfo},bindGeometry:function(_gl){var shader=this.material.shader;var geometry=this.geometry}});Mesh.materialChanged=function(){prevDrawID=0};return Mesh});define("3d/compositor/shaders/vertex.essl",[],function(){return"uniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\n\nvarying vec2 v_Texcoord;\n\nvoid main(){\n\n    v_Texcoord = texcoord;\n    gl_Position = worldViewProjection * vec4(position, 1.0);\n}"});define("3d/compositor/shaders/coloradjust.essl",[],function(){return'@export buildin.compositor.coloradjust\n\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float brightness;\nuniform float contrast;\nuniform float exposure;\nuniform float gamma;\nuniform float saturation;\n\n// Values from "Graphics Shaders: Theory and Practice" by Bailey and Cunningham\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\n\nvoid main()\n{\n    vec4 tex = texture2D( texture, v_Texcoord);\n\n    // brightness\n    vec3 color = clamp( tex.rgb + vec3(brightness), 0.0, 1.0);\n    // contrast\n    color = clamp( (color-vec3(0.5))*contrast+vec3(0.5), 0.0, 1.0);\n    // exposure\n    color = clamp( color * pow(2.0, exposure), 0.0, 1.0);\n    // gamma\n    color = clamp( pow(color, vec3(gamma)), 0.0, 1.0);\n    // saturation\n    float luminance = dot( color, w );\n    color = mix(vec3(luminance), color, saturation);\n    \n    gl_FragColor = vec4(color, tex.a);\n}\n\n@end'});define("3d/compositor/shaders/blur.essl",[],function(){return"/**\n *  http://www.gamerendering.com/2008/10/11/gaussian-blur-filter-shader/\n */\n\n@export buildin.compositor.gaussian_blur_v\n\nuniform sampler2D texture; // the texture with the scene you want to blur\nvarying vec2 v_Texcoord;\n \nuniform float blurSize : 3.0; \nuniform float imageWidth : 512.0;\n\nvoid main(void)\n{\n   vec4 sum = vec4(0.0);\n \n   // blur in y (vertical)\n   // take nine samples, with the distance blurSize between them\n   sum += texture2D(texture, vec2(v_Texcoord.x - 4.0*blurSize/imageWidth, v_Texcoord.y)) * 0.05;\n   sum += texture2D(texture, vec2(v_Texcoord.x - 3.0*blurSize/imageWidth, v_Texcoord.y)) * 0.09;\n   sum += texture2D(texture, vec2(v_Texcoord.x - 2.0*blurSize/imageWidth, v_Texcoord.y)) * 0.12;\n   sum += texture2D(texture, vec2(v_Texcoord.x - blurSize/imageWidth, v_Texcoord.y)) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y)) * 0.16;\n   sum += texture2D(texture, vec2(v_Texcoord.x + blurSize/imageWidth, v_Texcoord.y)) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x + 2.0*blurSize/imageWidth, v_Texcoord.y)) * 0.12;\n   sum += texture2D(texture, vec2(v_Texcoord.x + 3.0*blurSize/imageWidth, v_Texcoord.y)) * 0.09;\n   sum += texture2D(texture, vec2(v_Texcoord.x + 4.0*blurSize/imageWidth, v_Texcoord.y)) * 0.05;\n \n   gl_FragColor = sum;\n}\n\n@end\n\n@export buildin.compositor.gaussian_blur_h\n\nuniform sampler2D texture; // this should hold the texture rendered by the horizontal blur pass\nvarying vec2 v_Texcoord;\n \nuniform float blurSize : 3.0;\nuniform float imageHeight : 512.0;\n \nvoid main(void)\n{\n   vec4 sum = vec4(0.0);\n \n   // blur in y (vertical)\n   // take nine samples, with the distance blurSize between them\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y - 4.0*blurSize/imageHeight)) * 0.05;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y - 3.0*blurSize/imageHeight)) * 0.09;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y - 2.0*blurSize/imageHeight)) * 0.12;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y - blurSize/imageHeight)) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y)) * 0.16;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y + blurSize/imageHeight)) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y + 2.0*blurSize/imageHeight)) * 0.12;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y + 3.0*blurSize/imageHeight)) * 0.09;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y + 4.0*blurSize/imageHeight)) * 0.05;\n \n   gl_FragColor = sum;\n}\n\n@end\n\n@export buildin.compositor.box_blur\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 3.0;\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n\n   vec4 tex = texture2D(texture, v_Texcoord);\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   tex += texture2D(texture, v_Texcoord + vec2(offset.x, 0.0) );\n   tex += texture2D(texture, v_Texcoord + vec2(offset.x, offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(-offset.x, offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(0.0, offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(-offset.x, 0.0) );\n   tex += texture2D(texture, v_Texcoord + vec2(-offset.x, -offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(offset.x, -offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(0.0, -offset.y) );\n\n   tex /= 9.0;\n   return tex;\n}\n\n@end\n\n// http://www.slideshare.net/DICEStudio/five-rendering-ideas-from-battlefield-3-need-for-speed-the-run\n@export buildin.compositor.hexagonal_blur_mrt_1\n\n// MRT in chrome\n// https://www.khronos.org/registry/webgl/sdk/tests/conformance/extensions/ext-draw-buffers.html\n#extension GL_EXT_draw_buffers : require\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 2.0;\n\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color = vec4(0.0);\n   // Top\n   for(int i = 0; i < 10; i++){\n      color += 1.0/10.0 * texture2D(texture, v_Texcoord + vec2(0.0, offset.y * float(i)) );\n   }\n   gl_FragData[0] = color;\n   vec4 color2 = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 10; i++){\n      color2 += 1.0/10.0 * texture2D(texture, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   gl_FragData[1] = (color + color2) / 2.0;\n}\n\n@end\n\n@export buildin.compositor.hexagonal_blur_mrt_2\n\nuniform sampler2D texture0;\nuniform sampler2D texture1;\n\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 2.0;\n\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color1 = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 10; i++){\n      color1 += 1.0/10.0 * texture2D(texture0, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   vec4 color2 = vec4(0.0);\n   // Down right\n   for(int i = 0; i < 10; i++){\n      color2 += 1.0/10.0 * texture2D(texture1, v_Texcoord + vec2(offset.x * float(i), -offset.y * float(i)) );\n   }\n\n   gl_FragColor = (color1 + color2) / 2.0;\n}\n\n@end\n\n\n@export buildin.compositor.hexagonal_blur_1\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color = vec4(0.0);\n   // Top\n   for(int i = 0; i < 10; i++){\n      color += 1.0/10.0 * texture2D(texture, v_Texcoord + vec2(0.0, offset.y * float(i)) );\n   }\n   gl_FragColor = color;\n}\n\n@end\n\n@export buildin.compositor.hexagonal_blur_2\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 10; i++){\n      color += 1.0/10.0 * texture2D(texture, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   gl_FragColor = color;\n}\n@end\n\n@export buildin.compositor.hexagonal_blur_3\n\nuniform sampler2D texture1;\nuniform sampler2D texture2;\n\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform float imageWidth : 1.0;\nuniform float imageHeight : 1.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color1 = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 10; i++){\n      color1 += 1.0/10.0 * texture2D(texture1, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   vec4 color2 = vec4(0.0);\n   // Down right\n   for(int i = 0; i < 10; i++){\n      color2 += 1.0/10.0 * texture2D(texture1, v_Texcoord + vec2(offset.x * float(i), -offset.y * float(i)) );\n   }\n\n   vec4 color3 = vec4(0.0);\n   // Down right\n   for(int i = 0; i < 10; i++){\n      color3 += 1.0/10.0 * texture2D(texture2, v_Texcoord + vec2(offset.x * float(i), -offset.y * float(i)) );\n   }\n\n   gl_FragColor = (color1 + color2 + color3) / 3.0;\n}\n\n@end"});define("3d/compositor/shaders/grayscale.essl",[],function(){return"\n@export buildin.compositor.grayscale\n\nvarying vec2 v_Texcoord;\n\nuniform sampler2D texture;\n\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\n\nvoid main()\n{\n    vec4 tex = texture2D( texture, v_Texcoord );\n    float luminance = dot(tex.rgb, w);\n\n    gl_FragColor = vec4(vec3(luminance), tex.a);\n}\n\n@end"});define("3d/compositor/shaders/lut.essl",[],function(){return"\n// https://github.com/BradLarson/GPUImage?source=c\n@export buildin.compositor.lut\n\nvarying vec2 v_Texcoord;\n\nuniform sampler2D texture;\nuniform sampler2D lookup;\n\nvoid main()\n{\n    vec4 tex = texture2D(texture, v_Texcoord);\n\n    float blueColor = tex.b * 63.0;\n    \n    vec2 quad1;\n    quad1.y = floor(floor(blueColor) / 8.0);\n    quad1.x = floor(blueColor) - (quad1.y * 8.0);\n    \n    vec2 quad2;\n    quad2.y = floor(ceil(blueColor) / 8.0);\n    quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n    \n    vec2 texPos1;\n    texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.r);\n    texPos1.y = (quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.g);\n    \n    vec2 texPos2;\n    texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.r);\n    texPos2.y = (quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.g);\n    \n    vec4 newColor1 = texture2D(lookup, texPos1);\n    vec4 newColor2 = texture2D(lookup, texPos2);\n    \n    vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n    gl_FragColor = vec4(newColor.rgb, tex.w);\n}\n\n@end"});define("3d/compositor/shaders/output.essl",[],function(){return"\n@export buildin.compositor.output\n\nvarying vec2 v_Texcoord;\n\nuniform sampler2D texture;\n\nvoid main()\n{\n    vec4 tex = texture2D( texture, v_Texcoord );\n\n    gl_FragColor = tex;\n}\n\n@end"});define("3d/compositor/pass",["require","core/base","../scene","../camera/orthographic","../geometry/plane","../shader","../material","../mesh","../scene","./shaders/vertex.essl","../texture","../webglinfo","./shaders/coloradjust.essl","./shaders/blur.essl","./shaders/grayscale.essl","./shaders/lut.essl","./shaders/output.essl"],function(require){var Base=require("core/base");var Scene=require("../scene");var OrthoCamera=require("../camera/orthographic");var Plane=require("../geometry/plane");var Shader=require("../shader");var Material=require("../material");var Mesh=require("../mesh");var Scene=require("../scene");var vertexShaderString=require("./shaders/vertex.essl");var Texture=require("../texture");var WebGLInfo=require("../webglinfo");var planeGeo=new Plane;var mesh=new Mesh({geometry:planeGeo});var scene=new Scene;var camera=new OrthoCamera;scene.add(mesh);var Pass=Base.derive(function(){return{fragment:"",outputs:null,_material:null}},function(){var shader=new Shader({vertex:vertexShaderString,fragment:this.fragment});var material=new Material({shader:shader});shader.enableTexturesAll();this._material=material},{setUniform:function(name,value){var uniform=this._material.uniforms[name];if(uniform){uniform.value=value}else{}},bind:function(renderer,frameBuffer){if(this.outputs){for(var attachment in this.outputs){var texture=this.outputs[attachment];frameBuffer.attach(renderer.gl,texture,attachment)}frameBuffer.bind(renderer)}},unbind:function(renderer,frameBuffer){frameBuffer.unbind(renderer)},render:function(renderer,frameBuffer){var _gl=renderer.gl;mesh.material=this._material;if(frameBuffer){this.bind(renderer,frameBuffer)}var ext=WebGLInfo.getExtension("EXT_draw_buffers");if(ext){var bufs=[];for(var attachment in this.outputs){attachment=parseInt(attachment);if(attachment>=_gl.COLOR_ATTACHMENT0&&attachment<=_gl.COLOR_ATTACHMENT0+8){bufs.push(attachment)}}ext.drawBuffersEXT(bufs)}renderer.render(scene,camera,true);if(frameBuffer){this.unbind(renderer,frameBuffer)}}});Shader.import(require("./shaders/coloradjust.essl"));Shader.import(require("./shaders/blur.essl"));Shader.import(require("./shaders/grayscale.essl"));Shader.import(require("./shaders/lut.essl"));Shader.import(require("./shaders/output.essl"));return Pass});define("3d/framebuffer",["require","core/base","./texture/texture2d","./texture/texturecube","./webglinfo"],function(require){var Base=require("core/base");var Texture2D=require("./texture/texture2d");var TextureCube=require("./texture/texturecube");var WebGLInfo=require("./webglinfo");var FrameBuffer=Base.derive(function(){return{depthBuffer:true,_attachedTextures:{}}},{bind:function(renderer){var _gl=renderer.gl;_gl.bindFramebuffer(_gl.FRAMEBUFFER,this.getFrameBuffer(_gl));this.cache.put("viewport",renderer.viewportInfo);renderer.setViewport(0,0,this.cache.get("width"),this.cache.get("height"));if(this.cache.miss("renderbuffer")&&this.depthBuffer&&!this.cache.get("depth_texture")){this.cache.put("renderbuffer",_gl.createRenderbuffer())}if(!this.cache.get("depth_texture")&&this.depthBuffer){var width=this.cache.get("width"),height=this.cache.get("height"),renderbuffer=this.cache.get("renderbuffer");if(width!==this.cache.get("renderbuffer_width")||height!==this.cache.get("renderbuffer_height")){_gl.bindRenderbuffer(_gl.RENDERBUFFER,renderbuffer);_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.DEPTH_COMPONENT16,width,height);this.cache.put("renderbuffer_width",width);this.cache.put("renderbuffer_height",height);_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}if(!this.cache.get("renderbuffer_attached")){_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,renderbuffer);this.cache.put("renderbuffer_attached",true)}}},unbind:function(renderer){var _gl=renderer.gl;_gl.bindFramebuffer(_gl.FRAMEBUFFER,null);this.cache.use(_gl.__GUID__);var viewportInfo=this.cache.get("viewport");if(viewportInfo){renderer.setViewport(viewportInfo.x,viewportInfo.y,viewportInfo.width,viewportInfo.height)}for(var attachment in this._attachedTextures){var texture=this._attachedTextures[attachment];if(!texture.NPOT&&texture.generateMipmaps){var target=texture.instanceof(TextureCube)?_gl.TEXTURE_CUBE_MAP:_gl.TEXTURE_2D;_gl.bindTexture(target,texture.getWebGLTexture(_gl));_gl.generateMipmap(target);_gl.bindTexture(target,null)}}},getFrameBuffer:function(_gl){this.cache.use(_gl.__GUID__);if(this.cache.miss("framebuffer")){this.cache.put("framebuffer",_gl.createFramebuffer())}return this.cache.get("framebuffer")},attach:function(_gl,texture,attachment,target){if(!texture.width){console.error("The texture attached to color buffer is not a valid.");return}if(this._renderBuffer&&this.depthBuffer&&(this._width!==texture.width||this.height!==texture.height)){console.warn("Attached texture has different width or height, it will cause the render buffer recreate a storage ")}_gl.bindFramebuffer(_gl.FRAMEBUFFER,this.getFrameBuffer(_gl));this.cache.put("width",texture.width);this.cache.put("height",texture.height);target=target||_gl.TEXTURE_2D;attachment=attachment||_gl.COLOR_ATTACHMENT0;if(attachment==="DEPTH_ATTACHMENT"){var extension=WebGLInfo.getExtension("WEBGL_depth_texture");if(!extension){console.error(" Depth texture is not supported by the browser ");return}if(texture.format!=="DEPTH_COMPONENT"){console.error("The texture attached to depth buffer is not a valid.");return}this.cache.put("renderbuffer_attached",false);this.cache.put("depth_texture",true)}this._attachedTextures[attachment]=texture;_gl.framebufferTexture2D(_gl.FRAMEBUFFER,attachment,target,texture.getWebGLTexture(_gl),0);_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)},detach:function(){},dispose:function(_gl){this.cache.use(_gl.__GUID__);if(this.cache.get("renderbuffer"))_gl.deleteRenderbuffer(this.cache.get("renderbuffer"));if(this.cache.get("framebuffer"))_gl.deleteFramebuffer(this.cache.get("framebuffer"));this.cache.clearContext()}});return FrameBuffer});define("3d/compositor/graph/texturepool",["require","../../texture/texture2d","_"],function(require){var Texture2D=require("../../texture/texture2d");var _=require("_");var pool={};var texturePool={get:function(parameters){var key=generateKey(parameters);if(!pool.hasOwnProperty(key)){pool[key]=[]}var list=pool[key];if(!list.length){var texture=new Texture2D(parameters);return texture}return list.pop()},put:function(texture){var key=generateKey(texture);if(!pool.hasOwnProperty(key)){pool[key]=[]}var list=pool[key];list.push(texture)},clear:function(gl){for(name in pool){for(var i=0;i<pool[name].length;i++){pool[name][i].dispose(gl)}}pool={}}};function generateKey(parameters){var defaultParams={width:512,height:512,type:"UNSIGNED_BYTE",format:"RGBA",wrapS:"CLAMP_TO_EDGE",wrapT:"CLAMP_TO_EDGE",minFilter:"LINEAR_MIPMAP_LINEAR",magFilter:"LINEAR",generateMipmaps:true,anisotropy:1,flipY:true,unpackAlignment:4,premultiplyAlpha:false};_.defaults(parameters,defaultParams);fallBack(parameters);var key="";for(var name in defaultParams){if(parameters[name]){var chunk=parameters[name].toString()}else{var chunk=defaultParams[name].toString()}key+=chunk}return key}function fallBack(target){var IPOT=isPowerOfTwo(target.width,target.height);if(target.format==="DEPTH_COMPONENT"){target.generateMipmaps=false}if(!IPOT||!target.generateMipmaps){if(target.minFilter.indexOf("NEAREST")==0){target.minFilter="NEAREST"}else{target.minFilter="LINEAR"}if(target.magFilter.indexOf("NEAREST")==0){target.magFilter="NEAREST"}else{target.magFilter="LINEAR"}target.wrapS="CLAMP_TO_EDGE";target.wrapT="CLAMP_TO_EDGE"}}function isPowerOfTwo(width,height){return(width&width-1)===0&&(height&height-1)===0}return texturePool});define("3d/compositor/graph/node",["require","core/base","../pass","../../framebuffer","../../shader","./texturepool"],function(require){var Base=require("core/base");var Pass=require("../pass");var FrameBuffer=require("../../framebuffer");var Shader=require("../../shader");var texturePool=require("./texturepool");var Node=Base.derive(function(){return{name:"",inputs:{},outputs:null,shader:"",inputLinks:{},outputLinks:{},_textures:{},pass:null,_outputReferences:{}}},function(){if(this.shader){var pass=new Pass({fragment:this.shader});this.pass=pass}if(this.outputs){this.frameBuffer=new FrameBuffer({depthBuffer:false})}},{render:function(renderer){var _gl=renderer.gl;for(var inputName in this.inputLinks){var link=this.inputLinks[inputName];var inputTexture=link.node.getOutput(renderer,link.pin);this.pass.setUniform(inputName,inputTexture)}if(!this.outputs){this.pass.outputs=null;this.pass.render(renderer)}else{this.pass.outputs={};for(var name in this.outputs){var outputInfo=this.outputs[name];var texture=texturePool.get(outputInfo.parameters||{});this._textures[name]=texture;var attachment=outputInfo.attachment||_gl.COLOR_ATTACHMENT0;if(typeof attachment=="string"){attachment=_gl[attachment]}this.pass.outputs[attachment]=texture}this.pass.render(renderer,this.frameBuffer)}for(var inputName in this.inputLinks){var link=this.inputLinks[inputName];link.node.removeReference(link.pin)}},setParameter:function(name,value){this.pass.setUniform(name,value)},setParameters:function(obj){for(var name in obj){this.setParameter(name,obj[name])}},getOutput:function(renderer,name){var outputInfo=this.outputs[name];if(!outputInfo){return}if(this._textures[name]){return this._textures[name]}this.render(renderer);return this._textures[name]},removeReference:function(name){this._outputReferences[name]--;if(this._outputReferences[name]===0){texturePool.put(this._textures[name]);this._textures[name]=null}},link:function(inputPinName,fromNode,fromPinName){this.inputLinks[inputPinName]={node:fromNode,pin:fromPinName};if(!fromNode.outputLinks[fromPinName]){fromNode.outputLinks[fromPinName]=[]}fromNode.outputLinks[fromPinName].push({node:this,pin:inputPinName})},clear:function(){this.inputLinks={};this.outputLinks={}},updateReference:function(){for(var name in this.outputLinks){this._outputReferences[name]=this.outputLinks[name].length}}});return Node});define("3d/compositor/graph/group",["require","./node","./graph"],function(require){var Node=require("./node");var Graph=require("./graph");var Group=Node.derive(function(){return{nodes:[],_textures:{}}},{add:function(node){return Graph.prototype.add.call(this,node)},remove:function(node){return Graph.prototype.remove.call(this,node)},update:function(){return Graph.prototype.update.call(this)},findPin:function(info){return Graph.prototype.findPin.call(this,info)},render:function(renderer){if(this.isDirty("graph")){this.update();this.fresh("graph")}var groupInputTextures={};for(var inputName in this.inputLinks){var link=this.inputLinks[inputName];var inputTexture=link.node.getOutput(renderer,link.pin);groupInputTextures[inputName]=inputTexture}for(var i=0;i<this.nodes.length;i++){var node=this.nodes[i];node.updateReference();if(node.groupInputs){this._updateGroupInputs(node,groupInputTextures)}}for(var i=0;i<this.nodes.length;i++){var node=this.nodes[i];if(node.groupOutputs){this._updateGroupOutputs(node,renderer)}if(!node.outputs){node.render(renderer)}}for(var name in this.groupOutputs){if(!this._textures[name]){console.error('Group output pin "'+name+'" is not attached')}}for(var inputName in this.inputLinks){var link=this.inputLinks[inputName];link.node.removeReference(link.pin)}},_updateGroupInputs:function(node,groupInputTextures){for(var name in groupInputTextures){var texture=groupInputTextures[name];if(node.groupInputs[name]){var pin=node.groupInputs[name];node.pass.setUniform(pin,texture)}}},_updateGroupOutputs:function(node,renderer){for(var name in node.groupOutputs){var groupOutputPinName=node.groupOutputs[name];var texture=node.getOutput(renderer,name);this._textures[groupOutputPinName]=texture}}});return Group});define("3d/compositor/graph/scenenode",["require","./node","../pass","../../framebuffer","./texturepool","../../webglinfo"],function(require){var Node=require("./node");var Pass=require("../pass");var FrameBuffer=require("../../framebuffer");var texturePool=require("./texturepool");var WebGLInfo=require("../../webglinfo");var SceneNode=Node.derive(function(){return{scene:null,camera:null,material:null}},function(){if(this.frameBuffer){this.frameBuffer.depthBuffer=true}},{render:function(renderer){var _gl=renderer.gl;if(!this.outputs){renderer.render(this.scene,this.camera)}else{var frameBuffer=this.frameBuffer;for(var name in this.outputs){var outputInfo=this.outputs[name];var texture=texturePool.get(outputInfo.parameters||{});this._textures[name]=texture;var attachment=outputInfo.attachment||_gl.COLOR_ATTACHMENT0;if(typeof attachment=="string"){attachment=_gl[attachment]}frameBuffer.attach(renderer.gl,texture,attachment)}frameBuffer.bind(renderer);var ext=WebGLInfo.getExtension("EXT_draw_buffers");if(ext){var bufs=[];for(var attachment in this.outputs){attachment=parseInt(attachment);if(attachment>=_gl.COLOR_ATTACHMENT0&&attachment<=_gl.COLOR_ATTACHMENT0+8){bufs.push(attachment)}}ext.drawBuffersEXT(bufs)}if(this.material){this.scene.material=this.material}renderer.render(this.scene,this.camera);this.scene.material=null;frameBuffer.unbind(renderer)}}});return SceneNode});define("3d/compositor/graph/texturenode",["require","./node","../../framebuffer","./texturepool","../../shader"],function(require){var Node=require("./node");
var FrameBuffer=require("../../framebuffer");var texturePool=require("./texturepool");var Shader=require("../../shader");var TextureNode=Node.derive(function(){return{shader:Shader.source("buildin.compositor.output"),texture:null}},{render:function(renderer){var _gl=renderer.gl;this.pass.setUniform("texture",this.texture);if(!this.outputs){this.pass.outputs=null;this.pass.render(renderer)}else{this.pass.outputs={};for(var name in this.outputs){var outputInfo=this.outputs[name];var texture=texturePool.get(outputInfo.parameters||{});this._textures[name]=texture;var attachment=outputInfo.attachment||_gl.COLOR_ATTACHMENT0;if(typeof attachment=="string"){attachment=_gl[attachment]}this.pass.outputs[attachment]=texture}this.pass.render(renderer,this.frameBuffer)}}});return TextureNode});define("3d/light",["require","./node"],function(require){var Node=require("./node");var Light=Node.derive(function(){return{color:[1,1,1],intensity:1,castShadow:true,shadowResolution:512}},{});return Light});define("3d/renderer",["require","core/base","_","glmatrix","util/util","./light","./mesh","./webglinfo"],function(require){var Base=require("core/base");var _=require("_");var glMatrix=require("glmatrix");var mat4=glMatrix.mat4;var util=require("util/util");var Light=require("./light");var Mesh=require("./mesh");var WebGLInfo=require("./webglinfo");var Renderer=Base.derive(function(){return{__GUID__:util.genGUID(),canvas:null,devicePixelRatio:window.devicePixelRatio||1,color:[1,1,1,0],clear:16640,alhpa:true,depth:true,stencil:false,antialias:true,premultipliedAlpha:true,preserveDrawingBuffer:false,gl:null,viewportInfo:{}}},function(){if(!this.canvas){this.canvas=document.createElement("canvas")}try{this.gl=this.canvas.getContext("experimental-webgl",{alhpa:this.alhpa,depth:this.depth,stencil:this.stencil,antialias:this.antialias,premultipliedAlpha:this.premultipliedAlpha,preserveDrawingBuffer:this.preserveDrawingBuffer});this.gl.__GUID__=this.__GUID__;this.resize(this.canvas.width,this.canvas.height);WebGLInfo.initialize(this.gl)}catch(e){throw"Error creating WebGL Context"}},{resize:function(width,height){var canvas=this.canvas;if(this.devicePixelRatio!==1){canvas.style.width=width+"px";canvas.style.height=height+"px"}canvas.width=width*this.devicePixelRatio;canvas.height=height*this.devicePixelRatio;this.setViewport(0,0,canvas.width,canvas.height)},setViewport:function(x,y,width,height){this.gl.viewport(x,y,width,height);this.viewportInfo={x:x,y:y,width:width,height:height}},render:function(scene,camera,silent){var _gl=this.gl;if(!silent){this.trigger("beforerender",scene,camera)}var color=this.color;_gl.clearColor(color[0],color[1],color[2],color[3]);_gl.clear(this.clear);var opaqueQueue=[];var transparentQueue=[];var lights=[];camera.update();scene.update();this._scene=scene;var sceneMaterial=scene.material;scene.traverse(function(node){if(!node.visible){return true}if(node.instanceof(Light)){lights.push(node)}if(!node.render){return}if(sceneMaterial){if(sceneMaterial.transparent){transparentQueue.push(node)}else{opaqueQueue.push(node)}}else{if(!node.material||!node.material.shader){return}if(!node.geometry){return}if(node.material.transparent){transparentQueue.push(node)}else{opaqueQueue.push(node)}}});if(scene.filter){opaqueQueue=_.filter(opaqueQueue,scene.filter);transparentQueue=_.filter(transparentQueue,scene.filter)}var lightNumber={};for(var i=0;i<lights.length;i++){var light=lights[i];if(!lightNumber[light.type]){lightNumber[light.type]=0}lightNumber[light.type]++}scene.lightNumber=lightNumber;this.updateLightUnforms(lights);opaqueQueue.sort(this._materialSortFunc);transparentQueue.sort(this._materialSortFunc);if(!silent){this.trigger("beforerender:opaque",opaqueQueue)}_gl.enable(_gl.DEPTH_TEST);_gl.disable(_gl.BLEND);this.renderQueue(opaqueQueue,camera,sceneMaterial,silent);if(!silent){this.trigger("afterrender:opaque",opaqueQueue);this.trigger("beforerender:transparent",transparentQueue)}_gl.disable(_gl.DEPTH_TEST);_gl.enable(_gl.BLEND);_gl.blendEquation(_gl.FUNC_ADD);_gl.blendFunc(_gl.SRC_ALPHA,_gl.ONE_MINUS_SRC_ALPHA);this.renderQueue(transparentQueue,camera,sceneMaterial,silent);if(!silent){this.trigger("afterrender:transparent",transparentQueue);this.trigger("afterrender",scene,camera)}},updateLightUnforms:function(lights){var lightUniforms=this._scene.lightUniforms;for(var symbol in lightUniforms){lightUniforms[symbol].value.length=0}for(var i=0;i<lights.length;i++){var light=lights[i];for(symbol in light.uniformTemplates){var uniformTpl=light.uniformTemplates[symbol];if(!lightUniforms[symbol]){lightUniforms[symbol]={type:"",value:[]}}var value=uniformTpl.value(light);var lu=lightUniforms[symbol];lu.type=uniformTpl.type+"v";switch(uniformTpl.type){case"1i":case"1f":lu.value.push(value);break;case"2f":case"3f":case"4f":for(var j=0;j<value.length;j++){lu.value.push(value[j])}break;default:console.error("Unkown light uniform type "+uniformTpl.type)}}}},renderQueue:function(queue,camera,globalMaterial,silent){mat4.invert(matrices["VIEW"],camera.worldMatrix._array);mat4.copy(matrices["PROJECTION"],camera.projectionMatrix._array);mat4.multiply(matrices["VIEWPROJECTION"],camera.projectionMatrix._array,matrices["VIEW"]);mat4.copy(matrices["VIEWINVERSE"],camera.worldMatrix._array);mat4.invert(matrices["PROJECTIONINVERSE"],matrices["PROJECTION"]);mat4.invert(matrices["VIEWPROJECTIONINVERSE"],matrices["VIEWPROJECTION"]);var prevMaterialID;var prevShaderID;var _gl=this.gl;var scene=this._scene;for(var i=0;i<queue.length;i++){var object=queue[i];var material=globalMaterial||object.material;var shader=material.shader;var geometry=object.geometry;var customBlend=material.transparent&&material.blend;if(prevShaderID!==shader.__GUID__){var lightNumberChanged=false;if(!_.isEqual(shader.lightNumber,scene.lightNumber)){lightNumberChanged=true}if(lightNumberChanged){for(var type in scene.lightNumber){var number=scene.lightNumber[type];shader.lightNumber[type]=number}shader.update()}shader.bind(_gl);for(var symbol in scene.lightUniforms){var lu=scene.lightUniforms[symbol];shader.setUniform(_gl,lu.type,symbol,lu.value)}prevShaderID=shader.__GUID__}if(prevMaterialID!==material.__GUID__){material.bind(_gl);prevMaterialID=material.__GUID__;Mesh.materialChanged()}if(customBlend){customBlend(_gl)}var worldM=object.worldMatrix._array;if(shader.semantics.hasOwnProperty("WORLD")||shader.semantics.hasOwnProperty("WORLDTRANSPOSE")){mat4.copy(matrices["WORLD"],worldM)}if(shader.semantics.hasOwnProperty("WORLDVIEW")||shader.semantics.hasOwnProperty("WORLDVIEWINVERSE")||shader.semantics.hasOwnProperty("WORLDVIEWINVERSETRANSPOSE")){mat4.multiply(matrices["WORLDVIEW"],matrices["VIEW"],worldM)}if(shader.semantics.hasOwnProperty("WORLDVIEWPROJECTION")||shader.semantics.hasOwnProperty("WORLDVIEWPROJECTIONINVERSE")||shader.semantics.hasOwnProperty("WORLDVIEWPROJECTIONINVERSETRANSPOSE")){mat4.multiply(matrices["WORLDVIEWPROJECTION"],matrices["VIEWPROJECTION"],worldM)}if(shader.semantics.hasOwnProperty("WORLDINVERSE")||shader.semantics.hasOwnProperty("WORLDINVERSETRANSPOSE")){mat4.invert(matrices["WORLDINVERSE"],worldM)}if(shader.semantics.hasOwnProperty("WORLDVIEWINVERSE")||shader.semantics.hasOwnProperty("WORLDVIEWINVERSETRANSPOSE")){mat4.invert(matrices["WORLDVIEWINVERSE"],matrices["WORLDVIEW"])}if(shader.semantics.hasOwnProperty("WORLDVIEWPROJECTIONINVERSE")||shader.semantics.hasOwnProperty("WORLDVIEWPROJECTIONINVERSETRANSPOSE")){mat4.invert(matrices["WORLDVIEWPROJECTIONINVERSE"],matrices["WORLDVIEWPROJECTION"])}for(var semantic in matrices){if(shader.semantics.hasOwnProperty(semantic)){var matrix=matrices[semantic];var semanticInfo=shader.semantics[semantic];shader.setUniform(_gl,semanticInfo.type,semanticInfo.symbol,matrix)}var semanticTranspose=semantic+"TRANSPOSE";if(shader.semantics.hasOwnProperty(semantic+"TRANSPOSE")){var matrixTranspose=matrices[semantic+"TRANSPOSE"];var matrix=matrices[semantic];var semanticTransposeInfo=shader.semantics[semantic+"TRANSPOSE"];mat4.transpose(matrixTranspose,matrix);shader.setUniform(_gl,semanticTransposeInfo.type,semanticTransposeInfo.symbol,matrixTranspose)}}if(!silent){this.trigger("beforerender:mesh",object)}var drawInfo=object.render(this,globalMaterial);if(!silent){this.trigger("afterrender:mesh",object,drawInfo)}if(customBlend){_gl.blendEquation(_gl.FUNC_ADD);_gl.blendFunc(_gl.SRC_ALPHA,_gl.ONE_MINUS_SRC_ALPHA)}}},_materialSortFunc:function(x,y){if(x.material.shader==y.material.shader){return x.material.__GUID__-y.material.__GUID__}return x.material.shader.__GUID__-y.material.__GUID__}});var matrices={WORLD:mat4.create(),VIEW:mat4.create(),PROJECTION:mat4.create(),WORLDVIEW:mat4.create(),VIEWPROJECTION:mat4.create(),WORLDVIEWPROJECTION:mat4.create(),WORLDINVERSE:mat4.create(),VIEWINVERSE:mat4.create(),PROJECTIONINVERSE:mat4.create(),WORLDVIEWINVERSE:mat4.create(),VIEWPROJECTIONINVERSE:mat4.create(),WORLDVIEWPROJECTIONINVERSE:mat4.create(),WORLDTRANSPOSE:mat4.create(),VIEWTRANSPOSE:mat4.create(),PROJECTIONTRANSPOSE:mat4.create(),WORLDVIEWTRANSPOSE:mat4.create(),VIEWPROJECTIONTRANSPOSE:mat4.create(),WORLDVIEWPROJECTIONTRANSPOSE:mat4.create(),WORLDINVERSETRANSPOSE:mat4.create(),VIEWINVERSETRANSPOSE:mat4.create(),PROJECTIONINVERSETRANSPOSE:mat4.create(),WORLDVIEWINVERSETRANSPOSE:mat4.create(),VIEWPROJECTIONINVERSETRANSPOSE:mat4.create(),WORLDVIEWPROJECTIONINVERSETRANSPOSE:mat4.create()};return Renderer});define("core/event",["require","./base"],function(require){var Base=require("./base");var Event=Base.derive({cancelBubble:false},{stopPropagation:function(){this.cancelBubble=true}});Event.throw=function(eventType,target,props){var e=new MouseEvent(props);e.sourceTarget=target;while(target&&!e.cancelBubble){e.target=target;target.trigger(eventType,e);target=target.parent}}});define("core/request",["require"],function(require){function get(options){var xhr=new XMLHttpRequest;xhr.open("get",options.url);xhr.responseType=options.responseType||"text";if(options.onprogress){xhr.onprogress=function(e){if(e.lengthComputable){var percent=e.loaded/e.total;options.onprogress(percent,e.loaded,e.total)}else{options.onprogress(null)}}}xhr.onload=function(e){options.onload&&options.onload(xhr.response)};if(options.onerror){xhr.onerror=options.onerror}xhr.send(null)}function put(options){}return{get:get,put:put}});define("core/vector2",function(){});define("core/vector4",["require","glmatrix"],function(require){var glMatrix=require("glmatrix");var vec4=glMatrix.vec4;var Vector4=function(x,y,z,w){x=x||0;y=y||0;z=z||0;w=w||0;return Object.create(Vector4Proto,{x:{configurable:false,set:function(value){this._array[0]=value;this._dirty=true},get:function(){return this._array[0]}},y:{configurable:false,set:function(value){this._array[1]=value;this._dirty=true},get:function(){return this._array[1]}},z:{configurable:false,set:function(value){this._array[2]=value;this._dirty=true},get:function(){return this._array[2]}},w:{configurable:false,set:function(value){this._array[2]=value;this._dirty=true},get:function(){return this._array[2]}},_array:{writable:false,configurable:false,value:vec4.fromValues(x,y,z,w)},_dirty:{configurable:false,value:false}})};var Vector4Proto={constructor:Vector4,add:function(b){vec4.add(this._array,this._array,b._array);this._dirty=true;return this},set:function(x,y,z,w){this._array[0]=x;this._array[1]=y;this._array[2]=z;this._array[3]=w;this._dirty=true;return this},clone:function(){return new Vector4(this.x,this.y,this.z,this.w)},copy:function(b){vec4.copy(this._array,b._array);this._dirty=true;return this},cross:function(out,b){vec4.cross(out._array,this._array,b._array);return this},dist:function(b){return vec4.dist(this._array,b._array)},distance:function(b){return vec4.distance(this._array,b._array)},div:function(b){vec4.div(this._array,this._array,b._array);this._dirty=true;return this},divide:function(b){vec4.divide(this._array,this._array,b._array);this._dirty=true;return this},dot:function(b){return vec4.dot(this._array,b._array)},len:function(){return vec4.len(this._array)},length:function(){return vec4.length(this._array)},lerp:function(a,b,t){vec4.lerp(this._array,a._array,b._array,t);this._dirty=true;return this},mul:function(b){vec4.mul(this._array,this._array,b._array);this._dirty=true;return this},multiply:function(b){vec4.multiply(this._array,this._array,b._array);this._dirty=true;return this},negate:function(){vec4.negate(this._array,this._array);this._dirty=true;return this},normalize:function(){vec4.normalize(this._array,this._array);this._dirty=true;return this},random:function(scale){vec4.random(this._array,scale);this._dirty=true;return this},scale:function(s){vec4.scale(this._array,this._array,s);this._dirty=true;return this},scaleAndAdd:function(b,s){vec4.scaleAndAdd(this._array,this._array,b._array,s);this._dirty=true;return this},sqrDist:function(b){return vec4.sqrDist(this._array,b._array)},squaredDistance:function(b){return vec4.squaredDistance(this._array,b._array)},sqrLen:function(){return vec4.sqrLen(this._array)},squaredLength:function(){return vec4.squaredLength(this._array)},sub:function(b){vec4.sub(this._array,this._array,b._array);this._dirty=true;return this},subtract:function(b){vec4.subtract(this._array,this._array,b._array);this._dirty=true;return this},transformMat4:function(m){vec4.transformMat4(this._array,this._array,m._array);this._dirty=true;return this},transformQuat:function(q){vec4.transformQuat(this._array,this._array,q._array);this._dirty=true;return this},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}};return Vector4});define("util/color",["require"],function(require){});define("util/xmlparser",["require"],function(require){});define("qtekimage",["require","./2d/camera","./2d/node","./2d/renderable/arc","./2d/renderable/circle","./2d/renderable/image","./2d/renderable/line","./2d/renderable/path","./2d/renderable/polygon","./2d/renderable/rectangle","./2d/renderable/roundedrectangle","./2d/renderable/sector","./2d/renderable/text","./2d/renderable/textbox","./2d/renderer","./2d/scene","./2d/style","./2d/util","./3d/camera","./3d/camera/orthographic","./3d/compositor","./3d/compositor/graph/graph","./3d/compositor/graph/group","./3d/compositor/graph/node","./3d/compositor/graph/scenenode","./3d/compositor/graph/texturenode","./3d/compositor/graph/texturepool","./3d/compositor/pass","./3d/framebuffer","./3d/geometry","./3d/geometry/plane","./3d/light","./3d/material","./3d/mesh","./3d/node","./3d/renderer","./3d/scene","./3d/shader","./3d/texture","./3d/texture/texture2d","./3d/webglinfo","./core/base","./core/cache","./core/event","./core/matrix3","./core/matrix4","./core/mixin/derive","./core/mixin/dirty","./core/mixin/notifier","./core/quaternion","./core/request","./core/vector2","./core/vector3","./core/vector4","./util/color","./util/util","./util/xmlparser","glmatrix"],function(require){var exportsObject={"2d":{Camera:require("./2d/camera"),Node:require("./2d/node"),renderable:{Arc:require("./2d/renderable/arc"),Circle:require("./2d/renderable/circle"),Image:require("./2d/renderable/image"),Line:require("./2d/renderable/line"),Path:require("./2d/renderable/path"),Polygon:require("./2d/renderable/polygon"),Rectangle:require("./2d/renderable/rectangle"),RoundedRectangle:require("./2d/renderable/roundedrectangle"),Sector:require("./2d/renderable/sector"),Text:require("./2d/renderable/text"),TextBox:require("./2d/renderable/textbox")},Renderer:require("./2d/renderer"),Scene:require("./2d/scene"),Style:require("./2d/style"),util:require("./2d/util")},"3d":{Camera:require("./3d/camera"),camera:{Orthographic:require("./3d/camera/orthographic")},Compositor:require("./3d/compositor"),compositor:{graph:{Graph:require("./3d/compositor/graph/graph"),Group:require("./3d/compositor/graph/group"),Node:require("./3d/compositor/graph/node"),SceneNode:require("./3d/compositor/graph/scenenode"),TextureNode:require("./3d/compositor/graph/texturenode"),TexturePool:require("./3d/compositor/graph/texturepool")},Pass:require("./3d/compositor/pass")},FrameBuffer:require("./3d/framebuffer"),Geometry:require("./3d/geometry"),geometry:{Plane:require("./3d/geometry/plane")},Light:require("./3d/light"),Material:require("./3d/material"),Mesh:require("./3d/mesh"),Node:require("./3d/node"),Renderer:require("./3d/renderer"),Scene:require("./3d/scene"),Shader:require("./3d/shader"),Texture:require("./3d/texture"),texture:{Texture2D:require("./3d/texture/texture2d")},WebGLInfo:require("./3d/webglinfo")},core:{Base:require("./core/base"),Cache:require("./core/cache"),Event:require("./core/event"),Matrix3:require("./core/matrix3"),Matrix4:require("./core/matrix4"),mixin:{derive:require("./core/mixin/derive"),Dirty:require("./core/mixin/dirty"),notifier:require("./core/mixin/notifier")},Quaternion:require("./core/quaternion"),requester:require("./core/request"),Vector2:require("./core/vector2"),Vector3:require("./core/vector3"),Vector4:require("./core/vector4")},util:{Color:require("./util/color"),Util:require("./util/util"),Xmlparser:require("./util/xmlparser")}};var glMatrix=require("glmatrix");exportsObject.math=glMatrix;return exportsObject});var qtek=require("qtekimage");for(var name in qtek){_exports[name]=qtek[name]}});define("src/fx",["require","qtek"],function(require){var qtek=require("qtek");var qtek3d=qtek["3d"];var FX=function(){this.node=null;this.input=null;this.parameters={};this.imageSize={width:512,height:512};Object.defineProperty(this,"input",{set:function(value){if(this.node){this.node.inputs.texture.node=value}},get:function(){return this.node.inputs.texture.node}})};FX.prototype.reset=function(){};FX.prototype.dispose=function(){};FX.prototype.setImageSize=function(width,height){if(!this.node){return}if(this.node.instanceof(qtek3d.compositor.graph.Group)){for(var i=0;i<this.node.nodes.length;i++){var node=this.node.nodes[i];node.setParameters({imageWidth:width,imageHeight:height});if(node.outputs){for(var name in node.outputs){var info=node.outputs[name];if(!info.parameters){info.parameters={width:width,height:height}}else if(!info.parameters.width){info.parameters.width=width;info.parameters.height=height}}}}}else{this.node.setParameters({imageWidth:width,imageHeight:height});var node=this.node;if(node.outputs){for(var name in node.outputs){var info=node.outputs[name];if(!info.parameters){info.parameters={width:width,height:height}}else if(!info.parameters.width){info.parameters.width=width;info.parameters.height=height}}}}};var fxFactory={};FX.export=function(name,constructor){fxFactory[name]=constructor};FX.create=function(name){if(fxFactory[name]){var fx=new fxFactory[name]}else{console.error("FX "+name+" not exist");return}return fx};return FX});define("src/buildin/gaussian",["require","qtek","../fx"],function(require){var qtek=require("qtek");var qtek3d=qtek["3d"];var FX=require("../fx");var Gaussian=function(){FX.call(this);this.node=new qtek3d.compositor.graph.Group({inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});var gaussian_h=new qtek3d.compositor.graph.Node({name:"gaussian_h",shader:qtek3d.Shader.source("buildin.compositor.gaussian_blur_h"),groupInputs:{texture:"texture"},outputs:{color:{parameters:this.imageSize}}});var gaussian_v=new qtek3d.compositor.graph.Node({name:"gaussian_v",shader:qtek3d.Shader.source("buildin.compositor.gaussian_blur_v"),inputs:{texture:{node:gaussian_h,pin:"color"}},outputs:{color:{parameters:this.imageSize}},groupOutputs:{color:"color"}});this.node.add(gaussian_h);this.node.add(gaussian_v);var blurSize=2;this.parameters={blurSize:{max:10,min:0,step:.1,ui:"slider",get value(){return blurSize},set value(val){blurSize=val;gaussian_v.setParameter("blurSize",val);gaussian_h.setParameter("blurSize",val)}}};this.reset()};Gaussian.prototype=new FX;Gaussian.prototype.reset=function(){this.parameters.blurSize.value=2};Gaussian.prototype.constructor=Gaussian;FX.export("buildin.gaussian",Gaussian);return Gaussian});define("shaders/hexagonal_blur.essl",[],function(){return"@export emage.hexagonal_blur_1\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color = vec4(0.0);\n   // Top\n   for(int i = 0; i < 30; i++){\n      color += 1.0/30.0 * texture2D(texture, v_Texcoord + vec2(0.0, offset.y * float(i)) );\n   }\n   gl_FragColor = color;\n}\n\n@end\n\n@export emage.hexagonal_blur_2\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 30; i++){\n      color += 1.0/30.0 * texture2D(texture, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   gl_FragColor = color;\n}\n@end\n\n@export emage.hexagonal_blur_3\n\nuniform sampler2D texture1;\nuniform sampler2D texture2;\n\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform float imageWidth : 1.0;\nuniform float imageHeight : 1.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color1 = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 30; i++){\n      color1 += 1.0/30.0 * texture2D(texture1, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   vec4 color2 = vec4(0.0);\n   // Down right\n   for(int i = 0; i < 30; i++){\n      color2 += 1.0/30.0 * texture2D(texture1, v_Texcoord + vec2(offset.x * float(i), -offset.y * float(i)) );\n   }\n\n   vec4 color3 = vec4(0.0);\n   // Down right\n   for(int i = 0; i < 30; i++){\n      color3 += 1.0/30.0 * texture2D(texture2, v_Texcoord + vec2(offset.x * float(i), -offset.y * float(i)) );\n   }\n\n   gl_FragColor = (color1 + color2 + color3) / 3.0;\n}\n\n@end"});define("shaders/gamma.essl",[],function(){return"varying vec2 v_Texcoord;\n\nuniform sampler2D texture;\nuniform float gamma : 1.0;\n\nvoid main()\n{\n    vec4 tex = texture2D(texture, v_Texcoord);\n\n    gl_FragColor = vec4(pow(tex.rgb, vec3(gamma)), tex.a);\n}"});define("src/buildin/lensblur",["require","qtek","../fx","shaders/hexagonal_blur.essl","shaders/gamma.essl","shaders/gamma.essl"],function(require){var qtek=require("qtek");var qtek3d=qtek["3d"];var FX=require("../fx");qtek3d.Shader.import(require("shaders/hexagonal_blur.essl"));var LensBlur=function(){FX.call(this);this.node=new qtek3d.compositor.graph.Group({inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});var floatTextureParam={width:1024,height:1024,type:"FLOAT"};var gammaNode=new qtek3d.compositor.graph.Node({shader:require("shaders/gamma.essl"),groupInputs:{texture:"texture"},outputs:{color:{parameters:floatTextureParam}}});var blurPass1=new qtek3d.compositor.graph.Node({shader:qtek3d.Shader.source("emage.hexagonal_blur_1"),inputs:{texture:{node:gammaNode,pin:"color"}},outputs:{color:{parameters:floatTextureParam}}});var blurPass2=new qtek3d.compositor.graph.Node({shader:qtek3d.Shader.source("emage.hexagonal_blur_2"),inputs:{texture:{node:gammaNode,pin:"color"}},outputs:{color:{parameters:floatTextureParam}}});var blurPass3=new qtek3d.compositor.graph.Node({shader:qtek3d.Shader.source("emage.hexagonal_blur_3"),inputs:{texture1:{node:blurPass1,pin:"color"},texture2:{node:blurPass2,pin:"color"}},outputs:{color:{parameters:floatTextureParam}}});var gammaInverseNode=new qtek3d.compositor.graph.Node({shader:require("shaders/gamma.essl"),inputs:{texture:{node:blurPass3,pin:"color"}},outputs:{color:{parameters:{width:1024,height:1024}}},groupOutputs:{color:"color"}});this.node.add(gammaNode);this.node.add(blurPass1);this.node.add(blurPass2);this.node.add(blurPass3);this.node.add(gammaInverseNode);var blurSize=1;var brightness=6;this.parameters={blurSize:{max:10,min:0,step:.1,ui:"slider",get value(){return blurSize},set value(val){blurSize=val;blurPass1.setParameter("blurSize",val);blurPass2.setParameter("blurSize",val);blurPass3.setParameter("blurSize",val)}},brightness:{max:10,min:0,step:.1,ui:"slider",get value(){return brightness},set value(val){brightness=val;gammaNode.setParameter("gamma",val);gammaInverseNode.setParameter("gamma",1/val)}}};this.reset()};LensBlur.prototype=new FX;LensBlur.prototype.reset=function(){this.parameters.blurSize.value=.4;this.parameters.brightness.value=6};LensBlur.prototype.constructor=LensBlur;FX.export("buildin.lensblur",LensBlur);return LensBlur});define("src/buildin/coloradjust",["require","qtek","../fx"],function(require){var qtek=require("qtek");var qtek3d=qtek["3d"];var FX=require("../fx");var ColorAdjust=function(){FX.call(this);var node=new qtek3d.compositor.graph.Node({shader:qtek3d.Shader.source("buildin.compositor.coloradjust"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=node;var brightness=0,contrast=1,exposure=0,gamma=1,saturation=1;this.parameters={brightness:{max:1,min:-1,step:.1,ui:"slider",get value(){return brightness},set value(val){brightness=val;node.setParameter("brightness",val)}},contrast:{max:4,min:0,step:.1,ui:"slider",get value(){return contrast},set value(val){contrast=val;node.setParameter("contrast",val)}},exposure:{max:10,min:-10,step:.1,ui:"slider",get value(){return exposure},set value(val){exposure=val;node.setParameter("exposure",val)}},gamma:{max:3,min:0,step:.1,ui:"slider",get value(){return gamma},set value(val){gamma=val;node.setParameter("gamma",val)}},saturation:{max:10,min:0,step:.1,ui:"slider",get value(){return saturation},set value(val){saturation=val;node.setParameter("saturation",val)}}};this.reset()};ColorAdjust.prototype=new FX;ColorAdjust.prototype.reset=function(){this.parameters.brightness.value=0;this.parameters.exposure.value=0;this.parameters.contrast.value=1;this.parameters.saturation.value=1;this.parameters.gamma.value=1};ColorAdjust.prototype.constructor=ColorAdjust;FX.export("buildin.coloradjust",ColorAdjust);return ColorAdjust});define("shaders/hue.essl",[],function(){return"varying vec2 v_Texcoord;\n\nuniform sampler2D texture;\nuniform float hueAdjust;\n\nconst vec4 kRGBToYPrime = vec4 (0.299, 0.587, 0.114, 0.0);\nconst vec4 kRGBToI     = vec4 (0.595716, -0.274453, -0.321263, 0.0);\nconst vec4 kRGBToQ     = vec4 (0.211456, -0.522591, 0.31135, 0.0);\n \nconst vec4 kYIQToR   = vec4 (1.0, 0.9563, 0.6210, 0.0);\nconst vec4 kYIQToG   = vec4 (1.0, -0.2721, -0.6474, 0.0);\nconst vec4 kYIQToB   = vec4 (1.0, -1.1070, 1.7046, 0.0);\n \n\n\n void main ()\n {\n     // Sample the input pixel\n    vec4 color   = texture2D(texture, v_Texcoord);\n     \n     // Convert to YIQ\n    float YPrime  = dot (color, kRGBToYPrime);\n    float I      = dot (color, kRGBToI);\n    float Q      = dot (color, kRGBToQ);\n     \n     // Calculate the hue and chroma\n    float hue     = atan (Q, I);\n    float chroma  = sqrt (I * I + Q * Q);\n     \n    // Make the user's adjustments\n    hue += (-hueAdjust); //why negative rotation?\n     \n    // Convert back to YIQ\n    Q = chroma * sin (hue);\n    I = chroma * cos (hue);\n     \n     // Convert back to RGB\n    vec4 yIQ = vec4 (YPrime, I, Q, 0.0);\n    color.r = dot (yIQ, kYIQToR);\n    color.g = dot (yIQ, kYIQToG);\n    color.b = dot (yIQ, kYIQToB);\n     \n    // Save the result\n    gl_FragColor = color;\n }"});define("src/buildin/hue",["require","qtek","../fx","shaders/hue.essl"],function(require){var qtek=require("qtek");var qtek3d=qtek["3d"];var FX=require("../fx");var Hue=function(){FX.call(this);var node=new qtek3d.compositor.graph.Node({shader:require("shaders/hue.essl"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=node;var hue=0;this.parameters={hue:{max:180,min:-180,precision:1,ui:"slider",get value(){return hue},set value(val){hue=val;node.setParameter("hueAdjust",val/180*Math.PI)}}};this.reset()};Hue.prototype=new FX;Hue.prototype.constructor=Hue;Hue.prototype.reset=function(){this.parameters.hue.value=0};FX.export("buildin.hue",Hue);return Hue});define("shaders/colormatrix.essl",[],function(){return"varying vec2 v_Texcoord;\n\nuniform sampler2D texture;\n\nuniform mat4 colorMatrix;\nuniform float intensity : 1.0;\n\nvoid main()\n{\n    vec4 tex = texture2D(texture, v_Texcoord);\n    vec4 outputColor = tex * colorMatrix;\n\n    gl_FragColor = intensity * outputColor + ( (1.0-intensity) * tex );\n}"});define("src/buildin/colormatrix",["require","qtek","../fx","shaders/colormatrix.essl"],function(require){var qtek=require("qtek");var qtek3d=qtek["3d"];var FX=require("../fx");var ColorMatrix=function(){FX.call(this);var node=new qtek3d.compositor.graph.Node({shader:require("shaders/colormatrix.essl"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=node;var colorMatrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);var intensity=1;this.parameters={colorMatrix:{get value(){return colorMatrix},set value(val){colorMatrix=val;node.setParameter("colorMatrix",val)}},intensity:{min:0,max:1,ui:"slider",step:.01,get intensity(){return intensity},set intensity(val){intensity=val;node.setParameter("intensity",val)}}}};ColorMatrix.prototype=new FX;ColorMatrix.prototype.constructor=ColorMatrix;FX.export("buildin.colormatrix",ColorMatrix);return ColorMatrix});define("src/buildin/sepia",["require","qtek","./colormatrix","../fx"],function(require){var qtek=require("qtek");var qtek3d=qtek["3d"];var ColorMatrix=require("./colormatrix");var FX=require("../fx");var Sepia=function(){ColorMatrix.call(this);this.parameters.colorMatrix.value=new Float32Array([.3588,.7044,.1368,0,.299,.587,.114,0,.2392,.4696,.0912,0,0,0,0,1])};Sepia.prototype=new ColorMatrix;Sepia.prototype.constructor=Sepia;FX.export("buildin.sepia",Sepia);return Sepia});define("shaders/lut.essl",[],function(){return"varying vec2 v_Texcoord;\n\nuniform sampler2D texture;\nuniform sampler2D lookup;\n\nvoid main()\n{\n    vec4 tex = texture2D(texture, v_Texcoord);\n\n    float blueColor = tex.b * 63.0;\n    \n    vec2 quad1;\n    quad1.y = floor(floor(blueColor) / 8.0);\n    quad1.x = floor(blueColor) - (quad1.y * 8.0);\n    \n    vec2 quad2;\n    quad2.y = floor(ceil(blueColor) / 8.0);\n    quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n    \n    vec2 texPos1;\n    texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.r);\n    texPos1.y = (quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.g);\n    \n    vec2 texPos2;\n    texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.r);\n    texPos2.y = (quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.g);\n    \n    vec4 newColor1 = texture2D(lookup, texPos1);\n    vec4 newColor2 = texture2D(lookup, texPos2);\n    \n    vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n    gl_FragColor = vec4(newColor.rgb, tex.w);\n}"});define("src/buildin/lut",["require","qtek","../fx","shaders/lut.essl"],function(require){var qtek=require("qtek");var qtek3d=qtek["3d"];var FX=require("../fx");var LUT=function(){FX.call(this);var node=new qtek3d.compositor.graph.Node({shader:require("shaders/lut.essl"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=node;var lookup=new qtek3d.texture.Texture2D({minFilter:"NEAREST",magFilter:"NEAREST",generateMipmaps:false,flipY:false});node.setParameter("lookup",lookup);this.parameters={lookup:{get value(){return lookup.image},set value(val){lookup.image=val;lookup.dirty()}}}};LUT.prototype=new FX;LUT.prototype.constructor=LUT;FX.export("buildin.lut",LUT);return LUT});define("shaders/sobel.essl",[],function(){return"// Sobel edge detection\n// http://en.wikipedia.org/wiki/Sobel_operator\n//\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float imageWidth : 512;\nuniform float imageHeight : 512;\n\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\nfloat luminance(vec4 color){\n    return dot(color.rgb, w);\n}\n\nvoid main(){\n\n	vec2 offset = vec2(1.0/imageWidth, 1.0/imageHeight);\n\n	// top left\n	float topLeft = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, -offset.y)) );\n	// top\n	float top = luminance( texture2D(texture, v_Texcoord+vec2(0, -offset.y)) );\n	// top right\n	float topRight = luminance( texture2D(texture, v_Texcoord+vec2(offset.x, -offset.y)) );\n	// left\n	float left = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, 0)) );\n	// center\n	float center = luminance( texture2D( texture, v_Texcoord) );\n	// right\n	float right = luminance( texture2D(texture, v_Texcoord+vec2(offset.x, 0)) );\n	// bottom left\n	float bottomLeft = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, offset.y)) );\n	// bottom\n	float bottom = luminance( texture2D(texture, v_Texcoord+vec2(0, offset.y)) );\n	// bottom right\n	float bottomRight = luminance( texture2D(texture, v_Texcoord+offset) );\n\n	float h = -topLeft-2.0*top-topRight+bottomLeft+2.0*bottom+bottomRight;\n	float v = -bottomLeft-2.0*left-topLeft+bottomRight+2.0*right+topRight;\n\n	float mag = length(vec2(h,v));\n	gl_FragColor = vec4(vec3(mag), 1.0);\n}"
});define("src/buildin/sobel",["require","qtek","../fx","shaders/sobel.essl"],function(require){var qtek=require("qtek");var qtek3d=qtek["3d"];var FX=require("../fx");var Sobel=function(){FX.call(this);var node=new qtek3d.compositor.graph.Node({shader:require("shaders/sobel.essl"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=node};Sobel.prototype=new FX;Sobel.prototype.constructor=Sobel;FX.export("buildin.sobel",Sobel);return Sobel});define("shaders/sketch.essl",[],function(){return"varying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float imageWidth : 512;\nuniform float imageHeight : 512;\n\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\nfloat luminance(vec4 color){\n    return dot(color.rgb, w);\n}\n\nvoid main(){\n\n	vec2 offset = vec2(1.0/imageWidth, 1.0/imageHeight);\n\n	// top left\n	float topLeft = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, -offset.y)) );\n	// top\n	float top = luminance( texture2D(texture, v_Texcoord+vec2(0, -offset.y)) );\n	// top right\n	float topRight = luminance( texture2D(texture, v_Texcoord+vec2(offset.x, -offset.y)) );\n	// left\n	float left = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, 0)) );\n	// center\n	float center = luminance( texture2D( texture, v_Texcoord) );\n	// right\n	float right = luminance( texture2D(texture, v_Texcoord+vec2(offset.x, 0)) );\n	// bottom left\n	float bottomLeft = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, offset.y)) );\n	// bottom\n	float bottom = luminance( texture2D(texture, v_Texcoord+vec2(0, offset.y)) );\n	// bottom right\n	float bottomRight = luminance( texture2D(texture, v_Texcoord+offset) );\n\n	float h = -topLeft-2.0*top-topRight+bottomLeft+2.0*bottom+bottomRight;\n	float v = -bottomLeft-2.0*left-topLeft+bottomRight+2.0*right+topRight;\n\n	float mag = 1.0 - length(vec2(h, v));\n\n	gl_FragColor = vec4(vec3(mag), 1.0);\n}"});define("src/buildin/sketch",["require","qtek","../fx","shaders/sketch.essl"],function(require){var qtek=require("qtek");var qtek3d=qtek["3d"];var FX=require("../fx");var Sketch=function(){FX.call(this);var node=new qtek3d.compositor.graph.Node({shader:require("shaders/sketch.essl"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=node};Sketch.prototype=new FX;Sketch.prototype.constructor=Sketch;FX.export("buildin.sketch",Sketch);return Sketch});define("shaders/toon.essl",[],function(){return"varying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float imageWidth;\nuniform float imageHeight;\n\nuniform float threshold : 0.2;\nuniform float quantizationLevels : 10;\n\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\nfloat luminance(vec4 color){\n    return dot(color.rgb, w);\n}\n\nvoid main(){\n\n    vec2 offset = vec2(1.0/imageWidth, 1.0/imageHeight);\n    vec4 tex = texture2D(texture, v_Texcoord);\n    // top left\n    float topLeft = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, -offset.y)) );\n    // top\n    float top = luminance( texture2D(texture, v_Texcoord+vec2(0, -offset.y)) );\n    // top right\n    float topRight = luminance( texture2D(texture, v_Texcoord+vec2(offset.x, -offset.y)) );\n    // left\n    float left = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, 0)) );\n    // center\n    float center = luminance( texture2D( texture, v_Texcoord) );\n    // right\n    float right = luminance( texture2D(texture, v_Texcoord+vec2(offset.x, 0)) );\n    // bottom left\n    float bottomLeft = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, offset.y)) );\n    // bottom\n    float bottom = luminance( texture2D(texture, v_Texcoord+vec2(0, offset.y)) );\n    // bottom right\n    float bottomRight = luminance( texture2D(texture, v_Texcoord+offset) );\n\n    float h = -topLeft-2.0*top-topRight+bottomLeft+2.0*bottom+bottomRight;\n    float v = -bottomLeft-2.0*left-topLeft+bottomRight+2.0*right+topRight;\n\n    float mag = length(vec2(h, v));\n    \n    vec3 posterizedImageColor = floor((tex.rgb * quantizationLevels) + 0.5) / quantizationLevels;\n    float thresholdTest = 1.0 - step(threshold, mag);\n    \n    gl_FragColor = vec4(posterizedImageColor * thresholdTest, tex.a);\n}"});define("src/buildin/toon",["require","qtek","../fx","shaders/toon.essl"],function(require){var qtek=require("qtek");var qtek3d=qtek["3d"];var FX=require("../fx");var Toon=function(){FX.call(this);var node=new qtek3d.compositor.graph.Node({shader:require("shaders/toon.essl"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=node;var threshold=.2,quantizationLevels=10;this.parameters={threshold:{ui:"slider",min:0,max:2,get value(){return threshold},set value(val){threshold=val;node.setParameter("threshold",val)}},quantizationLevels:{ui:"spinner",min:2,precision:0,get value(){return quantizationLevels},set value(val){quantizationLevels=val;node.setParameter("quantizationLevels",val)}}}};Toon.prototype=new FX;Toon.prototype.constructor=Toon;Toon.prototype.reset=function(){this.parameters.threshold.value=.2;this.parameters.quantizationLevels.value=10};FX.export("buildin.toon",Toon);return Toon});define("src/buildin/grayscale",["require","qtek","../fx"],function(require){var qtek=require("qtek");var qtek3d=qtek["3d"];var FX=require("../fx");var GrayScale=function(){FX.call(this);var node=new qtek3d.compositor.graph.Node({shader:qtek3d.Shader.source("buildin.compositor.grayscale"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=node};GrayScale.prototype=new FX;GrayScale.prototype.constructor=GrayScale;FX.export("buildin.grayscale",GrayScale);return GrayScale});define("src/layer",["require","qtek","./fx","./buildin/gaussian","./buildin/lensblur","./buildin/coloradjust","./buildin/hue","./buildin/colormatrix","./buildin/sepia","./buildin/lut","./buildin/sobel","./buildin/sketch","./buildin/toon","./buildin/grayscale"],function(require){var qtek=require("qtek");var FX=require("./fx");var Layer=function(fxName){this.fx=null;this.enabled=true;this.prevSibling=null;this.nextSibling=null;this._fxCaches={};if(fxName){this.use(fxName)}};Layer.prototype.use=function(fxName){var fx=this._fxCaches[fxName];if(!fx){fx=FX.create(fxName)}else{fx.reset()}if(fx){fx.input=this.prevSibling;this._fxCaches[fxName]=fx;this.fx=fx;return fx}};Layer.prototype.set=function(name,value){if(!name){return}if(typeof name==="object"){var obj=name;for(var name in obj){this.set(name,obj[name])}return}if(this.fx&&this.fx.parameters[name]){this.fx.parameters[name].value=value}};require("./buildin/gaussian");require("./buildin/lensblur");require("./buildin/coloradjust");require("./buildin/hue");require("./buildin/colormatrix");require("./buildin/sepia");require("./buildin/lut");require("./buildin/sobel");require("./buildin/sketch");require("./buildin/toon");require("./buildin/grayscale");return Layer});define("src/processor",["require","qtek","./layer","./fx"],function(require){var qtek=require("qtek");var qtek3d=qtek["3d"];var Layer=require("./layer");var FX=require("./fx");var Processor=function(canvas){this.canvas=canvas||document.createElement("canvas");this.renderer=new qtek3d.Renderer({canvas:this.canvas,devicePixelRatio:1});this.scale=1;this.compositor=new qtek3d.Compositor;this.layers=[];this._inputNode=new qtek3d.compositor.graph.TextureNode({texture:new qtek3d.texture.Texture2D({image:null}),outputs:{color:{parameters:{width:1024,height:1024}}}});this._outputNode=new qtek3d.compositor.graph.Node({shader:qtek3d.Shader.source("buildin.compositor.output"),inputs:{texture:{node:null,pin:"color"}}});this._imageChanged=true;Object.defineProperty(this,"image",{set:function(value){this._inputNode.texture.image=value;this._inputNode.texture.dirty();this._imageChanged=true},get:function(value){return this._inputNode.texture.image}})};Processor.prototype.add=function(layer){this.layers.push(layer)};Processor.prototype.remove=function(layer){var idx=this.layers.indexOf(layer);this.layers.splice(idx,1)};Processor.prototype.update=function(){var layers=[];for(var i=0;i<this.layers.length;i++){var layer=this.layers[i];if(layer.enabled&&layer.fx){layers.push(this.layers[i])}}for(var i=0;i<layers.length;i++){var layer=layers[i],layerPrev=layers[i-1]||null,layerNext=layers[i+1]||null;layer.prevSibling=layerPrev;layer.nextSibling=layerNext;if(layerPrev){layer.fx.input=layerPrev.fx.node}}if(layers.length){this._outputNode.inputs["texture"].node=layers[layers.length-1].fx.node;layers[0].fx.input=this._inputNode}else{this._outputNode.inputs.texture.node=this._inputNode}var width=this.image.width*this.scale;var height=this.image.height*this.scale;if(this._imageChanged){this.renderer.resize(width,height)}this.compositor.nodes=[];for(var i=0;i<layers.length;i++){this.compositor.add(layers[i].fx.node);if(this._imageChanged){layers[i].fx.setImageSize(width,height)}}this._inputNode.outputs.color.parameters={width:width,height:height};this.compositor.add(this._inputNode);this.compositor.add(this._outputNode);this.compositor.render(this.renderer)};return Processor});define("shaders/histogram.essl",[],function(){return"//Red channel\n@export emage.histogram_r.vertex\n\nattribute vec4 position;\n\nvarying lowp vec3 colorFactor;\n\nvoid main()\n{\n    colorFactor = vec3(1.0, 0.0, 0.0);\n    gl_Position = vec4(-1.0 + position.x * 0.0078125, 0.0, 0.0, 1.0);\n    gl_PointSize = 1.0;\n}\n\n@end\n\n//Grenn channel\n@export emage.histogram_g.vertex\n\nattribute vec4 position : POSITION;\n\nvarying lowp vec3 colorFactor;\n\nvoid main()\n{\n    colorFactor = vec3(0.0, 1.0, 0.0);\n    gl_Position = vec4(-1.0 + position.y * 0.0078125, 0.0, 0.0, 1.0);\n    gl_PointSize = 1.0;\n}\n\n@end\n\n//Blue channel\n@export emage.histogram_b.vertex\n\nattribute vec4 position : POSITION;\n\nvarying lowp vec3 colorFactor;\n\nvoid main()\n{\n    colorFactor = vec3(0.0, 0.0, 1.0);\n    gl_Position = vec4(-1.0 + position.z * 0.0078125, 0.0, 0.0, 1.0);\n    gl_PointSize = 1.0;\n}\n\n@end\n\n//Luminance channel\n@export emage.histogram_l.vertex\n\nattribute vec4 position : POSITION;\n\nvarying lowp vec3 colorFactor;\nconst highp vec3 W = vec3(0.2125, 0.7154, 0.0721);\n\nvoid main()\n{\n    colorFactor = vec3(1.0, 1.0, 1.0);\n    gl_Position = vec4(-1.0 + dot(position.xyz, W) * 0.0078125, 0.0, 0.0, 1.0);\n    gl_PointSize = 1.0;\n}\n\n@end\n\n@export emage.histogram.fragment\n\nconst lowp float scalingFactor = 1.0 / 256.0;\n\nvarying lowp vec3 colorFactor;\n\nvoid main()\n{\n    gl_FragColor = vec4(colorFactor * scalingFactor, 1.0);\n}\n\n@end\n\n"});define("src/histogram",["require","qtek","shaders/histogram.essl"],function(require){var qtek=require("qtek");var qtek3d=qtek["3d"];var Shader=qtek3d.Shader;var texParams={height:1,width:256,minFilter:"NEAREST",magFilter:"NEAREST",generateMipmaps:false};var canvas=document.createElement("canvas");var ctx=canvas.getContext("2d");Shader.import(require("shaders/histogram.essl"));var Histogram=function(image){this.downSample=1/8;this.image=image;this.canvas=document.createElement("canvas");this.renderer=new qtek3d.Renderer({canvas:this.canvas,preserveDrawingBuffer:true});this.channels={red:new Uint8Array(256),green:new Uint8Array(256),blue:new Uint8Array(256),luminance:new Uint8Array(256)};this._pixels={red:new Uint8Array(256*4),green:new Uint8Array(256*4),blue:new Uint8Array(256*4),luminance:new Uint8Array(256*4)};var _gl=this.renderer.gl;_gl.enableVertexAttribArray(0);this._framBuffer=new qtek3d.FrameBuffer({depthBuffer:false});this._textureRed=new qtek3d.texture.Texture2D(texParams);this._textureBlue=new qtek3d.texture.Texture2D(texParams);this._textureGreen=new qtek3d.texture.Texture2D(texParams);this._textureLuminance=new qtek3d.texture.Texture2D(texParams);this._shaderRed=new qtek3d.Shader({vertex:Shader.source("emage.histogram_r.vertex"),fragment:Shader.source("emage.histogram.fragment")});this._shaderGreen=new qtek3d.Shader({vertex:Shader.source("emage.histogram_g.vertex"),fragment:Shader.source("emage.histogram.fragment")});this._shaderBlue=new qtek3d.Shader({vertex:Shader.source("emage.histogram_b.vertex"),fragment:Shader.source("emage.histogram.fragment")});this._shaderLuminance=new qtek3d.Shader({vertex:Shader.source("emage.histogram_l.vertex"),fragment:Shader.source("emage.histogram.fragment")});this._buffer=_gl.createBuffer();this._imageChanged=true};Histogram.prototype.update=function(){var _gl=this.renderer.gl;var image=this.image;canvas.width=image.width*this.downSample;canvas.height=image.height*this.downSample;ctx.drawImage(image,0,0,canvas.width,canvas.height);var imgData=ctx.getImageData(0,0,canvas.width,canvas.height);_gl.bindBuffer(_gl.ARRAY_BUFFER,this._buffer);_gl.bufferData(_gl.ARRAY_BUFFER,imgData.data,_gl.STATIC_DRAW);_gl.vertexAttribPointer(0,4,_gl.UNSIGNED_BYTE,false,0,0);_gl.clearColor(0,0,0,1);_gl.blendEquation(_gl.FUNC_ADD);_gl.blendFunc(_gl.ONE,_gl.ONE);_gl.enable(_gl.BLEND);_gl.disable(_gl.DEPTH_TEST);var width=imgData.width,height=imgData.height,size=width*height;_gl.clear(_gl.COLOR_BUFFER_BIT);this._shaderRed.bind(_gl);this._framBuffer.attach(_gl,this._textureRed);this._framBuffer.bind(this.renderer);_gl.drawArrays(_gl.POINT,0,size);_gl.readPixels(0,0,256,1,_gl.RGBA,_gl.UNSIGNED_BYTE,this._pixels.red);_gl.clear(_gl.COLOR_BUFFER_BIT);this._shaderGreen.bind(_gl);this._framBuffer.attach(_gl,this._textureGreen);this._framBuffer.bind(this.renderer);_gl.drawArrays(_gl.POINT,0,size);_gl.readPixels(0,0,256,1,_gl.RGBA,_gl.UNSIGNED_BYTE,this._pixels.green);_gl.clear(_gl.COLOR_BUFFER_BIT);this._shaderBlue.bind(_gl);this._framBuffer.attach(_gl,this._textureBlue);this._framBuffer.bind(this.renderer);_gl.drawArrays(_gl.POINT,0,size);_gl.readPixels(0,0,256,1,_gl.RGBA,_gl.UNSIGNED_BYTE,this._pixels.blue);_gl.clear(_gl.COLOR_BUFFER_BIT);this._shaderLuminance.bind(_gl);this._framBuffer.attach(_gl,this._textureLuminance);this._framBuffer.bind(this.renderer);_gl.drawArrays(_gl.POINT,0,size);_gl.readPixels(0,0,256,1,_gl.RGBA,_gl.UNSIGNED_BYTE,this._pixels.luminance);for(var i=0;i<256;i++){this.channels.red[i]=this._pixels.red[i*4];this.channels.green[i]=this._pixels.green[i*4+1];this.channels.blue[i]=this._pixels.blue[i*4+2];this.channels.luminance[i]=this._pixels.luminance[i*4]}_gl.disable(_gl.BLEND);_gl.enable(_gl.DEPTH_TEST);document.body.appendChild(this.canvas)};Histogram.prototype.draw=function(){};Histogram.prototype.get=function(){};return Histogram});define("src/emage",["require","./fx","./layer","./processor","./histogram","qtek"],function(require){var emage={FX:require("./fx"),Layer:require("./layer"),Processor:require("./processor"),Histogram:require("./histogram"),qtek:require("qtek")};return emage});var emage=require("src/emage");for(var name in emage){_exports[name]=emage[name]}});